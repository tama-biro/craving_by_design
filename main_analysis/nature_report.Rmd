---
title: "Full Report `r Sys.Date()`"
author: "Samuel Thelaus"
date: "`r Sys.Date()`"
output:
  pdf_document: default
  html_document:
    df_print: paged
  word_document: default
---

\newpage

# Initial data checks

One participant had fewer than 630 total trials (total of 455 trials remained in file) and was missing columns for the final 3 MCQ questions (4-6). However, this participant was still included in analysis.

\newpage

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, fig.pos = "H")
options(knitr.table.format = function() {
  if (knitr::is_latex_output())
    "latex" else "simple"
})
```

```{r import, echo=FALSE, results=FALSE, message=FALSE, warning=FALSE}
# Import libraries
suppressMessages({
  library(tidyverse)
  library(moments)
  library(EnvStats)
  library(blme)
  library(DescTools)
  library(knitr)
  library(MuMIn)
  library(performance)
  library(ggsignif)
})
suppressWarnings(library(kableExtra))

setwd('C:/Users/SamuelThelaus/Documents/GitHub/craving_by_design/main_analysis')

# SE function
se <- function (x) {
  se = sd(x, na.rm = TRUE)/sqrt(length(x))
  return(se)
}

# Shapiro to text
shapiro_to_text <- function (x) {
  if (x < .05) {
    return('non-normality')
  } else {
    return('normality')
  }
}

# T-test report
t_test_report <- function (t_test) {
  df <- round(t_test$parameter, 3)
  t <- round(t_test$statistic, 3)
  p <- round(t_test$p.value, 3)
  if (t_test$p.value < .001) {
    p <- 'p < .001'
  } else {
    p <- paste('p =', p)
  }
  out <- paste0('t(', df, ') = ', t, ', ', p)
  return(out)
}

# Wilcox report
wilcox_report <- function (wilcox) {
  v <- round(wilcox$statistic, 3)
  p <- round(wilcox$p.value, 3)
  if (wilcox$p.value < .001) {
    p <- 'p < .001'
  } else {
    p <- paste('p =', p)
  }
  out <- paste('V =', v, p)
  return(out)
}

lm_report <- function(mod) {
  s <- summary(mod)
  f <- s$fstatistic[1]
  df1 <- s$fstatistic[2]
  df2 <- s$fstatistic[3]
  p <- pf(f, df1, df2, lower.tail = FALSE)
  p <- round(p, 3)
  if (p < .001) {
    p <- 'p < .001'
  } else {
    p <- paste('p =', p)
  }
  f <- round(f, 3)
  r2 <- round(s$adj.r.squared, 3)
  
  f_test <- paste0('F', '(', df1, ', ', df2, ') = ', f, ', ', p, ', R^2 = ', r2)
  
  s_table <- s$coefficients %>%
    as.data.frame() %>%
    round(3)
  colnames(s_table) <- c('Beta', 'SE', 't', 'p')
  s_table <- s_table %>%
    mutate(p =
             ifelse(p < .001, '***',
                     ifelse(p < .01, '**',
                             ifelse(p < .05, '*', ''))))
  s_table <- s_table %>%
    mutate(m_1 = paste0(Beta, ' (', SE, ')', p)) %>%
    select(m_1) %>%
    rownames_to_column("Variable") %>%
    filter(!(Variable %in% c('age', 'gender2', 'gender3',
                           'major2', 'major3', 'major4')))
  out_list <- list(f_test = f_test, table = s_table)
  return(out_list)
}

glm_report <- function(mod) {
  s <- summary(mod)
  s_table <- s$coefficients %>%
    as.data.frame() %>%
    round(3)
  colnames(s_table) <- c('Beta', 'SE', 'z', 'p')
  s_table <- s_table %>%
    mutate(p =
             ifelse(p < .001, '***',
                     ifelse(p < .01, '**',
                             ifelse(p < .05, '*', ''))))
  s_table <- s_table %>%
    mutate(m_1 = paste0(Beta, ' (', SE, ')', p)) %>%
    select(m_1) %>%
    rownames_to_column("Variable") %>%
    filter(!(Variable %in% c('age', 'gender2', 'gender3',
                           'major2', 'major3', 'major4')))
  return(s_table)
}

# glmer report
glmer_report <- function (mod) {
  s <- summary(mod)$coefficients
  s <- as.data.frame(s)
  colnames(s) <- c('Beta', 'SE', 'z', 'p')
  s <- round(s, 3)
  s <- s %>%
    mutate(p =
             ifelse(p < .001, '***',
                     ifelse(p < .01, '**',
                             ifelse(p < .05, '*', ''))))
  colnames(s) <- c('Beta', 'SE', 'z', 'p')
  s <- s %>%
    mutate(m_1 = paste0(Beta, ' (', SE, ')', p)) %>%
    select(m_1) %>%
    rownames_to_column("Variable") %>%
    filter(!(Variable %in% c('age', 'gender2', 'gender3',
                           'major2', 'major3', 'major4')))
  return(s)
}

aov_chi_report <- function (mod) {
  chi <- round(mod$Chisq[2], 3)
  df <- mod$Df[2]
  p <- round(mod$`Pr(>Chisq)`[2], 3)
  if (p < .001) {
    p <- 'p < .001'
  } else {
    p <- paste('p =', p)
  }
  out <- paste0('Chi2(', df, ') = ', chi, ', ', p)
  return(out)
}
```

```{r feature eng, echo=FALSE, results=FALSE, message=FALSE, warning=FALSE}
filepath <- '../data/data_full.csv'
data <- read.csv(filepath)

theta_fun <- function() {
  return(1)
}

source("./feature_engineering.R", local = knit_global())

# Save engineered data
write.csv(data, file = '../data/data_reduced.csv', row.names = FALSE)
```

```{r load data, echo=FALSE, results=FALSE, message=FALSE, warning=FALSE}
set.seed(41)

filepath <- '../data/data_reduced.csv'
data <- read.csv(filepath)

n <- length(unique(data$id))

age_by_n <- data %>%
  group_by(id) %>%
  summarize(age = mean(age)) %>%
  ungroup %>%
  filter(age != 0)

gender_by_n <- data %>%
  group_by(id) %>%
  summarize(gender = mean(gender)) %>%
  ungroup

major_by_n <- data %>%
  group_by(id) %>%
  summarize(major = mean(major)) %>%
  ungroup

mean_age <- round(mean(age_by_n$age), 2)
min_age <- min(age_by_n$age)
max_age <- max(age_by_n$age)

n_gender_1 <- sum(gender_by_n$gender == 1)
n_gender_2 <- sum(gender_by_n$gender == 2)
n_gender_3 <- sum(gender_by_n$gender == 3)

n_major_1 <- sum(major_by_n$major == 1)
n_major_2 <- sum(major_by_n$major == 2)
n_major_3 <- sum(major_by_n$major == 3)
n_major_4 <- sum(major_by_n$major == 4)
```

```{r desc_tables, echo=FALSE, results=FALSE, message=FALSE, warning=FALSE}
# Accuracy in questions - table S1
summarize_mcq <- data %>%
  filter(MCQ_Q4 != 3) %>%
  group_by(id, craver_2) %>%
  summarize(MCQ1 = mean(MCQ_Q1),
            MCQ2 = mean(MCQ_Q2),
            MCQ3 = mean(MCQ_Q3),
            MCQ4 = mean(MCQ_Q4),
            MCQ5 = mean(MCQ_Q5),
            MCQ6 = mean(MCQ_Q6)) %>%
  ungroup()

mcq_optimal <- summarize_mcq %>%
  filter(craver_2 == 0) %>%
  select(starts_with('MCQ')) %>%
  apply(MARGIN = 2, FUN = mean) %>%
  mean() %>%
  round(2)
mcq_opt_out <- paste0(mcq_optimal*100, '%')

mcq_craver <- summarize_mcq %>%
  filter(craver_2 == 1) %>%
  select(starts_with('MCQ')) %>%
  apply(MARGIN = 2, FUN = mean) %>%
  mean() %>%
  round(2)
mcq_cra_out <- paste0(mcq_craver*100, '%')

mcq_total <- summarize_mcq %>%
  select(starts_with('MCQ')) %>%
  apply(MARGIN = 2, FUN = mean) %>%
  mean() %>%
  round(2)
mcq_tot_out <- paste0(mcq_total*100, '%')

post_game_quiz <- data %>%
  filter(craver_2 == 1) %>%
  group_by(id, treatment) %>%
  summarize(post_game = mean(post_game_quiz_correct)) %>%
  ungroup %>%
  filter(!is.na(post_game)) %>%
  select(post_game) %>%
  as.matrix() %>%
  mean() %>%
  round(2)
post_game_quiz_out <- paste0(post_game_quiz*100, '%')

total_opt <- paste0(mean(mcq_optimal, post_game_quiz)*100, '%')
total_cra <- paste0(mean(mcq_craver, post_game_quiz)*100, '%')
total_tot <- paste0(mean(mcq_total, post_game_quiz)*100, '%')

table_s1 <- data.frame(participant_type = c('Optimal', 'Cravers', 'Total'),
                       MCQ = c(mcq_opt_out, mcq_cra_out, mcq_tot_out),
                       post_game_quiz = c('-', post_game_quiz_out, post_game_quiz_out),
                       Total = c(total_opt, total_cra, total_tot))
colnames(table_s1) <- c('Participant type', 'MCQ', 'Post-game quiz', 'Total')

# pre game strategy - table S2
table_s2 <- data %>%
  group_by(id) %>%
  summarize(pre_game = mean(pre_game_strategy)) %>%
  ungroup() %>%
  count(pre_game) %>%
  select(n) %>%
  t %>%
  as.data.frame()
colnames(table_s2) <- c('No strategy', 'Not quite sure', 'Quite confident', 'Think it is right')

# Fraction of cravers in experiment - table S3
cravers_test <- data %>%
  filter(treatment == "test") %>%
  group_by(id) %>%
  slice_head(n = 1) %>%
  ungroup %>%
  summarize(bet_once_in_yellow = mean(craver),
            bet_twice_in_yellow = mean(craver_2)) %>%
  t
n_test <- data %>%
  filter(treatment == "test") %>%
  group_by(id) %>%
  select(id) %>%
  unique %>%
  ungroup %>%
  nrow
cravers_test_frac <- paste0(cravers_test*n_test, rep('/', 2), n_test, ' = ',
                            paste0(round(cravers_test, 2)*100, '%'))

cravers_control <- data %>%
  filter(treatment == "control") %>%
  group_by(id) %>%
  slice_head(n = 1) %>%
  ungroup %>%
  summarize(bet_once_in_yellow = mean(craver),
            bet_twice_in_yellow = mean(craver_2)) %>%
  t
n_control <- data %>%
  filter(treatment == "control") %>%
  group_by(id) %>%
  select(id) %>%
  unique %>%
  ungroup %>%
  nrow
cravers_ctrl_frac <- paste0(cravers_control*n_control, rep('/', 2), n_control, ' = ',
                            paste0(round(cravers_control, 2)*100, '%'))

cravers_total <- data %>%
  group_by(id) %>%
  slice_head(n = 1) %>%
  ungroup %>%
  summarize(bet_once_in_yellow = mean(craver),
            bet_twice_in_yellow = mean(craver_2)) %>%
  t
cravers_total_frac <- paste0(cravers_total*n, rep('/', 2), n, ' = ',
                             paste0(round(cravers_total, 2)*100, '%'))

table_s3 <- data.frame(craving_definition = c('Bet in yellow', 'At least twice in yellow'),
                       Test = cravers_test_frac,
                       Control = cravers_ctrl_frac,
                       Total = cravers_total_frac)
colnames(table_s3) <- c('Craving definition', 'Test', 'Control', 'Total')

# Betting rate in blue
betting_stats_blue <- data %>%
  filter(block_type == "S") %>%
  group_by(id) %>%
  summarize(betting_rate = mean(choice)) %>%
  ungroup %>%
  psych::describe()

betting_stats_blue_sub <- betting_stats_blue['betting_rate',
                                             c('n', 'mean', 'median', 'sd',
                                               'min', 'max', 'skew')] %>%
  round(3) %>%
  t
colnames(betting_stats_blue_sub) <- 'Blue'

# Betting rate in yellow
betting_stats_yellow <- data %>%
  filter(block_type == "C") %>%
  group_by(id) %>%
  summarize(betting_rate = mean(choice)) %>%
  ungroup %>%
  psych::describe()

betting_stats_yellow_sub <- betting_stats_yellow['betting_rate',
                                                 c('n', 'mean', 'median', 'sd',
                                                   'min', 'max', 'skew')] %>%
  round(3) %>%
  t
colnames(betting_stats_yellow_sub) <- 'Yellow'

table_s4 <- betting_stats_blue_sub %>%
  cbind(betting_stats_yellow_sub) %>%
  as.data.frame()
```

# Descriptive statistics

This section goes through the tests specified in the pre-registration report and specifies observed effect sizes in the sample so far.

There was a total of `r n` participants after excluding participants. The mean age of participants was `r mean_age` (range `r min_age`-`r max_age`) years old. The gender distribution was Female = `r n_gender_1`, Male = `r n_gender_2`, Other = `r n_gender_3`. The distribution of majors for participants was STEM = `r n_major_1`, Business = `r n_major_2`, Humanities = `r n_major_3`, Other = `r n_major_4`.

```{r table_s1_out, echo=FALSE}
kable(table_s1, align = 'c',
      caption = 'Participant understanding of basic aspects of the task. “MCQ”: The table reports the percentage of correct replies to the 6 MCQ questions. “Pre-/Post-task quiz”: MCQ about the probability of a winning bet in a yellow/blue background session. The question is asked twice: just before the beginning of the task (“Pre”), and immediately after the task is completed (“Post”). “Optimal”: Participants who play optimally, i.e., they pass in all trials of all yellow background sessions. “Cravers”: Participants who bet at least twice across yellow background sessions during the experimental task (this is the definition used in Test 4; see also Table S3).') %>%
  kable_styling(latex_options = "HOLD_position")
```

```{r table_s2_out, echo=FALSE}
kable(table_s2, align = 'c',
      caption = 'Participant report on whether they have a strategy of play just before they start performing the task.') %>%
  kable_styling(latex_options = "HOLD_position")
```

```{r table_s3_out, echo=FALSE}
kable(table_s3, align = 'c',
      caption = 'Fraction of cravers in the experiment. “At least twice in yellow”: percentage of participants who bet at least twice across yellow background sessions during the experimental task (this is the definition of “craver” used in Test 4). “Bet in yellow”: percentage of participants who bet once or more in the yellow background sessions during the experimental task (reported here for reference).') %>%
  kable_styling(latex_options = "HOLD_position")
```

```{r table_s4_out, echo=FALSE}
kable(table_s4, align = 'c',
      caption = 'Betting rate of all participants, in blue and yellow background sessions.') %>%
  kable_styling(latex_options = "HOLD_position")
```

# Test 1

```{r t-test 1, echo=FALSE, results=FALSE, message=FALSE, warning=FALSE}
#### Test 1 ####

# Paired one-tailed t-test, participant level
# Betting rate in low/high reward
data_1 <- data %>%
  mutate(reward_value = factor(reward_value, levels = c("Low", "High"),
                               labels = c("Low", "High"))) %>%
  filter(block_type == "C") %>%
  group_by(id, reward_value) %>%
  summarize(betting_rate = mean(choice)) %>%
  ungroup


# Check skew and normality assumption
skew_1_bf <- round(skewness(sqrt(data_1$betting_rate)), 3)
shap_1_bf <- shapiro.test(data_1$betting_rate)
shap_1_bf <- shapiro_to_text(shap_1_bf$p.value)


# Box-Cox transform
out <- boxcox(data_1$betting_rate + 1, lambda = seq(-25, 25, by = 0.25))
bc_1_lambda <- out$lambda[which.max(out$objective)]

data_1$betting_rate_bc <- boxcoxTransform(data_1$betting_rate + 1,
                                          lambda = bc_1_lambda)

skew_1_af <- round(skewness(sqrt(data_1$betting_rate_bc)), 3)
shap_1_af <- shapiro.test(data_1$betting_rate_bc)
shap_1_af <- shapiro_to_text(shap_1_af$p.value)


# Run test
t_test_1 <- t.test(betting_rate_bc ~ reward_value, data = data_1,
                   alternative = 'less', paired = TRUE)
t_test_1 <- t_test_report(t_test_1)

# Non-parametric
wilcox_1 <- wilcox.test(betting_rate ~ reward_value, data = data_1,
                        alternative = 'less', paired = TRUE)
wilcox_1 <- wilcox_report(wilcox_1)
```

Paired t-test to compare participant betting rate in the high-reward vs. low-reward sessions in the yellow background sessions, one-sided; H0: Betting rate is higher or equal in the low-reward sessions. We expect to be able to reject H0 at a 5% significance level (Prediction 1).

Participant-level test (N = `r n`).

Data was skewed at `r skew_1_bf` (ideal values within [-1, 1]) and a Shapiro-Wilks test showed `r shap_1_bf`. Data were Box-Cox transformed with lambda = `r bc_1_lambda`. This reduced skew to `r skew_1_af` (acceptable value), but SW test still showed `r shap_1_af`.

Paired t-test using Box-Cox transformed data showed higher betting rate in high reward sessions (`r t_test_1`). Non-parametric paired Wilcoxon test using non-transformed data showed qualitatively same results (`r wilcox_1`).

\newpage

# Test 2

```{r log_mod_2, echo=FALSE, results=FALSE, message=FALSE, warning=FALSE}
data_2 <- data %>%
  mutate(reward_value = factor(reward_value, levels = c("Low", "High"),
                               labels = c("Low", "High")),
         uncertainty = factor(aaron_mood, levels = c("Low", "High"),
                              labels = c("Low", "High")),
         treatment = factor(treatment, levels = c("control", "test"),
                            labels = c("Control", "Test")),
         color = factor(block_type, levels = c("S", "C"),
                        labels = c("Blue", "Yellow")),
         age = scale(age),
         gender = factor(gender),
         major = factor(major),
         reaction_time = scale(reaction_time),
         sequence_number = scale(sequence_number))

log_mod_2 <- bglmer(choice ~ reward_value + uncertainty +
                      treatment * color + previous_choice + age + gender +
                      major + sequence_number + (1 | id),
                    fixef.prior = t, data = data_2,
                    family = binomial(link = "logit"))

s_2 <- glmer_report(log_mod_2)

s_2_r <- c('R^2', round(r2_nakagawa(log_mod_2)$R2_conditional, 3))
s_2_n <- c('N', summary(log_mod_2)$devcomp$dims[1])

s_2 <- s_2 %>%
  rbind(s_2_r) %>%
  rbind(s_2_n)
```

Logistic mixed effects model predicting betting, with independent variables: potential reward value in the session, uncertainty level in the session, a dummy for treatment (reference: treatment C), a dummy for session colour (reference: blue), the interaction of treatment and session colour, and several control variables (which include the previous decision, to control for choice inertia/stickiness).

```{r log_mod_2_out, echo=FALSE}
kable(s_2, align = 'c', caption = 'Logistic mixed model predicting betting (0: skip, 1: bet) for all participants in all trials. Variables are reward value (0: low, 1: high), uncertainty (0: low, 1: high), treatment (0: control, 1: test), session color (0: blue, 1: yellow), previous choice (0: skip, 1: bet), and the interaction between session color and treatment. Controls not shown were age, gender, major, and sequence number.') %>%
  kableExtra::footnote(general = "*p < .05, **p < .01, ***p < .001") %>%
  kable_styling(latex_options = "HOLD_position")
```

\newpage

# Test 3

```{r log_mod_3, echo=FALSE, results=FALSE, message=FALSE, warning=FALSE}
data_3 <- data %>%
  mutate(reward_value = factor(reward_value, levels = c("Low", "High"),
                               labels = c("Low", "High")),
         uncertainty = factor(aaron_mood, levels = c("Low", "High"),
                              labels = c("Low", "High")),
         treatment = factor(treatment, levels = c("control", "test"),
                            labels = c("Control", "Test")),
         color = factor(block_type, levels = c("S", "C"),
                        labels = c("Blue", "Yellow")),
         age = scale(age),
         gender = factor(gender),
         major = factor(major),
         reaction_time = scale(reaction_time),
         sequence_number = scale(sequence_number),
         reward_exposure = scale(exposure_time))

log_mod_3 <- bglmer(choice ~ reward_value + uncertainty +
                      treatment * color + previous_choice + reward_exposure +
                      age + gender + major + sequence_number + (1 | id),
                    fixef.prior = t, data = data_3,
                    family = binomial(link = "logit"))

s_3 <- glmer_report(log_mod_3)

s_3_r <- c('Nakagawa R^2', round(r2_nakagawa(log_mod_3)$R2_conditional, 3))
s_3_n <- c('N', summary(log_mod_3)$devcomp$dims[1])

s_3 <- s_3 %>%
  rbind(s_3_r) %>%
  rbind(s_3_n)
```

Logistic mixed effects model predicting betting, with independent variables: potential reward value in the session, uncertainty level in the session, a dummy for treatment (reference: treatment C), a dummy for session colour (reference: blue), the previous decision, and reward exposure, which is the discounted sum of prior rewards as defined in our computational model (more below). The main variable of interest is the reward exposure variable. We expect it to be significantly positive (Prediction 2).

```{r log_mod_3_out, echo=FALSE}
kable(s_3, align = 'c', caption = 'Logistic mixed model predicting betting (0: skip, 1: bet) for all participants in all trials. Variables are reward value (0: low, 1: high), uncertainty (0: low, 1: high), treatment (0: control, 1: test), session color (0: blue, 1: yellow), previous choice (0: skip, 1: bet), reward exposure, and the interaction between session color and treatment. Controls not shown were age, gender, major, and sequence number.') %>%
  kableExtra::footnote(general = "*p < .05, **p < .01, ***p < .001") %>%
  kable_styling(latex_options = "HOLD_position")
```

\newpage

# Test 4

Linear regression using as dependent variable participant betting rate in yellow (proxy for craving). We will also run a logistic regression using as dependent variable participant type (0: non craver; 1: craver). A craver is defined as a participant who chooses to bet at least twice across the yellow background sessions during the task.†† The independent variables will include a dummy code for treatment (reference: treatment C) and several control variables which include participant accuracy at the post-yellow-sessions lotteries (to control for the aforementioned miswanting aspect of behaviour). Our main variable of interest is the treatment variable: we expect a significantly positive coefficient on that variable (Prediction 3).

```{r lin_log_4, echo=FALSE, results=FALSE, message=FALSE, warning=FALSE}
data_4 <- data %>%
  filter(block_type == "C") %>%
  group_by(id, treatment, age, gender, major, craver_2) %>%
  summarize(betting_rate = mean(choice)) %>%
  ungroup %>%
  mutate(treatment = factor(treatment, levels = c("control", "test"),
                            labels = c("Control", "Test")),
         age = scale(age),
         gender = factor(gender),
         major = factor(major),
         craver = factor(craver_2, levels = 0:1,
                         labels = c('Non-craver', 'Craver')))

lin_mod_4 <- lm(betting_rate ~ treatment + age + gender + major,
                data = data_4)
s_4_lin <- lm_report(lin_mod_4)
f_s4_lin <- s_4_lin$f_test
s_4_lin_tab <- s_4_lin$table
s_4_r_lin <- c('R^2', round(summary(lin_mod_4)$adj.r.squared, 3))
s_4_n_lin <- c('N', summary(lin_mod_4)$df[1] + summary(lin_mod_4)$df[2])

s_4_lin_tab <- s_4_lin_tab %>%
  rbind(s_4_r_lin) %>%
  rbind(s_4_n_lin)

log_mod_4 <- glm(craver ~ treatment + age + gender + major,
                data = data_4, family = binomial(link = "logit"))
s_4_log <- glm_report(log_mod_4)

s_4_r_log <- c('Nakagawa R^2', round(PseudoR2(log_mod_4), 3))
s_4_n_log <- c('N', nrow(data_4))

s_4_log_tab <- s_4_log %>%
  rbind(s_4_r_log) %>%
  rbind(s_4_n_log)
```

Linear model showed following F-statistic: `r f_test``

```{r lin_mod_4_out, echo=FALSE}
kable(s_4_lin_tab, align = 'c', caption = 'Linear model predicting betting rates in yellow for all participants. Main variable is the treatment effect (0: control, 1: test). Controls not shown were age, gender, major, and sequence number.') %>%
  kableExtra::footnote(general = "*p < .05, **p < .01, ***p < .001") %>%
  kable_styling(latex_options = "HOLD_position")
```

```{r log_mod_4_out, echo=FALSE}
kable(s_4_log_tab, align = 'c', caption = 'Logistic model predicting whether a participant is a craver (bet at least twice in yellow). Main variable is the treatment effect (0: control, 1: test). Controls not shown were age, gender, major, and sequence number.') %>%
  kableExtra::footnote(general = "*p < .05, **p < .01, ***p < .001") %>%
  kable_styling(latex_options = "HOLD_position")
```

\newpage

# Test 5

Logistic mixed effects model predicting betting in a yellow background session; the independent variables include potential reward value in the session, uncertainty level in the session, a dummy for treatment (reference: treatment C), and the previous decision (to control for choice inertia/stickiness). The main variables of interest are:
- the reward variable; we expect a positive coefficient on that variable (Prediction 1).
- the treatment variable; we expect a positive coefficient on this variable (Prediction 3).
- the uncertainty variable; a positive coefficient would be consistent with Prediction 4.

```{r log_mod_5, echo=FALSE, results=FALSE, message=FALSE, warning=FALSE}
data_5 <- data %>%
  filter(block_type == "C" & craver_2 == 1) %>%
  mutate(reward_value = factor(reward_value, levels = c("Low", "High"),
                               labels = c("Low", "High")),
         uncertainty = factor(aaron_mood, levels = c("Low", "High"),
                              labels = c("Low", "High")),
         treatment = factor(treatment, levels = c("control", "test"),
                            labels = c("Control", "Test")),
         age = scale(age),
         gender = factor(gender),
         major = factor(major),
         reward_exposure = scale(exposure_time),
         reaction_time = scale(reaction_time),
         sequence_number = scale(sequence_number))

log_mod_5 <- bglmer(choice ~ reward_value + uncertainty + treatment +
                      age + gender + major + sequence_number +
                      previous_choice + (1 | id),
                    data = data_5, fixef.prior = t,
                    family = binomial(link = "logit"))

s_5 <- glmer_report(log_mod_5)

s_5_r <- c('Nakagawa R^2', round(r2_nakagawa(log_mod_5)$R2_conditional, 3))
s_5_n <- c('N', summary(log_mod_5)$devcomp$dims[1])

s_5 <- s_5 %>%
  rbind(s_5_r) %>%
  rbind(s_5_n)

data_5_vif <- data_5[,c('reward_value', 'uncertainty', 'treatment',
                        'age', 'gender', 'major', 'sequence_number',
                        'previous_choice')] %>%
  mutate(reward_value = as.numeric(reward_value),
         uncertainty = as.numeric(uncertainty),
         treatment = as.numeric(treatment),
         gender = as.numeric(gender),
         major = as.numeric(major))
usdm::vif(data_5_vif)
```

``` {r log_mod_5_out, echo=FALSE}
kable(s_5, align = 'c', caption = 'Logistic mixed effects model predicting betting in yellow background sessions for cravers (bet at least twice in yellow). Independent variables were reward value (0: low, 1: high), uncertainty (0: low, 1: high), treatment (0: control, 1: test), and previous choice (0: skip, 1: bet). Controls not shown were age, gender, major, and sequence number.') %>%
  kableExtra::footnote(general = "*p < .05, **p < .01, ***p < .001") %>%
  kable_styling(latex_options = "HOLD_position")
```

\newpage

# Test 6

Paired t-test to compare participant betting rate in the high-uncertainty vs. low uncertainty sessions in the yellow background sessions, one-sided; H0: Betting rate is higher or equal in the low-uncertainty sessions. We expect to be able to reject H0 at a significance level of 5% (Prediction 4).

```{r t_test_6, echo=FALSE, results=FALSE, message=FALSE, warning=FALSE}
#### Test 6 ####

# Paired one-tailed t-test, participant level
# Betting rate in low/high uncertainty
data_6 <- data %>%
  mutate(uncertainty = factor(aaron_mood, levels = c("Low", "High"),
                              labels = c("Low", "High"))) %>%
  filter(block_type == "C") %>%
  group_by(id, uncertainty) %>%
  summarize(betting_rate = mean(choice)) %>%
  ungroup

# Check skew and normality assumption
skew_6_bf <- round(skewness(sqrt(data_6$betting_rate)), 3)
shap_6_bf <- shapiro.test(data_6$betting_rate)
shap_6_bf <- shapiro_to_text(shap_6_bf$p.value)


# Box-Cox transform
out <- boxcox(data_6$betting_rate + 1, lambda = seq(-25, 25, by = 0.25))
bc_6_lambda <- out$lambda[which.max(out$objective)]

data_6$betting_rate_bc <- boxcoxTransform(data_6$betting_rate + 1,
                                          lambda = bc_6_lambda)

skew_6_af <- round(skewness(sqrt(data_6$betting_rate_bc)), 3)
shap_6_af <- shapiro.test(data_6$betting_rate_bc)
shap_6_af <- shapiro_to_text(shap_6_af$p.value)


# Run test
t_test_6 <- t.test(betting_rate_bc ~ uncertainty, data = data_6,
                   alternative = 'less', paired = TRUE)
t_test_6_out <- t_test_report(t_test_6)

# Non-parametric
wilcox_6 <- wilcox.test(betting_rate ~ uncertainty, data = data_6,
                        alternative = 'less', paired = TRUE)
wilcox_6 <- wilcox_report(wilcox_6)
```

Paired t-test to compare participant betting rate in the high-uncertainty vs. low-uncertainty sessions in the yellow background sessions, one-sided; H0: Betting rate is higher or equal in the low-uncertainty sessions. We expect to be able to reject H0 at a 5% significance level.

Participant-level test (N = `r n`).

Data was skewed at `r skew_6_bf` (ideal values within [-1, 1]) and a Shapiro-Wilks test showed `r shap_6_bf`. Data were Box-Cox transformed with lambda = `r bc_6_lambda`. This reduced skew to `r skew_6_af` (acceptable value), but SW test still showed `r shap_6_af`.

Paired t-test using Box-Cox transformed data showed higher betting rate in high uncertainty sessions (`r t_test_6_out`). Non-parametric paired Wilcoxon test using non-transformed data showed qualitatively same results (`r wilcox_6`).

```{r unc_plot_setup, echo=FALSE, results=FALSE, message=FALSE, warning=FALSE}
data_plot_u <- data %>%
  filter(block_type == "C") %>%
  group_by(aaron_mood, id) %>%
  summarize(betting_rate = mean(choice)) %>%
  ungroup

out <- boxcox(data_plot_u$betting_rate + 1, lambda = seq(-25, 25, by = 0.25))
bc_plot6_lambda <- out$lambda[which.max(out$objective)]

data_plot_u$betting_rate_bc <- boxcoxTransform(data_plot_u$betting_rate + 1,
                                               lambda = bc_plot6_lambda)

data_plot_u <- data_plot_u %>%
  group_by(aaron_mood) %>%
  summarize(se = se(betting_rate_bc),
            betting_rate_bc = mean(betting_rate_bc)) %>%
  ungroup %>%
  mutate(aaron_mood = factor(aaron_mood, levels = c('Low', 'High'),
                             labels = c('Low', 'High')))

# Test for uncertainty
p_unc <- t_test_6$p.value
p_unc <- if_else(p_unc < .001, '***',
                 if_else(p_unc < .01, '**',
                         if_else(p_unc < .05, '*', 'n.s.')))

cap_unc_all <- paste0('Average betting rate in yellow backround sessions for low and high uncertainty sessions for all participants ', '(', t_test_6_out, ').')
```

```{r unc_plot_out, echo=FALSE, results=FALSE, message=FALSE, warning=FALSE, fig.height=5, fig.width=8, fig.align='center', include=TRUE, fig.cap=cap_unc_all}
ggplot(data_plot_u, aes(x = aaron_mood, y = betting_rate_bc)) +
  geom_bar(stat='identity', position = position_dodge(.9), fill = '#ffd700',
           width = 0.6) +
  geom_errorbar(aes(ymin = betting_rate_bc - se, ymax = betting_rate_bc + se),
                position = position_dodge(.9), width = .1) +
  scale_x_discrete(name = '', breaks = c('Low', 'High')) +
  scale_y_continuous(name = 'Betting rate (Box-Cox corrected)') +
  theme_minimal() +
  theme(axis.title = element_text(size = 14),
        axis.text = element_text(size = 12),
        legend.title = element_text(size = 14),
        legend.text = element_text(size = 12),
        strip.text = element_text(size = 14)) +
  theme(panel.grid.major.x = element_blank(),
        panel.grid.minor = element_blank()) +
  geom_signif(comparisons = list(c('Low', 'High')),
              map_signif_level = TRUE,
              annotations = c(p_unc),
              margin_top = 0.2)
```

\newpage

# Test 7

```{r test_7, echo=FALSE, results=FALSE, message=FALSE, warning=FALSE}
# T-test in yellow and test
data_7_1 <- data %>%
  filter(treatment == "test" & block_type == "C") %>%
  group_by(id) %>%
  summarize(betting_rate = mean(choice)) %>%
  ungroup

n_7_1 <- nrow(data_7_1)

t_test_7_1 <- t.test(data_7_1$betting_rate, mu = 0, alternative = 'greater')
t_test_7_1_out <- t_test_report(t_test_7_1)

# T-test C vs T in yellow
data_7_2 <- data %>%
  filter(block_type == "C") %>%
  group_by(id, treatment) %>%
  summarize(betting_rate = mean(choice)) %>%
  ungroup

out <- boxcox(data_7_2$betting_rate + 1, lambda = seq(-25, 25, by = 0.25))
bc_72_lambda <- out$lambda[which.max(out$objective)]

data_7_2$betting_rate_bc <- boxcoxTransform(data_7_2$betting_rate + 1,
                                            lambda = bc_72_lambda)

t_test_7_2 <- t.test(betting_rate_bc ~ treatment, data = data_7_2)
t_test_7_2_out <- t_test_report(t_test_7_2)
```

T-test checking if betting rate in yellow session in the test treatment is different from 0. Participant-level test (N = `r n_7_1`). Additionally, shows comparison of betting rate in yellow between control and test treatment through two-sample t-test.

The t-test investigating whether betting rate in yellow in test was different from 0 was significant at, `r t_test_7_1_out`.

The t-test comparing betting in yellow between the control and test treatment was also significant, showing that betting rate was on average higher in test compared to control treatment (`r t_test_7_2_out`). This test was run on Box-Cox transformed data with lambda = `r bc_72_lambda`.

```{r treat_all_setup, echo=FALSE, results=FALSE, message=FALSE, warning=FALSE}
data_plot_t <- data_7_2 %>%
  group_by(treatment) %>%
  summarize(se = se(betting_rate_bc),
            betting_rate_bc = mean(betting_rate_bc)) %>%
  ungroup %>%
  mutate(treatment = factor(treatment, levels = c('control', 'test'),
                             labels = c('Control', 'Test')))

p_treat <- t_test_7_2$p.value
p_treat <- if_else(p_treat < .001, '***',
                   if_else(p_treat < .01, '**',
                           if_else(p_treat < .05, '*', 'n.s.')))

cap_treat_all <- paste0('Average betting rate in yellow sessions for control and test treatment ', '(', t_test_7_2_out, ').')
```

```{r treat_all_plot, echo=FALSE, results=FALSE, message=FALSE, warning=FALSE, fig.height=5, fig.width=8, fig.align='center', include=TRUE, fig.cap=cap_treat_all}
ggplot(data_plot_t, aes(x = treatment, y = betting_rate_bc)) +
  geom_bar(stat='identity', position = position_dodge(.9), fill = '#ffd700',
           width = 0.6) +
  geom_errorbar(aes(ymin = betting_rate_bc - se, ymax = betting_rate_bc + se),
                position = position_dodge(.9), width = .1) +
  scale_x_discrete(name = '', breaks = c('Control', 'Test')) +
  scale_y_continuous(name = 'Betting rate (Box-Cox corrected)') +
  theme_minimal() +
  theme(axis.title = element_text(size = 14),
        axis.text = element_text(size = 12),
        legend.title = element_text(size = 14),
        legend.text = element_text(size = 12),
        strip.text = element_text(size = 14)) +
  theme(panel.grid.major.x = element_blank(),
        panel.grid.minor = element_blank()) +
  geom_signif(comparisons = list(c('Control', 'Test')),
              map_signif_level = TRUE,
              annotations = c(p_treat),
              margin_top = 0.2)
```

# Figures

S2 from OSF but with color as well - only for pooled

S4 but theta 1.0



