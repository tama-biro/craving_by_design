---
title: "Full Report `r Sys.Date()`"
author: "Samuel Thelaus"
date: "`r Sys.Date()`"
output:
  pdf_document: default
  html_document:
    df_print: paged
  word_document: default
---

\newpage

# Initial data checks

One participant had fewer than 630 total trials (total of 455 trials remained in file) and was missing columns for the final 3 MCQ questions (4-6). However, this participant was still included in analysis.

Four participants were excluded for not passing the requirement for MCQ questions, post-game quiz or questions after betting in yellow (I want to remember the odds guess questions are). Seven excluded participants were in control treatment and four in the test treatment.

\newpage

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, fig.pos = "H")
options(knitr.table.format = function() {
  if (knitr::is_latex_output())
    "latex" else "pipe"
})
```

```{r import, echo=FALSE, results=FALSE, message=FALSE, warning=FALSE}
# Import libraries
suppressMessages({
  library(tidyverse)
  library(moments)
  library(EnvStats)
  library(blme)
  library(BayesianFirstAid)
  library(knitr)
  library(MuMIn)
  library(performance)
  library(ggsignif)
})
suppressWarnings(library(kableExtra))

setwd('C:/Users/samue/Documents/GitHub/craving_by_design/main_analysis')

# SE function
se <- function (x) {
  se = sd(x, na.rm = TRUE)/sqrt(length(x))
  return(se)
}

# Shapiro to text
shapiro_to_text <- function (x) {
  if (x < .05) {
    return('non-normality')
  } else {
    return('normality')
  }
}

# T-test report
t_test_report <- function (t_test) {
  df <- round(t_test$parameter, 3)
  t <- round(t_test$statistic, 3)
  p <- round(t_test$p.value, 3)
  if (t_test$p.value < .001) {
    p <- 'p < .001'
  } else {
    p <- paste('p =', p)
  }
  out <- paste0('t(', df, ') = ', t, ', ', p)
  return(out)
}

# Wilcox report
wilcox_report <- function (wilcox) {
  v <- round(wilcox$statistic, 3)
  p <- round(wilcox$p.value, 3)
  if (wilcox$p.value < .001) {
    p <- 'p < .001'
  } else {
    p <- paste('p =', p)
  }
  out <- paste('V =', v, p)
  return(out)
}

# glmer report
glmer_report <- function (mod) {
  s <- summary(mod)$coefficients
  s <- as.data.frame(s)
  colnames(s) <- c('Beta', 'SE', 'z', 'p')
  s <- round(s, 3)
  s <- s %>%
    mutate(p =
             ifelse(p < .001, '***',
                     ifelse(p < .01, '**',
                             ifelse(p < .05, '*', ''))))
  colnames(s) <- c('Beta', 'SE', 'z', 'p')
  s <- s %>%
    mutate(m_1 = paste0(Beta, ' (', SE, ')', p)) %>%
    select(m_1) %>%
    rownames_to_column("Variable") %>%
    filter(!(Variable %in% c('age', 'gender2', 'gender3',
                           'major2', 'major3', 'major4')))
  return(s)
}

aov_chi_report <- function (mod) {
  chi <- round(mod$Chisq[2], 3)
  df <- mod$Df[2]
  p <- round(mod$`Pr(>Chisq)`[2], 3)
  if (p < .001) {
    p <- 'p < .001'
  } else {
    p <- paste('p =', p)
  }
  out <- paste0('Chi2(', df, ') = ', chi, ', ', p)
  return(out)
}
```

```{r feature eng, echo=FALSE, results=FALSE, message=FALSE, warning=FALSE}
filepath <- '../data/data_full.csv'
data <- read.csv(filepath)

theta_fun <- function() {
  return(1)
}

source("./feature_engineering.R", local = knit_global())

# Save engineered data
write.csv(data, file = '../data/data_reduced.csv', row.names = FALSE)
```

```{r load data, echo=FALSE, results=FALSE, message=FALSE, warning=FALSE}
set.seed(41)

filepath <- '../data/data_reduced.csv'
data <- read.csv(filepath)

n <- length(unique(data$id))

age_by_n <- data %>%
  group_by(id) %>%
  summarize(age = mean(age)) %>%
  ungroup %>%
  filter(age != 0)

gender_by_n <- data %>%
  group_by(id) %>%
  summarize(gender = mean(gender)) %>%
  ungroup

major_by_n <- data %>%
  group_by(id) %>%
  summarize(major = mean(major)) %>%
  ungroup

mean_age <- round(mean(age_by_n$age), 2)
min_age <- min(age_by_n$age)
max_age <- max(age_by_n$age)

n_gender_1 <- sum(gender_by_n$gender == 1)
n_gender_2 <- sum(gender_by_n$gender == 2)
n_gender_3 <- sum(gender_by_n$gender == 3)

n_major_1 <- sum(major_by_n$major == 1)
n_major_2 <- sum(major_by_n$major == 2)
n_major_3 <- sum(major_by_n$major == 3)
n_major_4 <- sum(major_by_n$major == 4)
```

# Main analysis

This section goes through the tests specified in the pre-registration report and specifies observed effect sizes in the sample so far.

There was a total of `r n` participants after excluding participants. The mean age of participants was `r mean_age` (range `r min_age`-`r max_age`) years old. The gender distribution was Female = `r n_gender_1`, Male = `r n_gender_2`, Other = `r n_gender_3`. The distribution of majors for participants was STEM = `r n_major_1`, Business = `r n_major_2`, Humanities = `r n_major_3`, Other = `r n_major_4`.

```{r t-test 1, echo=FALSE, results=FALSE, message=FALSE, warning=FALSE}
#### Test 1 ####

# Paired one-tailed t-test, participant level
# Betting rate in low/high reward
data_1 <- data %>%
  mutate(reward_value = factor(reward_value, levels = c("Low", "High"),
                               labels = c("Low", "High"))) %>%
  filter(block_type == "C") %>%
  group_by(id, reward_value) %>%
  summarize(betting_rate = mean(choice)) %>%
  ungroup


# Check skew and normality assumption
skew_1_bf <- round(skewness(sqrt(data_1$betting_rate)), 3)
shap_1_bf <- shapiro.test(data_1$betting_rate)
shap_1_bf <- shapiro_to_text(shap_1_bf$p.value)


# Box-Cox transform
out <- boxcox(data_1$betting_rate + 1, lambda = seq(-25, 25, by = 0.25))
bc_1_lambda <- out$lambda[which.max(out$objective)]

data_1$betting_rate_bc <- boxcoxTransform(data_1$betting_rate + 1,
                                          lambda = bc_1_lambda)

skew_1_af <- round(skewness(sqrt(data_1$betting_rate_bc)), 3)
shap_1_af <- shapiro.test(data_1$betting_rate_bc)
shap_1_af <- shapiro_to_text(shap_1_af$p.value)


# Run test
t_test_1 <- t.test(betting_rate_bc ~ reward_value, data = data_1,
                   alternative = 'less', paired = TRUE)
t_test_1 <- t_test_report(t_test_1)

# Non-parametric
wilcox_1 <- wilcox.test(betting_rate ~ reward_value, data = data_1,
                        alternative = 'less', paired = TRUE)
wilcox_1 <- wilcox_report(wilcox_1)
```

## Test 1

Paired one-tailed t-test checking if betting rate is equal or lower in high reward value trials. Participant-level test (N = `r n`).

Data was skewed at `r skew_1_bf` (ideal values within [-1, 1]) and a Shapiro-Wilks test showed `r shap_1_bf`. Data were Box-Cox transformed with lambda = `r bc_1_lambda`. This reduced skew to `r skew_1_af` (acceptable value), but SW test still showed `r shap_1_af`.

Paired t-test using Box-Cox transformed data showed higher betting rate in high reward sessions (`r t_test_1`). Non-parametric paired Wilcoxon test using non-transformed data showed qualitatively same results (`r wilcox_1`).

## Test 2 & test 3

Logistic mixed-effects model predicting betting in all trials. Using penalized log-likelihood to correct for imbalanced groups. The same model is also presented with the previous choice variable to control for choice inertia. The models are compared on R^2 to tell which set of variables best explain variance in betting. Models are presented in table 1. The forward stepwise process to build the model is shown in the appendix for these models and test 5.

```{r log_mod_2, echo=FALSE, results=FALSE, message=FALSE, warning=FALSE}
data_2 <- data %>%
  mutate(reward_value = factor(reward_value, levels = c("Low", "High"),
                               labels = c("Low", "High")),
         uncertainty = factor(aaron_mood, levels = c("Low", "High"),
                              labels = c("Low", "High")),
         treatment = factor(treatment, levels = c("control", "test"),
                            labels = c("Control", "Test")),
         color = factor(block_type, levels = c("C", "S"),
                        labels = c("Yellow", "Blue")),
         age = scale(age),
         gender = factor(gender),
         major = factor(major),
         reaction_time = scale(reaction_time),
         sequence_number = scale(sequence_number))

log_mod_2 <- bglmer(choice ~ reward_value + uncertainty +
                      treatment * color + age + gender + major +
                      reaction_time + sequence_number + (1 | id),
                    fixef.prior = t, data = data_2,
                    family = binomial(link = "logit"))

s_2 <- glmer_report(log_mod_2)
```

```{r log_mod_3, echo=FALSE, results=FALSE, message=FALSE, warning=FALSE}
log_mod_3 <- bglmer(choice ~ reward_value + uncertainty +
                      treatment * color + age + gender + major +
                      reaction_time + sequence_number + 
                      previous_choice + (1 | id),
                    fixef.prior = t, data = data_2,
                    family = binomial(link = "logit"))

s_3 <- glmer_report(log_mod_3)

colnames(s_2) <- c(' ', '(1)')
colnames(s_3) <- c(' ', '(2)')

aov_3 <- anova(log_mod_2, log_mod_3)
aov_3 <- aov_chi_report(aov_3)
s_23_r <- c('R^2',
            round(r2_nakagawa(log_mod_2)$R2_conditional, 3),
            round(r2_nakagawa(log_mod_3)$R2_conditional, 3))
s_23_n <- c('N',
            summary(log_mod_2)$devcomp$dims[1],
            summary(log_mod_3)$devcomp$dims[1])

s_23 <- s_2 %>%
  right_join(s_3) %>%
  replace_na(list(' ' = '-',
                  '(1)' = '-',
                  '(2)' = '-')) %>%
  rbind(rep('-', 3)) %>%
  rbind(s_23_r) %>%
  rbind(s_23_n)
```

```{r log_mod_23_out, echo=FALSE}
kable(s_23, format = "latex", align = 'c',
      caption = 'Model 1 vs. model 2, with and without the previous choice variable. Both models also included controls for age, gender and major.') %>%
  kableExtra::footnote(general = "*p < .05, **p < .01, ***p < .001") %>%
  kable_styling(latex_options = "HOLD_position")
```

Comparing the models, the difference between them was statistically significant (`r aov_3`) suggesting the model with previous choice is the better model.

## Test 4

## Test 5

Logistic mixed-effects model predicting betting among cravers in the yellow background sessions. Two models are shown (table 2). The first model uses all available data. The second model uses data only from the first and second yellow session in an order of yellow sessions for the control treatment. The models can not be compared with a chi-squared test as they are not using the same data.

```{r log_mod_5, echo=FALSE, results=FALSE, message=FALSE, warning=FALSE}
data_5 <- data %>%
  filter(block_type == "C" & craver_2 == 1) %>%
  mutate(reward_value = factor(reward_value, levels = c("Low", "High"),
                               labels = c("Low", "High")),
         uncertainty = factor(aaron_mood, levels = c("Low", "High"),
                              labels = c("Low", "High")),
         treatment = factor(treatment, levels = c("control", "test"),
                            labels = c("Control", "Test")),
         age = scale(age),
         gender = factor(gender),
         major = factor(major),
         reward_history = scale(exposure_time),
         reaction_time = scale(reaction_time),
         sequence_number = scale(sequence_number))

log_mod_5 <- bglmer(choice ~ reward_value + uncertainty * treatment +
                      age + gender + major + reaction_time +
                      sequence_number + reward_history + (1 | id),
                    data = data_5, fixef.prior = t,
                    family = binomial(link = "logit"))

s_5 <- glmer_report(log_mod_5)
```

```{r log_12_5, echo=FALSE, results=FALSE, message=FALSE, warning=FALSE}
# Set order of yellow blocks (first/second included)
data$yellow_order_ctrl <- 0
for(id in unique(data$id[data$treatment == 'control'])) {
  for(seq in unique(data$sequence_number[data$id == id])) {
    indicator <- data$blue_interspersed[
      data$sequence_number == seq & data$id == id
    ][1]

    if(indicator == 2) {
      data$yellow_order_ctrl[
        data$sequence_number == seq &
          data$id == id &
          data$block_type == 'C' &
          data$block_number == 5
      ] <- 1
    } else if(indicator == 4) {
      data$yellow_order_ctrl[
        data$sequence_number == seq &
          data$id == id &
          data$block_type == 'C' &
          data$block_number == 3
      ] <- 1
    }
    
  }
}

data_5_2 <- data %>%
  filter(block_type == "C" & craver_2 == 1 & yellow_order_ctrl == 0) %>%
  mutate(reward_value = factor(reward_value, levels = c("Low", "High"),
                               labels = c("Low", "High")),
         uncertainty = factor(aaron_mood, levels = c("Low", "High"),
                              labels = c("Low", "High")),
         treatment = factor(treatment, levels = c("control", "test"),
                            labels = c("Control", "Test")),
         age = scale(age),
         gender = factor(gender),
         major = factor(major),
         reward_history = scale(exposure_time),
         reaction_time = scale(reaction_time),
         sequence_number = scale(sequence_number))

log_mod_12_5 <- bglmer(choice ~ reward_value + uncertainty * treatment +
                       age + gender + major + reaction_time +
                      sequence_number + reward_history + (1 | id),
                    data = data_5_2, fixef.prior = t,
                    family = binomial(link = "logit"))

s_12_5 <- glmer_report(log_mod_12_5)
```

```{r log_mod_5_combine, echo=FALSE, results=FALSE, message=FALSE, warning=FALSE}
colnames(s_5) <- c(' ', '(1)')
colnames(s_12_5) <- c(' ', '(2)')
s_5_r <- c('R^2',
           round(r2_nakagawa(log_mod_5)$R2_conditional, 3),
           round(r2_nakagawa(log_mod_12_5)$R2_conditional, 3))
s_5_n <- c('N',
           summary(log_mod_5)$devcomp$dims[1],
           summary(log_mod_12_5)$devcomp$dims[1])

s_5_out <- s_5 %>%
  left_join(s_12_5) %>%
  rbind(s_5_r) %>%
  rbind(s_5_n)
```

```{r log_mod_5_out, echo=FALSE}
kable(s_5_out, format = "latex", align = 'c',
      caption = 'Three versions of test 5 on different subsets of data. Model 1 uses all available data. Model 2 uses only the first and second yellow session in an order in control. Both models also included controls for age, gender and major.') %>%
  kableExtra::footnote(general = "*p < .05, **p < .01, ***p < .001") %>%
  kable_styling(latex_options = "HOLD_position")
```

```{r bayes_6, echo=FALSE, results=FALSE, message=FALSE, warning=FALSE}
#### Test 6 ####

# Bayesian t-test, participant level
# H1: Betting rate in yellow, test is > 0
# H0: Betting rate in yellow, test is 0
data_6 <- data %>%
  filter(block_type == "C" & treatment == "test") %>%
  group_by(id) %>%
  summarize(betting_rate = mean(choice)) %>%
  ungroup

n_6 <- nrow(data_6)

# Check skew and normality assumption
skew_6_bf <- round(skewness(sqrt(data_6$betting_rate)), 3)
shap_6_bf <- shapiro.test(data_6$betting_rate)
shap_6_bf <- shapiro_to_text(shap_6_bf$p.value)


# Box-Cox transform
out <- boxcox(data_6$betting_rate + 1, lambda = seq(-25, 25, by = 0.25))
bc_6_lambda <- out$lambda[which.max(out$objective)]

data_6$betting_rate_bc <- boxcoxTransform(data_6$betting_rate + 1,
                                          lambda = bc_6_lambda)

skew_6_af <- round(skewness(sqrt(data_6$betting_rate_bc)), 3)
shap_6_af <- shapiro.test(data_6$betting_rate_bc)
shap_6_af <- shapiro_to_text(shap_6_af$p.value)

# Run test
bayes_t6 <- bayes.t.test(x = data_6$betting_rate_bc, mu = 0)
prob_6 <- round(bayes_t6$stats[1,7]*100, 1)
bf_6 <- round(bayes_t6$stats[1,7]/(1-bayes_t6$stats[1,7]), 3)
```

## Test 6

Bayesian t-test checking if betting rate in yellow session in the test treatment is different from 0. Participant-level test (N = `r n_6`).

Data was positively skewed at `r skew_6_bf` (ideal values within [-1, 1]) and a Shapiro-Wilks test showed `r shap_6_bf`. Data were Box-Cox transformed with lambda = `r bc_6_lambda`. This reduced skew to `r skew_6_af` (acceptable value), but SW test still showed `r shap_6_af`.

Bayesian t-test on Box-Cox transformed betting rate showed a Bayes Factor of `r bf_6`, with a probability of `r prob_6`% that the mean was more than 0.

```{r t-test 7, echo=FALSE, results=FALSE, message=FALSE, warning=FALSE}
#### Test 7 ####

# Paired one-tailed t-test, participant level
# Betting rate in low/high reward
data_7 <- data %>%
  mutate(uncertainty = factor(aaron_mood, levels = c("Low", "High"),
                               labels = c("Low", "High"))) %>%
  filter(block_type == "C") %>%
  group_by(id, uncertainty) %>%
  summarize(betting_rate = mean(choice)) %>%
  ungroup


# Check skew and normality assumption
skew_7_bf <- round(skewness(sqrt(data_7$betting_rate)), 3)
shap_7_bf <- shapiro.test(data_7$betting_rate)
shap_7_bf <- shapiro_to_text(shap_7_bf$p.value)


# Box-Cox transform
out <- boxcox(data_7$betting_rate + 1, lambda = seq(-25, 25, by = 0.25))
bc_7_lambda <- out$lambda[which.max(out$objective)]

data_7$betting_rate_bc <- boxcoxTransform(data_7$betting_rate + 1,
                                          lambda = bc_7_lambda)

skew_7_af <- round(skewness(sqrt(data_7$betting_rate_bc)), 3)
shap_7_af <- shapiro.test(data_7$betting_rate_bc)
shap_7_af <- shapiro_to_text(shap_7_af$p.value)


# Run test
t_test_7 <- t.test(betting_rate_bc ~ uncertainty, data = data_7,
                   alternative = 'less', paired = TRUE)
t_test_7 <- t_test_report(t_test_7)

# Non-parametric
wilcox_7 <- wilcox.test(betting_rate ~ uncertainty, data = data_7,
                        alternative = 'less', paired = TRUE)
wilcox_7 <- wilcox_report(wilcox_7)
```

## Test 7

Paired one-tailed t-test checking if betting rate is equal or lower in high uncertainty trials. Participant-level test.

Data was positively skewed at `r skew_7_af` (ideal values within [-1, 1]) and a Shapiro-Wilks test showed `r shap_7_bf`. Data were Box-Cox transformed with lambda = `r bc_7_lambda`. This reduced skew to `r skew_7_af` (acceptable value), but SW test still showed `r shap_7_af`.

Paired t-test using Box-Cox transformed data showed higher betting rate in high uncertainty sessions (`r t_test_7`). Non-parametric paired Wilcoxon test on non-transformed data showed qualitatively same results (`r wilcox_7`).

\newpage

# Plots

```{r unc_all_setup, echo=FALSE, results=FALSE, message=FALSE, warning=FALSE}
data_plot_u <- data %>%
  group_by(aaron_mood, id) %>%
  summarize(betting_rate = mean(choice)) %>%
  ungroup %>%
  group_by(aaron_mood) %>%
  summarize(se = se(betting_rate),
            betting_rate = mean(betting_rate)) %>%
  ungroup %>%
  mutate(aaron_mood = factor(aaron_mood, levels = c('Low', 'High'),
                             labels = c('Low', 'High')))

# Test for uncertainty
data_t_unc <- data %>%
  group_by(id, aaron_mood) %>%
  summarize(betting_rate = mean(choice)) %>%
  ungroup

t_unc <- t.test(betting_rate ~ aaron_mood, data = data_t_unc,
                alternative = 'greater', paired = TRUE)
t_unc_rep <- t_test_report(t_unc)
p_unc <- t_unc$p.value
p_unc <- if_else(p_unc < .001, '***',
                 if_else(p_unc < .01, '**',
                         if_else(p_unc < .05, '*', 'n.s.')))

cap_unc_all <- paste0('Average betting rate in low and high uncertainty sessions for all participants ', '(', t_unc_rep, ').')
```

```{r unc_all_plot, echo=FALSE, results=FALSE, message=FALSE, warning=FALSE, fig.height=5, fig.width=8, fig.align='center', include=TRUE, fig.cap=cap_unc_all}
ggplot(data_plot_u, aes(x = aaron_mood, y = betting_rate)) +
  geom_bar(stat='identity', position = position_dodge(.9), fill = '#b4d9b2',
           width = 0.6) +
  geom_errorbar(aes(ymin = betting_rate - se, ymax = betting_rate + se),
                position = position_dodge(.9), width = .1) +
  scale_x_discrete(name = '', breaks = c('Low', 'High')) +
  scale_y_continuous(name = 'Betting rate') +
  theme_minimal() +
  theme(axis.title = element_text(size = 14),
        axis.text = element_text(size = 12),
        legend.title = element_text(size = 14),
        legend.text = element_text(size = 12),
        strip.text = element_text(size = 14)) +
  theme(panel.grid.major.x = element_blank(),
        panel.grid.minor = element_blank()) +
  geom_signif(comparisons = list(c('Low', 'High')),
              map_signif_level = TRUE,
              annotations = c(p_unc),
              margin_top = 1)
```

```{r unc_yellow_cravers_setup, echo=FALSE, results=FALSE, message=FALSE, warning=FALSE}
data_plot_u <- data %>%
  filter(block_type == 'C' & craver_2 == 1) %>%
  group_by(aaron_mood, id) %>%
  summarize(betting_rate = mean(choice)) %>%
  ungroup %>%
  group_by(aaron_mood) %>%
  summarize(se = se(betting_rate),
            betting_rate = mean(betting_rate)) %>%
  ungroup %>%
  mutate(aaron_mood = factor(aaron_mood, levels = c('Low', 'High'),
                             labels = c('Low', 'High')))

# Test for uncertainty
data_t_unc <- data %>%
  filter(block_type == 'C' & craver_2 == 1) %>%
  group_by(id, aaron_mood) %>%
  summarize(betting_rate = mean(choice)) %>%
  ungroup

t_unc_yc <- t.test(betting_rate ~ aaron_mood, data = data_t_unc,
                   alternative = 'greater', paired = TRUE)
t_unc_rep_yc <- t_test_report(t_unc_yc)
p_unc_yc <- t_unc_yc$p.value
p_unc_yc <- if_else(p_unc_yc < .001, '***',
                    if_else(p_unc_yc < .01, '**',
                            if_else(p_unc_yc < .05, '*', 'n.s.')))

cap_unc_yc <- paste0('Average betting rate in low and high uncertainty yellow sessions for cravers ', '(', t_unc_rep_yc, ').')
```

```{r unc_yellow_cravers_plot, echo=FALSE, results=FALSE, message=FALSE, warning=FALSE, fig.height=5, fig.width=8, fig.align='center', include=TRUE, fig.cap=cap_unc_yc}
ggplot(data_plot_u, aes(x = aaron_mood, y = betting_rate)) +
  geom_bar(stat='identity', position = position_dodge(.9), fill = '#b4d9b2',
           width = 0.6) +
  geom_errorbar(aes(ymin = betting_rate - se, ymax = betting_rate + se),
                position = position_dodge(.9), width = .1) +
  scale_x_discrete(name = '', breaks = c('Low', 'High')) +
  scale_y_continuous(name = 'Betting rate') +
  theme_minimal() +
  theme(axis.title = element_text(size = 14),
        axis.text = element_text(size = 12),
        legend.title = element_text(size = 14),
        legend.text = element_text(size = 12),
        strip.text = element_text(size = 14)) +
  theme(panel.grid.major.x = element_blank(),
        panel.grid.minor = element_blank()) +
  geom_signif(comparisons = list(c('Low', 'High')),
              map_signif_level = TRUE,
              annotations = c(p_unc),
              margin_top = 0.2)
```

```{r treat_all_setup, echo=FALSE, results=FALSE, message=FALSE, warning=FALSE}
data_plot_t <- data %>%
  filter(block_type == 'C') %>%
  group_by(treatment, id) %>%
  summarize(betting_rate = mean(choice)) %>%
  ungroup %>%
  group_by(treatment) %>%
  summarize(se = se(betting_rate),
            betting_rate = mean(betting_rate)) %>%
  ungroup %>%
  mutate(treatment = factor(treatment, levels = c('control', 'test'),
                             labels = c('Control', 'Test')))

# Test for uncertainty
data_t_treat <- data %>%
  filter(block_type == 'C') %>%
  group_by(id, treatment) %>%
  summarize(betting_rate = mean(choice)) %>%
  ungroup

t_treat <- t.test(betting_rate ~ treatment, data = data_t_treat,
                  alternative = 'less')
t_treat_rep <- t_test_report(t_treat)
p_treat <- t_treat$p.value
p_treat <- if_else(p_treat < .001, '***',
                   if_else(p_treat < .01, '**',
                           if_else(p_treat < .05, '*', 'n.s.')))

cap_treat_all <- paste0('Average betting rate in yellow sessions for control and test treatment ', '(', t_treat_rep, ').')
```

```{r treat_all_plot, echo=FALSE, results=FALSE, message=FALSE, warning=FALSE, fig.height=5, fig.width=8, fig.align='center', include=TRUE, fig.cap=cap_treat_all}
ggplot(data_plot_t, aes(x = treatment, y = betting_rate)) +
  geom_bar(stat='identity', position = position_dodge(.9), fill = '#ffd700',
           width = 0.6) +
  geom_errorbar(aes(ymin = betting_rate - se, ymax = betting_rate + se),
                position = position_dodge(.9), width = .1) +
  scale_x_discrete(name = '', breaks = c('Control', 'Test')) +
  scale_y_continuous(name = 'Betting rate') +
  theme_minimal() +
  theme(axis.title = element_text(size = 14),
        axis.text = element_text(size = 12),
        legend.title = element_text(size = 14),
        legend.text = element_text(size = 12),
        strip.text = element_text(size = 14)) +
  theme(panel.grid.major.x = element_blank(),
        panel.grid.minor = element_blank()) +
  geom_signif(comparisons = list(c('Control', 'Test')),
              map_signif_level = TRUE,
              annotations = c(p_treat),
              margin_top = 0.2)
```

```{r treat_all_corrected_setup, echo=FALSE, results=FALSE, message=FALSE, warning=FALSE}
data_plot_t <- data %>%
  filter(block_type == 'C' & yellow_order_ctrl == 0) %>%
  group_by(treatment, id) %>%
  summarize(betting_rate = mean(choice)) %>%
  ungroup %>%
  group_by(treatment) %>%
  summarize(se = se(betting_rate),
            betting_rate = mean(betting_rate)) %>%
  ungroup %>%
  mutate(treatment = factor(treatment, levels = c('control', 'test'),
                             labels = c('Control', 'Test')))

# Test for uncertainty
data_t_treat <- data %>%
  filter(block_type == 'C' & yellow_order_ctrl == 0) %>%
  group_by(id, treatment) %>%
  summarize(betting_rate = mean(choice)) %>%
  ungroup

t_treat_c <- t.test(betting_rate ~ treatment, data = data_t_treat,
                    alternative = 'less')
t_treat_rep_c <- t_test_report(t_treat_c)
p_treat_c <- t_treat_c$p.value
p_treat_c <- if_else(p_treat_c < .001, '***',
                     if_else(p_treat_c < .01, '**',
                             if_else(p_treat_c < .05, '*', 'n.s.')))

cap_treat_c <- paste0('Average betting rate in yellow sessions for control and test treatment ', '(', t_treat_rep_c, '). Data is corrected to only include yellow sessions that are first or second in a sequence.')
```

```{r treat_all_corrected_plot, echo=FALSE, results=FALSE, message=FALSE, warning=FALSE, fig.height=5, fig.width=8, fig.align='center', include=TRUE, fig.cap=cap_treat_c}
ggplot(data_plot_t, aes(x = treatment, y = betting_rate)) +
  geom_bar(stat='identity', position = position_dodge(.9), fill = '#ffd700',
           width = 0.6) +
  geom_errorbar(aes(ymin = betting_rate - se, ymax = betting_rate + se),
                position = position_dodge(.9), width = .1) +
  scale_x_discrete(name = '', breaks = c('Control', 'Test')) +
  scale_y_continuous(name = 'Betting rate') +
  theme_minimal() +
  theme(axis.title = element_text(size = 14),
        axis.text = element_text(size = 12),
        legend.title = element_text(size = 14),
        legend.text = element_text(size = 12),
        strip.text = element_text(size = 14)) +
  theme(panel.grid.major.x = element_blank(),
        panel.grid.minor = element_blank()) +
  geom_signif(comparisons = list(c('Control', 'Test')),
              map_signif_level = TRUE,
              annotations = c(p_treat_c),
              margin_top = 0.15)
```

```{r treat_yc_setup, echo=FALSE, results=FALSE, message=FALSE, warning=FALSE}
data_plot_t <- data %>%
  filter(block_type == 'C' & craver_2 == 1) %>%
  group_by(treatment, id) %>%
  summarize(betting_rate = mean(choice)) %>%
  ungroup %>%
  group_by(treatment) %>%
  summarize(se = se(betting_rate),
            betting_rate = mean(betting_rate)) %>%
  ungroup %>%
  mutate(treatment = factor(treatment, levels = c('control', 'test'),
                             labels = c('Control', 'Test')))

# Test for uncertainty
data_t_treat <- data %>%
  filter(block_type == 'C' & craver_2 == 1) %>%
  group_by(id, treatment) %>%
  summarize(betting_rate = mean(choice)) %>%
  ungroup

t_treat_yc <- t.test(betting_rate ~ treatment, data = data_t_treat,
                     alternative = 'less')
t_treat_rep_yc <- t_test_report(t_treat_yc)
p_treat_yc <- t_treat_yc$p.value
p_treat_yc <- if_else(p_treat_yc < .001, '***',
                      if_else(p_treat_yc < .01, '**',
                              if_else(p_treat_yc < .05, '*', 'n.s.')))

cap_treat_yc <- paste0('Average betting rate in yellow sessions for control and test treatment ', '(', t_treat_rep_yc, '). Data is restricted to only cravers.')
```

```{r treat_yc_plot, echo=FALSE, results=FALSE, message=FALSE, warning=FALSE, fig.height=5, fig.width=8, fig.align='center', include=TRUE, fig.cap=cap_treat_yc}
ggplot(data_plot_t, aes(x = treatment, y = betting_rate)) +
  geom_bar(stat='identity', position = position_dodge(.9), fill = '#ffd700',
           width = 0.6) +
  geom_errorbar(aes(ymin = betting_rate - se, ymax = betting_rate + se),
                position = position_dodge(.9), width = .1) +
  scale_x_discrete(name = '', breaks = c('Control', 'Test')) +
  scale_y_continuous(name = 'Betting rate') +
  theme_minimal() +
  theme(axis.title = element_text(size = 14),
        axis.text = element_text(size = 12),
        legend.title = element_text(size = 14),
        legend.text = element_text(size = 12),
        strip.text = element_text(size = 14)) +
  theme(panel.grid.major.x = element_blank(),
        panel.grid.minor = element_blank()) +
  geom_signif(comparisons = list(c('Control', 'Test')),
              map_signif_level = TRUE,
              annotations = c(p_treat_yc),
              margin_top = 0.15)
```

```{r treat_yc_corrected_setup, echo=FALSE, results=FALSE, message=FALSE, warning=FALSE}
data_plot_t <- data %>%
  filter(block_type == 'C' & craver_2 == 1 & yellow_order_ctrl == 0) %>%
  group_by(treatment, id) %>%
  summarize(betting_rate = mean(choice)) %>%
  ungroup %>%
  group_by(treatment) %>%
  summarize(se = se(betting_rate),
            betting_rate = mean(betting_rate)) %>%
  ungroup %>%
  mutate(treatment = factor(treatment, levels = c('control', 'test'),
                             labels = c('Control', 'Test')))

# Test for uncertainty
data_t_treat <- data %>%
  filter(block_type == 'C' & craver_2 == 1 & yellow_order_ctrl == 0) %>%
  group_by(id, treatment) %>%
  summarize(betting_rate = mean(choice)) %>%
  ungroup

t_treat_ycc <- t.test(betting_rate ~ treatment, data = data_t_treat,
                      alternative = 'less')
t_treat_rep_ycc <- t_test_report(t_treat_ycc)
p_treat_ycc <- t_treat_ycc$p.value
p_treat_ycc <- if_else(p_treat_ycc < .001, '***',
                       if_else(p_treat_ycc < .01, '**',
                               if_else(p_treat_ycc < .05, '*', 'n.s.')))

cap_treat_ycc <- paste0('Average betting rate in yellow sessions for control and test treatment ', '(', t_treat_rep_ycc, '). Data is restricted to only cravers and is corrected to only include yellow sessions that occur first or second in a sequence.')
```

```{r treat_yc_corrected_plot, echo=FALSE, results=FALSE, message=FALSE, warning=FALSE, fig.height=5, fig.width=8, fig.align='center', include=TRUE, fig.cap=cap_treat_ycc}
ggplot(data_plot_t, aes(x = treatment, y = betting_rate)) +
  geom_bar(stat='identity', position = position_dodge(.9), fill = '#ffd700',
           width = 0.6) +
  geom_errorbar(aes(ymin = betting_rate - se, ymax = betting_rate + se),
                position = position_dodge(.9), width = .1) +
  scale_x_discrete(name = '', breaks = c('Control', 'Test')) +
  scale_y_continuous(name = 'Betting rate') +
  theme_minimal() +
  theme(axis.title = element_text(size = 14),
        axis.text = element_text(size = 12),
        legend.title = element_text(size = 14),
        legend.text = element_text(size = 12),
        strip.text = element_text(size = 14)) +
  theme(panel.grid.major.x = element_blank(),
        panel.grid.minor = element_blank()) +
  geom_signif(comparisons = list(c('Control', 'Test')),
              map_signif_level = TRUE,
              annotations = c(p_treat_ycc),
              margin_top = 0.15)
```

```{r rew_unc_data, echo=FALSE, results=FALSE, message=FALSE, warning=FALSE}
data_plot_r <- data %>%
  filter(craver_2 == 1) %>%
  group_by(block_type, reward_value, id) %>%
  summarize(betting_rate = mean(choice)) %>%
  ungroup %>%
  group_by(block_type, reward_value) %>%
  summarize(se = se(betting_rate),
            betting_rate = mean(betting_rate)) %>%
  ungroup %>%
  mutate(x_ax = reward_value) %>%
  select(-reward_value)

data_plot_u <- data %>%
  filter(craver_2 == 1) %>%
  group_by(block_type, aaron_mood, id) %>%
  summarize(betting_rate = mean(choice)) %>%
  ungroup %>%
  group_by(block_type, aaron_mood) %>%
  summarize(se = se(betting_rate),
            betting_rate = mean(betting_rate)) %>%
  ungroup %>%
  mutate(x_ax = aaron_mood) %>%
  select(-aaron_mood)

data_plot <- data_plot_r %>%
  rbind(data_plot_u) %>%
  mutate(type = rep(c('Reward', 'Uncertainty'),
                    times = c(nrow(data_plot_r),
                              nrow(data_plot_u))),
         type = factor(type,
                       levels = c('Reward', 'Uncertainty'),
                       labels = c("(A) Reward", "(B) Uncertainty")),
         x_ax = factor(x_ax, levels = c("Low", "High"), labels = c("Low", "High")))
```

```{r rew_unc_plot, echo=FALSE, results=FALSE, message=FALSE, warning=FALSE, fig.height=5, fig.width=8, fig.align='center', include=TRUE, fig.cap='(A) Average betting rate in low and high reward sessions. (B) Average betting rate in low and high uncertainty sessions.'}
ggplot(data_plot, aes(x = x_ax, y = betting_rate, fill = block_type)) +
  geom_bar(stat='identity', position = position_dodge(.9)) +
  geom_errorbar(aes(ymin = betting_rate - se, ymax = betting_rate + se),
                position = position_dodge(.9), width = .2) +
  scale_x_discrete(name = '',
                   breaks = c('Low', 'High'),
                   labels = c('Low', 'High')) +
  scale_y_continuous(name = 'Betting rate') +
  scale_fill_manual(name = 'Session color',
                    breaks = c('C', 'S'),
                    labels = c('Yellow', 'Blue'),
                    values = c('#ffd700', '#0057b7')) +
  theme_minimal() +
  theme(axis.title = element_text(size = 14),
        axis.text = element_text(size = 12),
        legend.title = element_text(size = 14),
        legend.text = element_text(size = 12),
        strip.text = element_text(size = 14)) +
  facet_wrap("type", nrow = 1)
```

```{r treat_col_data, echo=FALSE, results=FALSE, message=FALSE, warning=FALSE}
data_plot1 <- data %>%
  filter(craver_2 == 1) %>%
  group_by(treatment, block_type, id) %>%
  summarize(betting_rate = mean(choice)) %>%
  ungroup %>%
  group_by(treatment, block_type) %>%
  summarize(se = se(betting_rate),
            betting_rate = mean(betting_rate)) %>%
  ungroup

data_plot2 <- data %>%
  group_by(treatment, block_type, id) %>%
  summarize(betting_rate = mean(choice)) %>%
  ungroup %>%
  group_by(treatment, block_type) %>%
  summarize(se = se(betting_rate),
            betting_rate = mean(betting_rate)) %>%
  ungroup

data_plot <- data_plot1 %>%
  rbind(data_plot2) %>%
  mutate(participant_group = rep(c('Cravers', 'Pooled'), each = 4),
         participant_group = factor(participant_group,
                                    levels = c("Pooled", "Cravers"),
                                    labels = c("(A) Pooled", "(B) Cravers")))
```

```{r treat_col_plot, echo=FALSE, results=FALSE, message=FALSE, warning=FALSE, fig.height=5, fig.width=8, fig.align='center', include=TRUE, fig.cap='Average betting rate by session color and treatment, for all participants pooled and cravers individually.'}
ggplot(data_plot, aes(x = treatment,
                      y = betting_rate,
                      fill = block_type)) +
  geom_bar(stat='identity', position = position_dodge(.9)) +
  geom_errorbar(aes(ymin = betting_rate - se, ymax = betting_rate + se),
                position = position_dodge(.9), width = .2) +
  scale_x_discrete(name = 'Treatment',
                   breaks = c('control', 'test'),
                   labels = c('Control', 'Test')) +
  scale_y_continuous(name = 'Betting rate') +
  scale_fill_manual(name = 'Session color',
                    breaks = c('C', 'S'),
                    labels = c('Yellow', 'Blue'),
                    values = c('#ffd700', '#0057b7')) +
  theme_minimal() +
  facet_wrap('participant_group', nrow = 1) +
  theme(axis.text = element_text(size = 12),
        axis.title = element_text(size = 14),
        strip.text = element_text(size = 14),
        legend.title = element_text(size = 14),
        legend.text = element_text(size = 12))
```

```{r dist_yellow_data, echo=FALSE, results=FALSE, message=FALSE, warning=FALSE}
data_dists1 <- data %>%
  filter(block_type == 'C') %>%
  group_by(id, treatment) %>%
  summarize(betting_rate = mean(choice, na.rm=TRUE)) %>%
  ungroup

data_dists2 <- data %>%
  filter(block_type == 'C' & craver_2 == 1) %>%
  group_by(id, treatment) %>%
  summarize(betting_rate = mean(choice, na.rm=TRUE)) %>%
  ungroup

data_dists <- data_dists1 %>%
  rbind(data_dists2) %>%
  mutate(participant_group = rep(c('Pooled', 'Cravers'),
                                 times = c(nrow(data_dists1),
                                           nrow(data_dists2))),
         participant_group = factor(participant_group,
                                    levels = c("Pooled", "Cravers"),
                                    labels = c("(A) Pooled", "(B) Cravers")))
```

```{r dist_yellow_plot, echo=FALSE, results=FALSE, message=FALSE, warning=FALSE, fig.height=5, fig.width=8, fig.align='center', include=TRUE, fig.cap='Distribution of betting rates by participant for all participants (A) and for the craver group (B) in yellow background sessions.'}
ggplot(data_dists, aes(x = treatment, y = betting_rate)) +
  geom_boxplot() +
  scale_x_discrete(breaks = c('control', 'test'),
                   labels = c('Control', 'Test'),
                   name = 'Treatment') +
  scale_y_continuous(breaks = seq(0, 1, 0.05),
                     name = 'Betting rate') +
  theme_minimal() +
  facet_wrap('participant_group', nrow = 1) +
  theme(axis.text = element_text(size = 12),
        axis.title = element_text(size = 14),
        strip.text = element_text(size = 14))
```

```{r dist_blue_data, echo=FALSE, results=FALSE, message=FALSE, warning=FALSE}
data_dists1 <- data %>%
  filter(block_type == 'S') %>%
  group_by(id, treatment) %>%
  summarize(betting_rate = mean(choice, na.rm=TRUE)) %>%
  ungroup

data_dists2 <- data %>%
  filter(block_type == 'S' & craver_2 == 1) %>%
  group_by(id, treatment) %>%
  summarize(betting_rate = mean(choice, na.rm=TRUE)) %>%
  ungroup

data_dists <- data_dists1 %>%
  rbind(data_dists2) %>%
  mutate(participant_group = rep(c('Pooled', 'Cravers'),
                                 times = c(nrow(data_dists1),
                                           nrow(data_dists2))),
         participant_group = factor(participant_group,
                                    levels = c("Pooled", "Cravers"),
                                    labels = c("(A) Pooled", "(B) Cravers")))
```

```{r dist_blue_plot, echo=FALSE, results=FALSE, message=FALSE, warning=FALSE, fig.height=5, fig.width=8, fig.align='center', include=TRUE, fig.cap='Distribution of betting rates by participant for all participants (A) and for the craver group (B) in blue background sessions.'}
ggplot(data_dists, aes(x = treatment, y = betting_rate)) +
  geom_boxplot() +
  scale_x_discrete(breaks = c('control', 'test'),
                   labels = c('Control', 'Test'),
                   name = 'Treatment') +
  scale_y_continuous(breaks = seq(0, 1, 0.05),
                     name = 'Betting rate') +
  theme_minimal() +
  facet_wrap('participant_group', nrow = 1) +
  theme(axis.text = element_text(size = 12),
        axis.title = element_text(size = 14),
        strip.text = element_text(size = 14))
```

```{r exp_data, echo=FALSE, results=FALSE, message=FALSE, warning=FALSE}
data_plot_y <- data %>%
  filter(block_type == 'C' & craver_2 == 1) %>%
  mutate(exp_bins = as.numeric(cut_interval(exposure_time, 3)),
         exp_num = cut_interval(exposure_time, 3)) %>%
  group_by(exp_bins, id) %>%
  summarize(betting_rate = mean(choice)) %>%
  ungroup %>%
  group_by(exp_bins) %>%
  summarize(se = se(betting_rate),
            betting_rate = mean(betting_rate, na.rm = TRUE)) %>%
  ungroup

data_plot_b <- data %>%
  filter(block_type == 'S' & craver_2 == 1) %>%
  mutate(exp_bins = as.numeric(cut_interval(exposure_time, 3)),
         exp_num = cut_interval(exposure_time, 3)) %>%
  group_by(exp_bins, id) %>%
  summarize(betting_rate = mean(choice)) %>%
  ungroup %>%
  filter(betting_rate > .6) %>%
  group_by(exp_bins) %>%
  summarize(se = se(betting_rate),
            betting_rate = mean(betting_rate, na.rm = TRUE)) %>%
  ungroup

data_plot <- data_plot_b %>%
  rbind(data_plot_y) %>%
  mutate(session_color = rep(c('Blue', 'Yellow'),
                             times = c(nrow(data_plot_b),
                                       nrow(data_plot_y))),
         session_color = factor(session_color,
                                levels = c('Blue', 'Yellow'),
                                labels = c("(A) Blue", "(B) Yellow")))
```

```{r exp_plot, echo=FALSE, results=FALSE, message=FALSE, warning=FALSE, fig.height=5, fig.width=8, fig.align='center', include=TRUE, fig.cap='Betting rate in the blue background sessions (A) and yellow background sessions (B) as a function of prior reward history (as defined in computational model) for all participants and sessions, with reward history split into 3 equally sized bins.'}
ggplot(data_plot, aes(x = exp_bins,
                      y = betting_rate,
                      col = session_color)) +
  geom_line() +
  geom_errorbar(aes(ymin = betting_rate - se,
                    ymax = betting_rate + se),
                width = 0.2) +
  labs(x = 'Previous reward history', y = 'Betting rate') +
  scale_x_continuous(breaks = 1:3) +
  scale_color_manual(name = 'Session color',
                     breaks = c('(A) Blue', '(B) Yellow'),
                     values = c('#0057b7', '#ffd700')) +
  theme_minimal() +
  theme(axis.title = element_text(size = 14),
        axis.text = element_text(size = 12),
        strip.text = element_text(size = 14),
        legend.position = 'none') +
  facet_wrap('session_color', scales = 'free_y')
```

\newpage

# Extra treatment/uncertainty checks

```{r ex_unc_data, echo=FALSE, results=FALSE, message=FALSE, warning=FALSE}
d1_plot <- data %>%
  filter(block_type == "C") %>%
  mutate(treatment = factor(treatment, levels = c("control", "test"),
                            labels = c("Control", "Test"))) %>%
  group_by(id, treatment) %>%
  summarize(betting_rate = mean(choice)) %>%
  ungroup %>%
  group_by(treatment) %>%
  summarize(mean = mean(betting_rate),
            se = se(betting_rate)) %>%
  ungroup
```

```{r ex_unc_plot, echo=FALSE, results=FALSE, message=FALSE, warning=FALSE, fig.height=5, fig.width=8, fig.align='center', include=TRUE, fig.cap='Average betting rate in yellow sessions for the control and test treatment.'}
ggplot(d1_plot, aes(x = treatment, y = mean)) +
  geom_bar(stat = "identity", fill = '#ffd700', width = 0.6) +
  geom_errorbar(aes(ymin = mean - se, ymax = mean + se),
                width = 0.1) +
  labs(x = 'Treatment', y = 'Mean betting rate') +
  theme_minimal() +
  theme(axis.title = element_text(size = 14),
        axis.text = element_text(size = 12),
        legend.position = 'none')
```

```{r ex_treat_data, echo=FALSE, results=FALSE, message=FALSE, warning=FALSE}
d2_plot <- data %>%
  filter(block_type == "C") %>%
  mutate(treatment = factor(treatment, levels = c("control", "test"),
                            labels = c("Control", "Test")),
         uncertainty = factor(aaron_mood, levels = c("Low", "High"),
                              labels = c("Low", "High"))) %>%
  group_by(id, treatment, uncertainty) %>%
  summarize(betting_rate = mean(choice)) %>%
  ungroup %>%
  group_by(treatment, uncertainty) %>%
  summarize(mean = mean(betting_rate),
            se = se(betting_rate)) %>%
  ungroup
```

```{r ex_treat_plot, echo=FALSE, results=FALSE, message=FALSE, warning=FALSE, fig.height=5, fig.width=8, fig.align='center', include=TRUE, fig.cap='Average betting rates in control/test treatment for low/high uncertainty. There seems to be an effect of uncertainty in the control treatment but not in test.'}
ggplot(d2_plot, aes(x = treatment, y = mean, fill = uncertainty)) +
  geom_bar(stat = "identity", width = 0.6,
           position = position_dodge(preserve = "single")) +
  geom_errorbar(aes(ymin = mean - se, ymax = mean + se),
                width = 0.1,
                position = position_dodge(width = 0.6, preserve = "single")) +
  labs(x = 'Treatment', y = 'Mean betting rate') +
  theme_minimal() +
  theme(axis.title = element_text(size = 14),
        axis.text = element_text(size = 12))
```

\newpage

# First 4 sessions of blue in test/control

We checked the difference in betting rates in the first 4 blue sessions in the test and control treatment separately. This is shown in a bar chart below as well as a t-test checking the difference in betting rates between test and control. Only the first “actual” blue sessions are used. Interspersed sessions and clocks before the experiment (to avoid boredom) were not used.

```{r blue_data, echo=FALSE, results=FALSE, message=FALSE, warning=FALSE}
# Betting in first 4 blue sessions test/ctrl
data_plot <- data %>%
  mutate(first_blue = if_else(treatment == 'control' &
                                block_type == 'S' &
                                block_number %in% 6:9, 1,
                              if_else(treatment == 'test' &
                                        block_type == 'S' &
                                        block_number %in% 1:4, 1, 0))) %>%
  filter(first_blue == 1) %>%
  group_by(id, treatment) %>%
  summarize(betting_rate = mean(choice)) %>%
  group_by(treatment) %>%
  summarize(mean = mean(betting_rate),
            se = se(betting_rate)) %>%
  ungroup
```

```{r blue_plot, echo=FALSE, results=FALSE, message=FALSE, warning=FALSE, fig.height=5, fig.width=8, fig.align='center', include=TRUE, fig.cap='Average betting rates in the first 4 blue sessions for the control and test treatment. Error bars show SEM.'}
ggplot(data_plot, aes(x = treatment, y = mean)) +
  geom_bar(stat = 'identity', fill = '#0057b7', width = 0.7) +
  geom_errorbar(aes(ymin = mean - se, ymax = mean + se),
                width = 0.2) +
  labs(x = 'Treatment', y = 'Mean betting rate') +
  theme_minimal() +
  theme(axis.text = element_text(size = 14),
        axis.title = element_text(size = 16))
```

```{r blue t-test, echo=FALSE, results=FALSE, message=FALSE, warning=FALSE}
data_ttest <- data %>%
  mutate(first_blue = if_else(treatment == 'control' &
                                block_type == 'S' &
                                block_number %in% 6:9, 1,
                              if_else(treatment == 'test' &
                                        block_type == 'S' &
                                        block_number %in% 1:4, 1, 0))) %>%
  filter(first_blue == 1) %>%
  group_by(id, treatment) %>%
  summarize(betting_rate = mean(choice)) %>%
  ungroup


blue_t_test <- t.test(betting_rate ~ treatment, data = data_ttest,
                      var.equal=TRUE)

blue_t_test <- t_test_report(blue_t_test)
```

A two-sample t-test comparing the difference in betting rates in the first 4 blue sessions found no difference in mean between the two treatments (Welch two-sample t-test, `r blue_t_test`).

\newpage

# Appendix

## Test 5 previous choice

In this section, we show the results of test 5 but when modeled with previous choice as well as the previous trial outcome variables.

```{r log_mod_5_pcsetup, echo=FALSE, results=FALSE, message=FALSE, warning=FALSE}
data_5 <- data %>%
  filter(block_type == "C" & craver_2 == 1) %>%
  mutate(reward_value = factor(reward_value, levels = c("Low", "High"),
                               labels = c("Low", "High")),
         uncertainty = factor(aaron_mood, levels = c("Low", "High"),
                              labels = c("Low", "High")),
         treatment = factor(treatment, levels = c("control", "test"),
                            labels = c("Control", "Test")),
         age = scale(age),
         gender = factor(gender),
         major = factor(major),
         reward_history = scale(exposure_time),
         reaction_time = scale(reaction_time),
         sequence_number = scale(sequence_number))
```

```{r log_12_5_pcsetup, echo=FALSE, results=FALSE, message=FALSE, warning=FALSE}
# Set order of yellow blocks (first/second included)
data$yellow_order_ctrl <- 0
for(id in unique(data$id[data$treatment == 'control'])) {
  for(seq in unique(data$sequence_number[data$id == id])) {
    indicator <- data$blue_interspersed[
      data$sequence_number == seq & data$id == id
    ][1]

    if(indicator == 2) {
      data$yellow_order_ctrl[
        data$sequence_number == seq &
          data$id == id &
          data$block_type == 'C' &
          data$block_number == 5
      ] <- 1
    } else if(indicator == 4) {
      data$yellow_order_ctrl[
        data$sequence_number == seq &
          data$id == id &
          data$block_type == 'C' &
          data$block_number == 3
      ] <- 1
    }
    
  }
}

data_5_2 <- data %>%
  filter(block_type == "C" & craver_2 == 1 & yellow_order_ctrl == 0) %>%
  mutate(reward_value = factor(reward_value, levels = c("Low", "High"),
                               labels = c("Low", "High")),
         uncertainty = factor(aaron_mood, levels = c("Low", "High"),
                              labels = c("Low", "High")),
         treatment = factor(treatment, levels = c("control", "test"),
                            labels = c("Control", "Test")),
         age = scale(age),
         gender = factor(gender),
         major = factor(major),
         reward_history = scale(exposure_time),
         reaction_time = scale(reaction_time),
         sequence_number = scale(sequence_number))
```

### Previous choice

```{r log_mod_5_prev_choice, echo=FALSE, results=FALSE, message=FALSE, warning=FALSE}
log_mod_5 <- bglmer(choice ~ reward_value + uncertainty * treatment +
                      age + gender + major + reaction_time +
                      sequence_number + previous_choice + (1 | id),
                    data = data_5, fixef.prior = t,
                    family = binomial(link = "logit"))

s_5 <- glmer_report(log_mod_5)

log_mod_12_5 <- bglmer(choice ~ reward_value + uncertainty * treatment +
                       age + gender + major + reaction_time +
                      sequence_number + previous_choice + (1 | id),
                    data = data_5_2, fixef.prior = t,
                    family = binomial(link = "logit"))

s_12_5 <- glmer_report(log_mod_12_5)
```

```{r log_mod_5_combine_prev_choice, echo=FALSE, results=FALSE, message=FALSE, warning=FALSE}
colnames(s_5) <- c(' ', '(1)')
colnames(s_12_5) <- c(' ', '(2)')
s_5_r <- c('R^2',
           round(r2_nakagawa(log_mod_5)$R2_conditional, 3),
           round(r2_nakagawa(log_mod_12_5)$R2_conditional, 3))
s_5_n <- c('N',
           summary(log_mod_5)$devcomp$dims[1],
           summary(log_mod_12_5)$devcomp$dims[1])

s_5_out <- s_5 %>%
  full_join(s_12_5) %>%
  rbind(s_5_r) %>%
  rbind(s_5_n)
```

```{r log_mod_5_out_prev_choice, echo=FALSE}
kable(s_5_out, format = "latex", align = 'c',
      caption = 'Two versions of test 5 on different subsets of data. Model 1 uses all available data. Model 2 uses only the first and second yellow session in an order in control. Both models have controls for age, gender and major.') %>%
  kableExtra::footnote(general = "*p < .05, **p < .01, ***p < .001") %>%
  kable_styling(latex_options = "HOLD_position")
```

### Previous trial outcome

```{r log_mod_5_prev_trial_out, echo=FALSE, results=FALSE, message=FALSE, warning=FALSE}
log_mod_5 <- bglmer(choice ~ reward_value + treatment +
                      age + gender + major + reaction_time +
                      sequence_number + previous_trial_outcome + (1 | id),
                    data = data_5, fixef.prior = t,
                    family = binomial(link = "logit"))

s_5 <- glmer_report(log_mod_5)

log_mod_12_5 <- bglmer(choice ~ reward_value + treatment +
                       age + gender + major + reaction_time +
                      sequence_number + previous_trial_outcome + (1 | id),
                    data = data_5_2, fixef.prior = t,
                    family = binomial(link = "logit"))

s_12_5 <- glmer_report(log_mod_12_5)
```

```{r log_mod_5_combine_prev_trial_out, echo=FALSE, results=FALSE, message=FALSE, warning=FALSE}
colnames(s_5) <- c(' ', '(1)')
colnames(s_12_5) <- c(' ', '(2)')
s_5_r <- c('R^2',
           round(r2_nakagawa(log_mod_5)$R2_conditional, 3),
           round(r2_nakagawa(log_mod_12_5)$R2_conditional, 3))
s_5_n <- c('N',
           summary(log_mod_5)$devcomp$dims[1],
           summary(log_mod_12_5)$devcomp$dims[1])

s_5_out <- s_5 %>%
  left_join(s_12_5) %>%
  rbind(s_5_r) %>%
  rbind(s_5_n)
```

```{r log_mod_5_out_prev_trial_out, echo=FALSE}
kable(s_5_out, format = "latex", align = 'c',
      caption = 'Two versions of test 5 on different subsets of data. Model 1 uses all available data. Model 2 uses only the first and second yellow session in an order in control. Both models have controls for age, gender and major.') %>%
  kableExtra::footnote(general = "*p < .05, **p < .01, ***p < .001") %>%
  kable_styling(latex_options = "HOLD_position")
```

## Test 5 but only low uncertainty

Test 5 (table 2) but with only low uncertainty sessions.

```{r log_mod_5_unc, echo=FALSE, results=FALSE, message=FALSE, warning=FALSE}
data_5 <- data %>%
  filter(block_type == "C" & craver_2 == 1) %>%
  mutate(reward_value = factor(reward_value, levels = c("Low", "High"),
                               labels = c("Low", "High")),
         uncertainty = factor(aaron_mood, levels = c("Low", "High"),
                              labels = c("Low", "High")),
         treatment = factor(treatment, levels = c("control", "test"),
                            labels = c("Control", "Test")),
         age = scale(age),
         gender = factor(gender),
         major = factor(major),
         reward_history = scale(exposure_time),
         reaction_time = scale(reaction_time),
         sequence_number = scale(sequence_number)) %>%
  filter(uncertainty == 'Low')

log_mod_5 <- bglmer(choice ~ reward_value + treatment +
                      age + gender + major + reaction_time +
                      sequence_number + reward_history + (1 | id),
                    data = data_5, fixef.prior = t,
                    family = binomial(link = "logit"))

s_5 <- glmer_report(log_mod_5)
```

```{r log_12_5_unc, echo=FALSE, results=FALSE, message=FALSE, warning=FALSE}
# Set order of yellow blocks (first/second included)
data$yellow_order_ctrl <- 0
for(id in unique(data$id[data$treatment == 'control'])) {
  for(seq in unique(data$sequence_number[data$id == id])) {
    indicator <- data$blue_interspersed[
      data$sequence_number == seq & data$id == id
    ][1]

    if(indicator == 2) {
      data$yellow_order_ctrl[
        data$sequence_number == seq &
          data$id == id &
          data$block_type == 'C' &
          data$block_number == 5
      ] <- 1
    } else if(indicator == 4) {
      data$yellow_order_ctrl[
        data$sequence_number == seq &
          data$id == id &
          data$block_type == 'C' &
          data$block_number == 3
      ] <- 1
    }
    
  }
}

data_5 <- data %>%
  filter(block_type == "C" & craver_2 == 1 & yellow_order_ctrl == 0) %>%
  mutate(reward_value = factor(reward_value, levels = c("Low", "High"),
                               labels = c("Low", "High")),
         uncertainty = factor(aaron_mood, levels = c("Low", "High"),
                              labels = c("Low", "High")),
         treatment = factor(treatment, levels = c("control", "test"),
                            labels = c("Control", "Test")),
         age = scale(age),
         gender = factor(gender),
         major = factor(major),
         reward_history = scale(exposure_time),
         reaction_time = scale(reaction_time),
         sequence_number = scale(sequence_number)) %>%
  filter(uncertainty == 'Low')

log_mod_12_5 <- bglmer(choice ~ reward_value + treatment +
                       age + gender + major + reaction_time +
                      sequence_number + reward_history + (1 | id),
                    data = data_5, fixef.prior = t,
                    family = binomial(link = "logit"))

s_12_5 <- glmer_report(log_mod_12_5)
```

```{r log_mod_5_combine_unc, echo=FALSE, results=FALSE, message=FALSE, warning=FALSE}
colnames(s_5) <- c(' ', '(1)')
colnames(s_12_5) <- c(' ', '(2)')
s_5_r <- c('R^2',
           round(r2_nakagawa(log_mod_5)$R2_conditional, 3),
           round(r2_nakagawa(log_mod_12_5)$R2_conditional, 3))
s_5_n <- c('N',
           summary(log_mod_5)$devcomp$dims[1],
           summary(log_mod_12_5)$devcomp$dims[1])

s_5_out <- s_5 %>%
  left_join(s_12_5) %>%
  rbind(s_5_r) %>%
  rbind(s_5_n)
```

```{r log_mod_5_out_unc, echo=FALSE}
kable(s_5_out, format = "latex", align = 'c',
      caption = 'Two versions of test 5 on different subsets of data. Model 1 uses all available data. Model 2 uses only the first and second yellow session in an order in control. Both models have controls for age, gender and major.') %>%
  kableExtra::footnote(general = "*p < .05, **p < .01, ***p < .001") %>%
  kable_styling(latex_options = "HOLD_position")
```

```{r fe_new, echo=FALSE, results=FALSE, message=FALSE, warning=FALSE}
filepath <- '../data/november_subset/data_full.csv'
data <- read.csv(filepath)

theta_fun <- function() {
  return(1)
}

source("./feature_engineering.R", local = knit_global())

# Save engineered data
write.csv(data, file = '../data/november_subset/data_reduced.csv', row.names = FALSE)
```

```{r load_new, echo=FALSE, results=FALSE, message=FALSE, warning=FALSE}
filepath <- '../data/november_subset/data_reduced.csv'
data <- read.csv(filepath)

n_new <- length(unique(data$id))
```

## Treatment effect in new sample only

We also test the treatment effect in yellow in the new sample when we exclude all pilot participants. This subsample has `r n_new` participants.

The treatment effect is examined by running test 5 and producing figure 2 for the new sample alone.

### Test 5

Logistic mixed-effects model predicting betting among cravers in the yellow background sessions. Two models are shown (table 5). The first model uses all available data. The second model uses data only from the first and second yellow session in an order of yellow sessions for the control treatment. The models can not be compared with a chi-squared test as they are not using the same data.

```{r log_mod_5_new, echo=FALSE, results=FALSE, message=FALSE, warning=FALSE}
data_5 <- data %>%
  filter(block_type == "C" & craver_2 == 1) %>%
  mutate(reward_value = factor(reward_value, levels = c("Low", "High"),
                               labels = c("Low", "High")),
         uncertainty = factor(aaron_mood, levels = c("Low", "High"),
                              labels = c("Low", "High")),
         treatment = factor(treatment, levels = c("control", "test"),
                            labels = c("Control", "Test")),
         age = scale(age),
         gender = factor(gender),
         major = factor(major),
         reward_history = scale(exposure_time),
         reaction_time = scale(reaction_time),
         sequence_number = scale(sequence_number))

log_mod_5 <- bglmer(choice ~ reward_value + uncertainty + treatment +
                      age + gender + major + reaction_time +
                      sequence_number + reward_history + (1 | id),
                    data = data_5, fixef.prior = t,
                    family = binomial(link = "logit"))

s_5 <- glmer_report(log_mod_5)
```

```{r log_12_5_new, echo=FALSE, results=FALSE, message=FALSE, warning=FALSE}
# Set order of yellow blocks (first/second included)
data$yellow_order_ctrl <- 0
for(id in unique(data$id[data$treatment == 'control'])) {
  for(seq in unique(data$sequence_number[data$id == id])) {
    indicator <- data$blue_interspersed[
      data$sequence_number == seq & data$id == id
    ][1]

    if(indicator == 2) {
      data$yellow_order_ctrl[
        data$sequence_number == seq &
          data$id == id &
          data$block_type == 'C' &
          data$block_number == 5
      ] <- 1
    } else if(indicator == 4) {
      data$yellow_order_ctrl[
        data$sequence_number == seq &
          data$id == id &
          data$block_type == 'C' &
          data$block_number == 3
      ] <- 1
    }
    
  }
}

data_5 <- data %>%
  filter(block_type == "C" & craver_2 == 1 & yellow_order_ctrl == 0) %>%
  mutate(reward_value = factor(reward_value, levels = c("Low", "High"),
                               labels = c("Low", "High")),
         uncertainty = factor(aaron_mood, levels = c("Low", "High"),
                              labels = c("Low", "High")),
         treatment = factor(treatment, levels = c("control", "test"),
                            labels = c("Control", "Test")),
         age = scale(age),
         gender = factor(gender),
         major = factor(major),
         reward_history = scale(exposure_time),
         reaction_time = scale(reaction_time),
         sequence_number = scale(sequence_number))

log_mod_12_5 <- bglmer(choice ~ reward_value + uncertainty + treatment +
                       age + gender + major + reaction_time +
                      sequence_number + reward_history + (1 | id),
                    data = data_5, fixef.prior = t,
                    family = binomial(link = "logit"))

s_12_5 <- glmer_report(log_mod_12_5)
```

```{r log_mod_5_combine_new, echo=FALSE, results=FALSE, message=FALSE, warning=FALSE}
colnames(s_5) <- c(' ', '(1)')
colnames(s_12_5) <- c(' ', '(2)')
s_5_r <- c('R^2',
           round(r2_nakagawa(log_mod_5)$R2_conditional, 3),
           round(r2_nakagawa(log_mod_12_5)$R2_conditional, 3))
s_5_n <- c('N',
           summary(log_mod_5)$devcomp$dims[1],
           summary(log_mod_12_5)$devcomp$dims[1])

s_5_out <- s_5 %>%
  left_join(s_12_5) %>%
  rbind(s_5_r) %>%
  rbind(s_5_n)
```

```{r log_mod_5_new_out, echo=FALSE}
kable(s_5_out, format = "latex", align = 'c',
      caption = 'Two versions of test 5 on different subsets of data. Model 1 uses all available data. Model 2 uses only the first and second yellow session in an order in control. Both models have controls for age, gender and major. This table shows results when the pilot is excluded.') %>%
  kableExtra::footnote(general = "*p < .05, **p < .01, ***p < .001") %>%
  kable_styling(latex_options = "HOLD_position")
```

```{r new_treat_col_data, echo=FALSE, results=FALSE, message=FALSE, warning=FALSE}
data_plot1 <- data %>%
  filter(craver_2 == 1) %>%
  group_by(treatment, block_type, id) %>%
  summarize(betting_rate = mean(choice)) %>%
  ungroup %>%
  group_by(treatment, block_type) %>%
  summarize(se = se(betting_rate),
            betting_rate = mean(betting_rate)) %>%
  ungroup

data_plot2 <- data %>%
  group_by(treatment, block_type, id) %>%
  summarize(betting_rate = mean(choice)) %>%
  ungroup %>%
  group_by(treatment, block_type) %>%
  summarize(se = se(betting_rate),
            betting_rate = mean(betting_rate)) %>%
  ungroup

data_plot <- data_plot1 %>%
  rbind(data_plot2) %>%
  mutate(participant_group = rep(c('Cravers', 'Pooled'), each = 4),
         participant_group = factor(participant_group,
                                    levels = c("Pooled", "Cravers"),
                                    labels = c("(A) Pooled", "(B) Cravers")))
```

```{r new_treat_col_plot, echo=FALSE, results=FALSE, message=FALSE, warning=FALSE, fig.height=5, fig.width=8, fig.align='center', include=TRUE, fig.cap='Bar chart showing betting rate in control and test treatment in yellow and blue background sessions. The panes represent data for all participants (A) and only cravers (B).'}
ggplot(data_plot, aes(x = treatment,
                      y = betting_rate,
                      fill = block_type)) +
  geom_bar(stat='identity', position = position_dodge(.9)) +
  geom_errorbar(aes(ymin = betting_rate - se, ymax = betting_rate + se),
                position = position_dodge(.9), width = .2) +
  scale_x_discrete(name = 'Treatment',
                   breaks = c('control', 'test'),
                   labels = c('Control', 'Test')) +
  scale_y_continuous(name = 'Betting rate') +
  scale_fill_manual(name = 'Session color',
                    breaks = c('C', 'S'),
                    labels = c('Yellow', 'Blue'),
                    values = c('#ffd700', '#0057b7')) +
  theme_minimal() +
  facet_wrap('participant_group', nrow = 1) +
  theme(axis.text = element_text(size = 12),
        axis.title = element_text(size = 14),
        strip.text = element_text(size = 14),
        legend.title = element_text(size = 14),
        legend.text = element_text(size = 12))
```

```{r load_data_after_new, echo=FALSE, results=FALSE, message=FALSE, warning=FALSE}
filepath <- '../data/data_reduced.csv'
data <- read.csv(filepath)
```

## Boredom in control in yellow

We wanted to check whether participants might bet in yellow in the control treatment out of boredom (skipping many times in a row could be boring as nothing happens). To do this, we fashioned a few extra variables and checked their importance in explaining differences in betting rates.

First, we produced two additional plots to check whether betting was different over the course of sessions in yellow in control. One variable compared the first session in a sequence of yellow to the second and third, and one variable compared the first and second session to the third in a sequence. The results are shown in the bar charts below.

```{r boredom_data_1, echo=FALSE, results=FALSE, message=FALSE, warning=FALSE}
# Set order of yellow blocks (first/second == 1 in sequence)
data$yellow_order_ctrl <- 0
for(id in unique(data$id[data$treatment == 'control'])) {
  for(seq in unique(data$sequence_number[data$id == id])) {
    indicator <- data$blue_interspersed[
      data$sequence_number == seq & data$id == id
        ][1]
    
    if(indicator == 2) {
      data$yellow_order_ctrl[
        data$sequence_number == seq &
          data$id == id &
          data$block_type == 'C' &
          data$block_number %in% c(1, 3, 4)
      ] <- 1
      data$yellow_order_ctrl[
        data$sequence_number == seq &
          data$id == id &
          data$block_type == 'C' &
          data$block_number == 5
      ] <- 2
    } else if(indicator == 3) {
      data$yellow_order_ctrl[
        data$sequence_number == seq &
          data$id == id &
          data$block_type == 'C' &
          data$block_number %in% c(1, 2, 4, 5)
      ] <- 1
    } else if(indicator == 4) {
      data$yellow_order_ctrl[
        data$sequence_number == seq &
          data$id == id &
          data$block_type == 'C' &
          data$block_number %in% c(1, 2, 5)
      ] <- 1
      data$yellow_order_ctrl[
        data$sequence_number == seq &
          data$id == id &
          data$block_type == 'C' &
          data$block_number == 3
      ] <- 2
    }

  }
}

data_plot <- data %>%
  filter(block_type == 'C' & craver_2 == 1) %>%
  group_by(id, treatment, yellow_order_ctrl) %>%
  summarize(betting_rate = mean(choice)) %>%
  group_by(treatment, yellow_order_ctrl) %>%
  summarize(mean = mean(betting_rate),
            se = se(betting_rate)) %>%
  ungroup %>%
  mutate(group = c("Control\n(first/second)", "Control\n(third)", "Test"))
```

```{r boredom_plot_1, echo=FALSE, results=FALSE, message=FALSE, warning=FALSE, fig.height=5, fig.width=8, fig.align='center', include=TRUE, fig.cap='Betting rate in the first/second or third sessions in a sequence of yellow sessions in the control treatment. Betting rate for the test treatment is shown individually.'}
ggplot(data_plot, aes(x = group, y = mean)) +
  geom_bar(stat = 'identity', fill = '#ffd700') +
  geom_errorbar(aes(ymin = mean - se, ymax = mean + se), width = 0.2) +
  theme_minimal() +
  labs(x = 'Group', y = 'Mean betting rate') +
  theme(axis.title = element_text(size = 16),
        axis.text = element_text(size = 14))
```

```{r boredom_data_2, echo=FALSE, results=FALSE, message=FALSE, warning=FALSE}
data$yellow_order_ctrl <- 0
for(id in unique(data$id[data$treatment == 'control'])) {
  for(seq in unique(data$sequence_number[data$id == id])) {
    indicator <- data$blue_interspersed[
      data$sequence_number == seq & data$id == id
    ][1]
    
    if(indicator == 2) {
      data$yellow_order_ctrl[
        data$sequence_number == seq &
          data$id == id &
          data$block_type == 'C' &
          data$block_number %in% c(1, 3)
      ] <- 1
      data$yellow_order_ctrl[
        data$sequence_number == seq &
          data$id == id &
          data$block_type == 'C' &
          data$block_number %in% c(4, 5)
      ] <- 2
    } else if(indicator == 3) {
      data$yellow_order_ctrl[
        data$sequence_number == seq &
          data$id == id &
          data$block_type == 'C' &
          data$block_number %in% c(1, 4)
      ] <- 1
      data$yellow_order_ctrl[
        data$sequence_number == seq &
          data$id == id &
          data$block_type == 'C' &
          data$block_number %in% c(2, 5)
      ] <- 2
    } else if(indicator == 4) {
      data$yellow_order_ctrl[
        data$sequence_number == seq &
          data$id == id &
          data$block_type == 'C' &
          data$block_number %in% c(1, 5)
      ] <- 1
      data$yellow_order_ctrl[
        data$sequence_number == seq &
          data$id == id &
          data$block_type == 'C' &
          data$block_number %in% c(2, 3)
      ] <- 2
    }
    
  }
}

data_plot <- data %>%
  filter(block_type == 'C' & craver_2 == 1) %>%
  group_by(id, treatment, yellow_order_ctrl) %>%
  summarize(betting_rate = mean(choice)) %>%
  group_by(treatment, yellow_order_ctrl) %>%
  summarize(mean = mean(betting_rate),
            se = se(betting_rate)) %>%
  ungroup %>%
  mutate(group = c("Control\n(first)", "Control\n(second/third)", "Test"))
```

```{r boredom_plot_2, echo=FALSE, results=FALSE, message=FALSE, warning=FALSE, fig.height=5, fig.width=8, fig.align='center', include=TRUE, fig.cap='Betting rate in the first or second/third session in a sequence of yellow sessions in the control treatment. Betting rate for the test treatment is shown individually.'}
ggplot(data_plot, aes(x = group, y = mean)) +
  geom_bar(stat = 'identity', fill = '#ffd700') +
  geom_errorbar(aes(ymin = mean - se, ymax = mean + se), width = 0.2) +
  theme_minimal() +
  labs(x = 'Group', y = 'Mean betting rate') +
  theme(axis.title = element_text(size = 16),
        axis.text = element_text(size = 14))
```

## Previous trial outcome

In order to check for the effect of previous trials, the effect of previous trial outcome was included and compared to the effect of the previous choice variable. Previous trial outcome takes the previous trial and codes it as 1 if the trial was played and the participant won, and 0 otherwise.

### Comparison of previous choice and previous trial outcome for model 2

```{r log_mod_3_choice_outcome, echo=FALSE, results=FALSE, message=FALSE, warning=FALSE}
data_3_trial <- data %>%
  mutate(reward_value = factor(reward_value, levels = c("Low", "High"),
                               labels = c("Low", "High")),
         uncertainty = factor(aaron_mood, levels = c("Low", "High"),
                              labels = c("Low", "High")),
         treatment = factor(treatment, levels = c("control", "test"),
                            labels = c("Control", "Test")),
         color = factor(block_type, levels = c("C", "S"),
                        labels = c("Yellow", "Blue")),
         age = scale(age),
         gender = factor(gender),
         major = factor(major),
         reaction_time = scale(reaction_time),
         sequence_number = scale(sequence_number))

log_mod_3_prev_choice <- bglmer(choice ~ reward_value + uncertainty +
                                  treatment * color + age + gender + major +
                                  reaction_time + sequence_number +
                                  previous_choice + (1 | id),
                                fixef.prior = t, data = data_3_trial,
                                family = binomial(link = "logit"))

s_3_prev_choice <- glmer_report(log_mod_3_prev_choice)
```

```{r log_mod_3_trial_outcome, echo=FALSE, results=FALSE, message=FALSE, warning=FALSE}
log_mod_3_prev_trial <- bglmer(choice ~ reward_value + uncertainty +
                                 treatment * color + age + gender + major +
                                 reaction_time + sequence_number +
                                 previous_trial_outcome + (1 | id),
                               fixef.prior = t, data = data_3_trial,
                               family = binomial(link = "logit"))

s_3_prev_trial <- glmer_report(log_mod_3_prev_trial)

colnames(s_3_prev_choice) <- c(' ', '(1)')
colnames(s_3_prev_trial) <- c(' ', '(2)')

s_3_pcr <- c('R^2',
             round(r2_nakagawa(log_mod_3_prev_choice)$R2_conditional, 3),
             round(r2_nakagawa(log_mod_3_prev_trial)$R2_conditional, 3))
s_3_pcn <- c('N',
             summary(log_mod_3_prev_choice)$devcomp$dims[1],
             summary(log_mod_3_prev_trial)$devcomp$dims[1])

s_trial_outcome <- s_3_prev_choice %>%
  full_join(s_3_prev_trial) %>%
  replace_na(list(' ' = '-',
                  '(1)' = '-',
                  '(2)' = '-')) %>%
  rbind(rep('-', 3)) %>%
  rbind(s_3_pcr) %>%
  rbind(s_3_pcn)
```

```{r log_mod_23_out_trial_outcome, echo=FALSE}
kable(s_trial_outcome, format = "latex", align = 'c',
      caption = 'Model 2 with previous choice (1) and previous trial outcome (2).') %>%
  kableExtra::footnote(general = "*p < .05, **p < .01, ***p < .001") %>%
  kable_styling(latex_options = "HOLD_position")
```

## Full models with previous choice and reward history/previous trial outcome

### Model 2

```{r log_mod_3_multi, echo=FALSE, results=FALSE, message=FALSE, warning=FALSE}
data_3_multi <- data %>%
  mutate(reward_value = factor(reward_value, levels = c("Low", "High"),
                               labels = c("Low", "High")),
         uncertainty = factor(aaron_mood, levels = c("Low", "High"),
                              labels = c("Low", "High")),
         treatment = factor(treatment, levels = c("control", "test"),
                            labels = c("Control", "Test")),
         color = factor(block_type, levels = c("C", "S"),
                        labels = c("Yellow", "Blue")),
         age = scale(age),
         gender = factor(gender),
         major = factor(major),
         reaction_time = scale(reaction_time),
         sequence_number = scale(sequence_number),
         reward_history = scale(exposure_time))

log_mod_3_reward <- bglmer(choice ~ reward_value + uncertainty +
                                  treatment * color + age + gender + major +
                                  reaction_time + sequence_number +
                                  previous_choice + reward_history + (1 | id),
                                fixef.prior = t, data = data_3_multi,
                                family = binomial(link = "logit"))

s_3_reward <- glmer_report(log_mod_3_reward)

log_mod_3_prev_trial <- bglmer(choice ~ reward_value + uncertainty +
                                 treatment * color + age + gender + major +
                                 reaction_time + sequence_number +
                                 previous_choice + previous_trial_outcome +
                                 (1 | id),
                               fixef.prior = t, data = data_3_multi,
                               family = binomial(link = "logit"))

s_3_prev_trial <- glmer_report(log_mod_3_prev_trial)
```

```{r log_mod_3_multi_combine, echo=FALSE, results=FALSE, message=FALSE, warning=FALSE}
colnames(s_3_reward) <- c(' ', '(1)')
colnames(s_3_prev_trial) <- c(' ', '(2)')

s_3_pcr <- c('R^2',
             round(r2_nakagawa(log_mod_3_reward)$R2_conditional, 3),
             round(r2_nakagawa(log_mod_3_prev_trial)$R2_conditional, 3))
s_3_pcn <- c('N',
             summary(log_mod_3_reward)$devcomp$dims[1],
             summary(log_mod_3_prev_trial)$devcomp$dims[1])

s_multi <- s_3_reward %>%
  full_join(s_3_prev_trial) %>%
  replace_na(list(' ' = '-',
                  '(1)' = '-',
                  '(2)' = '-')) %>%
  rbind(rep('-', 3)) %>%
  rbind(s_3_pcr) %>%
  rbind(s_3_pcn)
```

```{r log_mod_3_out_multi, echo=FALSE}
kable(s_multi, format = "latex", align = 'c',
      caption = 'Model 2 with previous choice and reward history (1) or previous trial outcome (2).') %>%
  kableExtra::footnote(general = "*p < .05, **p < .01, ***p < .001") %>%
  kable_styling(latex_options = "HOLD_position")
```

### Test 5

```{r log_mod_5_multi, echo=FALSE, results=FALSE, message=FALSE, warning=FALSE}
data_5 <- data %>%
  filter(block_type == "C" & craver_2 == 1) %>%
  mutate(reward_value = factor(reward_value, levels = c("Low", "High"),
                               labels = c("Low", "High")),
         uncertainty = factor(aaron_mood, levels = c("Low", "High"),
                              labels = c("Low", "High")),
         treatment = factor(treatment, levels = c("control", "test"),
                            labels = c("Control", "Test")),
         age = scale(age),
         gender = factor(gender),
         major = factor(major),
         reward_history = scale(exposure_time),
         reaction_time = scale(reaction_time),
         sequence_number = scale(sequence_number))

log_mod_5_reward <- bglmer(choice ~ reward_value + uncertainty * treatment +
                             age + gender + major + reaction_time +
                             sequence_number + previous_choice +
                             reward_history + (1 | id),
                           data = data_5, fixef.prior = t,
                           family = binomial(link = "logit"))

s_5_reward <- glmer_report(log_mod_5_reward)

log_mod_5_trial <- bglmer(choice ~ reward_value + uncertainty * treatment +
                            age + gender + major + reaction_time +
                            sequence_number + previous_choice +
                            previous_trial_outcome + (1 | id),
                          data = data_5, fixef.prior = t,
                          family = binomial(link = "logit"))

s_5_trial <- glmer_report(log_mod_5_trial)
```

```{r log_mod_5_multi_combine, echo=FALSE, results=FALSE, message=FALSE, warning=FALSE}
colnames(s_5_reward) <- c(' ', '(1)')
colnames(s_5_trial) <- c(' ', '(2)')
s_5_r <- c('R^2',
           round(r2_nakagawa(log_mod_5_reward)$R2_conditional, 3),
           round(r2_nakagawa(log_mod_5_trial)$R2_conditional, 3))
s_5_n <- c('N',
           summary(log_mod_5_reward)$devcomp$dims[1],
           summary(log_mod_5_trial)$devcomp$dims[1])

s_5_out <- s_5_reward %>%
  full_join(s_5_trial) %>%
  replace_na(list(' ' = '-',
                  '(1)' = '-',
                  '(2)' = '-')) %>%
  rbind(rep('-', 3)) %>%
  rbind(s_5_r) %>%
  rbind(s_5_n)
```

```{r log_mod_5_out_multi, echo=FALSE}
kable(s_5_out, format = "latex", align = 'c',
      caption = 'Test 5 with previous choice and reward history (1) or previous trial outcome (2). Models use all yellow sessions for cravers.') %>%
  kableExtra::footnote(general = "*p < .05, **p < .01, ***p < .001") %>%
  kable_styling(latex_options = "HOLD_position")
```

## Stepwise model building process

This section shows the process of building the models from the theoretical version (in preregistration) to the model shown in the report. Models are built with incrementally more variables and each model is compared using R^2.

### Test 3 model (includes test 2)

```{r log_mod_3_step_build, echo=FALSE, results=FALSE, message=FALSE, warning=FALSE}
data_2 <- data %>%
  mutate(reward_value = factor(reward_value, levels = c("Low", "High"),
                               labels = c("Low", "High")),
         uncertainty = factor(aaron_mood, levels = c("Low", "High"),
                              labels = c("Low", "High")),
         treatment = factor(treatment, levels = c("control", "test"),
                            labels = c("Control", "Test")),
         color = factor(block_type, levels = c("C", "S"),
                        labels = c("Yellow", "Blue")),
         age = scale(age),
         gender = factor(gender),
         major = factor(major),
         reaction_time = scale(reaction_time),
         sequence_number = scale(sequence_number))

log_mod_3_1 <- bglmer(choice ~ reward_value + uncertainty +
                      treatment * color + age + gender + major +
                        (1 | id),
                    fixef.prior = t, data = data_2,
                    family = binomial(link = "logit"))

log_mod_3_2 <- bglmer(choice ~ reward_value + uncertainty +
                      treatment * color + age + gender + major +
                        reaction_time + (1 | id),
                    fixef.prior = t, data = data_2,
                    family = binomial(link = "logit"))

log_mod_3_3 <- bglmer(choice ~ reward_value + uncertainty +
                      treatment * color + age + gender + major +
                        reaction_time + sequence_number + (1 | id),
                    fixef.prior = t, data = data_2,
                    family = binomial(link = "logit"))

log_mod_3_4 <- bglmer(choice ~ reward_value + uncertainty +
                      treatment * color + age + gender + major +
                        reaction_time + sequence_number +
                        previous_choice + (1 | id),
                    fixef.prior = t, data = data_2,
                    family = binomial(link = "logit"))

s_3_1 <- glmer_report(log_mod_3_1)
s_3_2 <- glmer_report(log_mod_3_2)
s_3_3 <- glmer_report(log_mod_3_3)
s_3_4 <- glmer_report(log_mod_3_4)
```

```{r log_mod_3_step_combine, echo=FALSE, results=FALSE, message=FALSE, warning=FALSE}
colnames(s_3_1) <- c('Variable', '(1)')
colnames(s_3_2) <- c('Variable', '(2)')
colnames(s_3_3) <- c('Variable', '(3)')
colnames(s_3_4) <- c('Variable', '(4)')

s_3_pcr <- c('R^2',
             round(r2_nakagawa(log_mod_3_1)$R2_conditional, 3),
             round(r2_nakagawa(log_mod_3_2)$R2_conditional, 3),
             round(r2_nakagawa(log_mod_3_3)$R2_conditional, 3),
             round(r2_nakagawa(log_mod_3_4)$R2_conditional, 3))
s_3_pcn <- c('N',
             summary(log_mod_3_1)$devcomp$dims[1],
             summary(log_mod_3_2)$devcomp$dims[1],
             summary(log_mod_3_3)$devcomp$dims[1],
             summary(log_mod_3_4)$devcomp$dims[1])

s_3_step <- s_3_1 %>%
  right_join(s_3_2) %>%
  right_join(s_3_3) %>%
  right_join(s_3_4) %>%
  replace_na(list('Variable' = '-',
                  '(1)' = '-',
                  '(2)' = '-',
                  '(3)' = '-',
                  '(4)' = '-')) %>%
  rbind(rep('-', 5)) %>%
  rbind(s_3_pcr) %>%
  rbind(s_3_pcn)
```

```{r log_mod_3_step_out, echo=FALSE}
kable(s_3_step, format = "latex", align = 'c',
      caption = 'Stepwise comparison of models being built from theoretical base (1) to best fitting model (4). Noteworthy is that model (3) is the model from test 2.') %>%
  kableExtra::footnote(general = "*p < .05, **p < .01, **p < .001") %>%
  kable_styling(latex_options = "HOLD_position")
```

## Test 5 model

```{r log_mod_5_step_build, echo=FALSE, results=FALSE, message=FALSE, warning=FALSE}
data_5 <- data %>%
  filter(block_type == "C" & craver_2 == 1) %>%
  mutate(reward_value = factor(reward_value, levels = c("Low", "High"),
                               labels = c("Low", "High")),
         uncertainty = factor(aaron_mood, levels = c("Low", "High"),
                              labels = c("Low", "High")),
         treatment = factor(treatment, levels = c("control", "test"),
                            labels = c("Control", "Test")),
         age = scale(age),
         gender = factor(gender),
         major = factor(major),
         reward_history = scale(exposure_time),
         reaction_time = scale(reaction_time),
         sequence_number = scale(sequence_number))

log_mod_5_1 <- bglmer(choice ~ reward_value + uncertainty + treatment +
                      age + gender + major + (1 | id),
                    data = data_5, fixef.prior = t,
                    family = binomial(link = "logit"))

log_mod_5_2 <- bglmer(choice ~ reward_value + uncertainty + treatment +
                      age + gender + major + reaction_time +
                        (1 | id),
                    data = data_5, fixef.prior = t,
                    family = binomial(link = "logit"))

log_mod_5_3 <- bglmer(choice ~ reward_value + uncertainty + treatment +
                      age + gender + major + reaction_time +
                      sequence_number + (1 | id),
                    data = data_5, fixef.prior = t,
                    family = binomial(link = "logit"))

log_mod_5_4 <- bglmer(choice ~ reward_value + uncertainty + treatment +
                      age + gender + major + reaction_time +
                      sequence_number + reward_history + (1 | id),
                    data = data_5, fixef.prior = t,
                    family = binomial(link = "logit"))

log_mod_5_5 <- bglmer(choice ~ reward_value + uncertainty * treatment +
                      age + gender + major + reaction_time +
                      sequence_number + reward_history + (1 | id),
                    data = data_5, fixef.prior = t,
                    family = binomial(link = "logit"))

s_5_1 <- glmer_report(log_mod_5_1)
s_5_2 <- glmer_report(log_mod_5_2)
s_5_3 <- glmer_report(log_mod_5_3)
s_5_4 <- glmer_report(log_mod_5_4)
s_5_5 <- glmer_report(log_mod_5_5)
```

```{r log_mod_5_step_combine, echo=FALSE, results=FALSE, message=FALSE, warning=FALSE}
colnames(s_5_1) <- c('Variable', '(1)')
colnames(s_5_2) <- c('Variable', '(2)')
colnames(s_5_3) <- c('Variable', '(3)')
colnames(s_5_4) <- c('Variable', '(4)')
colnames(s_5_5) <- c('Variable', '(5)')

s_5_pcr <- c('R^2',
             round(r2_nakagawa(log_mod_5_1)$R2_conditional, 3),
             round(r2_nakagawa(log_mod_5_2)$R2_conditional, 3),
             round(r2_nakagawa(log_mod_5_3)$R2_conditional, 3),
             round(r2_nakagawa(log_mod_5_4)$R2_conditional, 3),
             round(r2_nakagawa(log_mod_5_5)$R2_conditional, 3))
s_5_pcn <- c('N',
             summary(log_mod_5_1)$devcomp$dims[1],
             summary(log_mod_5_2)$devcomp$dims[1],
             summary(log_mod_5_3)$devcomp$dims[1],
             summary(log_mod_5_4)$devcomp$dims[1],
             summary(log_mod_5_5)$devcomp$dims[1])

s_5_step <- s_5_1 %>%
  right_join(s_5_2) %>%
  right_join(s_5_3) %>%
  right_join(s_5_4) %>%
  right_join(s_5_5) %>%
  replace_na(list('Variable' = '-',
                  '(1)' = '-',
                  '(2)' = '-',
                  '(3)' = '-',
                  '(4)' = '-',
                  '(5)' = '-')) %>%
  rbind(rep('-', 6)) %>%
  rbind(s_5_pcr) %>%
  rbind(s_5_pcn)
```

```{r log_mod_5_step_out, echo=FALSE}
kable(s_5_step, format = "latex", align = 'c',
      caption = 'Stepwise comparison of models being built from theoretical base (1) to best fitting model (4).') %>%
  kableExtra::footnote(general = "*p < .05, **p < .01, **p < .001") %>%
  kable_styling(latex_options = "HOLD_position")
```
\newpage

# Reaction time plots

Two plots showing reaction time by treatment and session color and in another plot by decision type and session color. Reaction time is also added as a variable  in the logistic models in the main analysis above.

```{r rt_treat_col_data, echo=FALSE, results=FALSE, message=FALSE, warning=FALSE}
rt_plot <- data %>%
  mutate(treatment = factor(treatment, levels = c("control", "test"),
                            labels = c("Control", "Test")),
         color = factor(block_type, levels = c('C', 'S'),
                        labels = c('Yellow', 'Blue'))) %>%
  group_by(id, treatment, color) %>%
  summarize(RT = mean(reaction_time)) %>%
  ungroup %>%
  group_by(treatment, color) %>%
  summarize(mean = mean(RT),
            se = se(RT)) %>%
  ungroup
```

```{r rt_treat_col_plot, echo=FALSE, results=FALSE, message=FALSE, warning=FALSE, fig.height=5, fig.width=8, fig.align='center', include=TRUE, fig.cap='Average reaction time by session color and treatment.'}
ggplot(rt_plot, aes(x = treatment, y = mean, fill = color)) +
  geom_bar(stat = "identity", width = 0.6,
           position = position_dodge()) +
  geom_errorbar(aes(ymin = mean - se, ymax = mean + se),
                width = 0.1,  position = position_dodge(width = 0.6)) +
  labs(x = 'Treatment', y = 'Mean RT') +
  scale_fill_manual(name = 'Session color',
                    breaks = c('Yellow', 'Blue'),
                    values = c('#ffd700', '#0057b7')) +
  theme_minimal() +
  theme(axis.text = element_text(size = 14),
        axis.title = element_text(size = 16))
```

```{r rt_dec_col_data, echo=FALSE, results=FALSE, message=FALSE, warning=FALSE}
rt_plot_2 <- data %>%
  filter(craver_2 == 1) %>%
  mutate(decision = factor(choice, levels = 0:1,
                           labels = c("Skip", "Bet")),
         color = factor(block_type, levels = c('C', 'S'),
                        labels = c('Yellow', 'Blue'))) %>%
  group_by(id, decision, color) %>%
  summarize(RT = mean(reaction_time)) %>%
  ungroup %>%
  group_by(decision, color) %>%
  summarize(mean = mean(RT),
            se = se(RT)) %>%
  ungroup
```

```{r rt_dec_col_plot, echo=FALSE, results=FALSE, message=FALSE, warning=FALSE, fig.height=5, fig.width=8, fig.align='center', include=TRUE, fig.cap='Average RT by decision (skip/bet) and session color (blue/yellow).'}
ggplot(rt_plot_2, aes(x = decision, y = mean, fill = color)) +
  geom_bar(stat = "identity", width = 0.6,
           position = position_dodge()) +
  geom_errorbar(aes(ymin = mean - se, ymax = mean + se),
                width = 0.1,  position = position_dodge(width = 0.6)) +
  labs(x = 'Decision', y = 'Mean RT') +
  scale_fill_manual(name = 'Session color',
                    breaks = c('Yellow', 'Blue'),
                    values = c('#ffd700', '#0057b7')) +
  theme_minimal() +
  theme(axis.text = element_text(size = 14),
        axis.title = element_text(size = 16))
```

\newpage

# Controlling for losses

We wanted to see if there was a correlation between the losses people accrued and the betting rate in yellow background sessions. This was meant to represent whether people learned from their mistakes. This was done in a few steps.

First, we checked overall betting rates in yellow over the 6 sequences for control and test. This was simply to see betting over the course of the experiment in general, as a baseline.

Next, we checked two different variables, both related to losses. First, we checked betting rate as a function of cumulative losses (in yellow only). Then, we checked betting rate as a function of cumulative losses in yellow but dividing by the cumulative bets in yellow. In this way, a participant who bets a lot in yellow but luckily does not lose a lot, will have a lower “loss score”.

Finally, we plot betting rates in yellow each sequence for participants who with low, medium and high losses in the first sequence. This is meant to show whether high losses in the beginning of the experiment result in different betting patterns throughout.

These four checks are presented in the figures below. We importantly only used cravers for this analysis as others did not bet in yellow more than once.

```{r loss_data_1, echo=FALSE, results=FALSE, message=FALSE, warning=FALSE}
data_plot <- data %>%
  filter(craver_2 == 1 & block_type == 'C') %>%
  group_by(id, treatment, sequence_number) %>%
  summarize(betting_rate = mean(choice)) %>%
  group_by(treatment, sequence_number) %>%
  summarize(mean = mean(betting_rate),
            se = se(betting_rate)) %>%
  ungroup
```

```{r loss_plot_1, echo=FALSE, results=FALSE, message=FALSE, warning=FALSE, fig.height=5, fig.width=8, fig.align='center', include=TRUE, fig.cap='Betting rate in yellow as a function of sequence number in test and control. Error bars are SEM.'}
ggplot(data_plot, aes(x = sequence_number, y = mean, color = treatment)) +
  geom_line() +
  geom_errorbar(aes(ymin = mean - se, ymax = mean + se),
                width = 0.2) +
  labs(x = 'Sequence number', y = 'Mean betting rate (yellow)') +
  theme_minimal() +
  theme(axis.text = element_text(size = 14),
        axis.title = element_text(size = 16))
```

```{r loss_data_2, echo=FALSE, results=FALSE, message=FALSE, warning=FALSE}
data_plot <- data %>%
  mutate(losses = if_else(outcome < 0 & block_type == 'C', outcome, 0)) %>%
  group_by(id) %>%
  mutate(losses = cumsum(-losses)) %>%
  ungroup %>%
  mutate(loss_bins = as.numeric(cut_interval(losses, 5))) %>%
  filter(craver_2 == 1 & block_type == 'C') %>%
  group_by(id, treatment, loss_bins) %>%
  summarize(betting_rate = mean(choice)) %>%
  group_by(treatment, loss_bins) %>%
  summarize(mean = mean(betting_rate),
            se = se(betting_rate)) %>%
  ungroup %>%
  drop_na
```

```{r loss_plot_2, echo=FALSE, results=FALSE, message=FALSE, warning=FALSE, fig.height=5, fig.width=8, fig.align='center', include=TRUE, fig.cap='Betting rate in yellow by cumulative losses (in 5 bins) for test and control. Error bars are SEM.'}
ggplot(data_plot, aes(x = loss_bins, y = mean, color = treatment)) +
  geom_line() +
  geom_errorbar(aes(ymin = mean - se, ymax = mean + se),
                width = 0.2) +
  labs(x = 'Cumulative losses (5 bins) in yellow',
       y = 'Mean betting rate (yellow)') +
  theme_minimal() +
  theme(axis.text = element_text(size = 14),
        axis.title = element_text(size = 16))
```

```{r loss_data_3, echo=FALSE, results=FALSE, message=FALSE, warning=FALSE}
data_plot <- data %>%
  mutate(losses = if_else(outcome < 0 & block_type == 'C', outcome, 0),
         bets_in_y = if_else(choice == 1 & block_type == 'C', 1, 0)) %>%
  group_by(id) %>%
  mutate(losses = cumsum(-losses),
         bets_in_y = cumsum(bets_in_y),
         losses_by_bets = losses/bets_in_y) %>%
  ungroup %>%
  mutate(loss_bins = as.numeric(cut_interval(losses_by_bets, 5))) %>%
  filter(craver_2 == 1 & block_type == 'C') %>%
  group_by(id, treatment, loss_bins) %>%
  summarize(betting_rate = mean(choice)) %>%
  group_by(treatment, loss_bins) %>%
  summarize(mean = mean(betting_rate),
            se = se(betting_rate)) %>%
  ungroup %>%
  drop_na
```

```{r loss_plot_3, echo=FALSE, results=FALSE, message=FALSE, warning=FALSE, fig.height=5, fig.width=8, fig.align='center', include=TRUE, fig.cap='Betting rate by 5 bins representing cumulative losses over cumulative bets. Error bars are SEM.'}
ggplot(data_plot, aes(x = loss_bins, y = mean, color = treatment)) +
  geom_line() +
  geom_errorbar(aes(ymin = mean - se, ymax = mean + se),
                width = 0.2) +
  labs(x = 'Cumulative losses by bets (5 bins)',
       y = 'Mean betting rate (yellow)') +
  theme_minimal() +
  theme(axis.text = element_text(size = 14),
        axis.title = element_text(size = 16))
```

```{r loss_data_4, echo=FALSE, results=FALSE, message=FALSE, warning=FALSE}
data_plot <- data %>%
  mutate(losses = if_else(outcome < 0 &
                            block_type == 'C' &
                            sequence_number %in% c(1),
                          outcome, 0)) %>%
  filter(craver_2 == 1 & block_type == 'C') %>%
  group_by(id, treatment) %>%
  mutate(losses = sum(-losses)) %>%
  ungroup %>%
  mutate(loss_bins = as.numeric(cut_interval(losses, 3))) %>%
  group_by(id, sequence_number, treatment, loss_bins) %>%
  summarize(betting_rate = mean(choice)) %>%
  group_by(sequence_number, treatment, loss_bins) %>%
  summarize(mean = mean(betting_rate),
            se = se(betting_rate)) %>%
  ungroup %>%
  drop_na
```

```{r loss_plot_4, echo=FALSE, results=FALSE, message=FALSE, warning=FALSE, fig.height=5, fig.width=8, fig.align='center', include=TRUE, fig.cap='Betting rate in yellow by sequence number. The plot is separated in 3 increasing panes with low (1), medium (2), and high (3) losses in the first sequence.'}
ggplot(data_plot, aes(x = sequence_number, y = mean, color = treatment)) +
  geom_line() +
  geom_errorbar(aes(ymin = mean - se, ymax = mean + se),
                width = 0.2) +
  labs(x = 'Sequence number',
       y = 'Mean betting rate (yellow)') +
  theme_minimal() +
  theme(axis.text = element_text(size = 14),
        axis.title = element_text(size = 16)) +
  facet_wrap('loss_bins')
```

Next, we include a new variable in test 5. We introduce cumulative losses to the model and remove the reward history variable (due to colinearity).

To see if the effect differs by treatment, we also include the interaction between treatment and the loss variable.

The interaction is negative, meaning that the effect of accrued losses on betting is lower in the test treatment compared to the control treatment. In other words, participants overall bet more if they have lost more, but this is more pronounced in the control treatment.


```{r log_loss_5, echo=FALSE, results=FALSE, message=FALSE, warning=FALSE}
data_5 <- data %>%
  mutate(losses = if_else(outcome < 0, outcome, 0)) %>%
  group_by(id) %>%
  mutate(losses = cumsum(-losses)) %>%
  ungroup %>%
  filter(block_type == "C" & craver_2 == 1) %>%
  mutate(reward_value = factor(reward_value, levels = c("Low", "High"),
                               labels = c("Low", "High")),
         uncertainty = factor(aaron_mood, levels = c("Low", "High"),
                              labels = c("Low", "High")),
         treatment = factor(treatment, levels = c("control", "test"),
                            labels = c("Control", "Test")),
         age = scale(age)[,1],
         gender = factor(gender),
         major = factor(major),
         losses = scale(losses)[,1],
         reaction_time = scale(reaction_time)[,1],
         sequence_number = scale(sequence_number)[,1])

log_mod_5_loss <- bglmer(choice ~ reward_value + uncertainty +
                           treatment + age + gender + major +
                           losses + reaction_time +
                           sequence_number + (1 | id),
                    data = data_5, fixef.prior = t,
                    family = binomial(link = "logit"))

s_5_loss <- glmer_report(log_mod_5_loss)
s_5_pcr <- c('R^2', round(r2_nakagawa(log_mod_5_loss)$R2_conditional, 3))
s_5_pcn <- c('N', summary(log_mod_5_loss)$devcomp$dims[1])

colnames(s_5_loss) <- c('Variable', '(1)')
s_5_loss <- s_5_loss %>%
  rbind(s_5_pcr) %>%
  rbind(s_5_pcn)
```

## Test 5 - first and second in sequence only

```{r log_loss_5_out, echo=FALSE}
kable(s_5_loss, format = "latex", align = 'c',
      caption = 'Logistic model from test 5 with cumulative losses as well as the interaction between losses and treatment included.') %>%
  kableExtra::footnote(general = "*p < .05, **p < .01, ***p < .001") %>%
  kable_styling(latex_options = "HOLD_position")
```
