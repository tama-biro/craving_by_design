---
title: "Halfway Report 23-01-04"
author: "Samuel Thelaus"
date: "2023-01-04"

output:
  pdf_document: default
  html_document:
    df_print: paged
---

\newpage

# Initial data checks

One participant had fewer than 630 total trials (total of 455 trials remained in file) and was missing columns for the final 3 MCQ questions (4-6). However, this participant was still included in analysis.

Four participants were excluded for not passing the requirement for MCQ questions, post-game quiz or questions after betting in yellow (I want to remember the odds guess questions are). Three excluded participants were in control treatment and one in the test treatment.

All excluded participants were cravers, as defined by betting at least twice in yellow.

\newpage

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r import, echo=FALSE, results=FALSE, message=FALSE, warning=FALSE}
# Import libraries
suppressMessages({
  library(tidyverse)
  library(moments)
  library(EnvStats)
  library(blme)
  library(BayesianFirstAid)
  library(knitr)
  library(tinytex)
})

setwd('/Users/sam/Documents/GitHub/craving_by_design/main_analysis')

# SE function
se <- function (x) {
  se = sd(x, na.rm = TRUE)/sqrt(length(x))
  return(se)
}

# Shapiro to text
shapiro_to_text <- function (x) {
  if (x < .05) {
    return('non-normality')
  } else {
    return('normality')
  }
}

# T-test report
t_test_report <- function (t_test) {
  df <- t_test$parameter
  t <- round(t_test$statistic, 3)
  p <- round(t_test$p.value, 3)
  if (t_test$p.value < .001) {
    p <- 'p < .001'
  } else {
    p <- paste('p =', p)
  }
  out <- paste0('t(', df, ') = ', t, ', ', p)
  return(out)
}

# Wilcox report
wilcox_report <- function (wilcox) {
  v <- round(wilcox$statistic, 3)
  p <- round(wilcox$p.value, 3)
  if (wilcox$p.value < .001) {
    p <- 'p < .001'
  } else {
    p <- paste('p =', p)
  }
  out <- paste('V =', v, p)
  return(out)
}

# glmer report
glmer_report <- function (mod) {
  s <- summary(mod)$coefficients
  s <- as.data.frame(s)
  colnames(s) <- c('Beta', 'SE', 'z-value', 'p')
  s <- round(s, 3)
  s <- s %>%
    mutate(p =
             ifelse(p < .001, '< .001 ***',
                     ifelse(p < .01, paste(p, '**'),
                             ifelse(p < .05, paste(p, '*'), p))))
  colnames(s) <- c('Beta', 'SE', 'z-value', 'p-value')
  return(s)
}

aov_chi_report <- function (mod) {
  chi <- round(mod$Chisq[2], 3)
  df <- mod$Df[2]
  p <- round(mod$`Pr(>Chisq)`[2], 3)
  if (p < .001) {
    p <- 'p < .001'
  } else {
    p <- paste('p =', p)
  }
  out <- paste0('Chi2(', df, ') = ', chi, ', ', p)
  return(out)
}
```

```{r feature eng, echo=FALSE, results=FALSE, message=FALSE, warning=FALSE}
filepath <- '../data/data_full.csv'
data <- read.csv(filepath)

source("./feature_engineering.R", local = knit_global())

# Save engineered data
write.csv(data, file = '../data/data_reduced.csv', row.names = FALSE)
```

```{r load data, echo=FALSE, results=FALSE, message=FALSE, warning=FALSE}
set.seed(41)

filepath <- '../data/data_reduced.csv'
data <- read.csv(filepath)

n <- length(unique(data$id))
```

# Main analysis

This section goes through the tests specified in the pre-registration report and specifies observed effect sizes in the sample so far.

There was a total of `r n` participants after excluding participants.

```{r t-test 1, echo=FALSE, results=FALSE, message=FALSE, warning=FALSE}
#### Test 1 ####

# Paired one-tailed t-test, participant level
# Betting rate in low/high reward
data_1 <- data %>%
  mutate(reward_value = factor(reward_value, levels = c("Low", "High"),
                               labels = c("Low", "High"))) %>%
  filter(block_type == "C") %>%
  group_by(id, reward_value) %>%
  summarize(betting_rate = mean(choice)) %>%
  ungroup


# Check skew and normality assumption
skew_1_bf <- round(skewness(sqrt(data_1$betting_rate)), 3)
shap_1_bf <- shapiro.test(data_1$betting_rate)
shap_1_bf <- shapiro_to_text(shap_1_bf$p.value)


# Box-Cox transform
out <- boxcox(data_1$betting_rate + 1, lambda = seq(-25, 25, by = 0.25))
bc_1_lambda <- out$lambda[which.max(out$objective)]

data_1$betting_rate_bc <- boxcoxTransform(data_1$betting_rate + 1,
                                          lambda = bc_1_lambda)

skew_1_af <- round(skewness(sqrt(data_1$betting_rate_bc)), 3)
shap_1_af <- shapiro.test(data_1$betting_rate_bc)
shap_1_af <- shapiro_to_text(shap_1_af$p.value)


# Run test
t_test_1 <- t.test(betting_rate_bc ~ reward_value, data = data_1,
                   alternative = 'less', paired = TRUE)
t_test_1 <- t_test_report(t_test_1)

# Non-parametric
wilcox_1 <- wilcox.test(betting_rate ~ reward_value, data = data_1,
                        alternative = 'less', paired = TRUE)
wilcox_1 <- wilcox_report(wilcox_1)
```

## Test 1

Paired one-tailed t-test checking if betting rate is equal or lower in high reward value trials. Participant-level test (N = `r n`).

Data was skewed at `r skew_1_bf` (ideal values within [-1, 1]) and a Shapiro-Wilks test showed `r shap_1_bf`. Data were Box-Cox transformed with lambda = `r bc_1_lambda`. This reduced skew to `r skew_1_af` (acceptable value), but SW test still showed `r shap_1_af`.

Paired t-test using Box-Cox transformed data showed higher betting rate in high reward sessions (`r t_test_1`). Non-parametric paired Wilcoxon test using non-transformed data showed qualitatively same results (`r wilcox_1`).

## Test 2

Logistic mixed-effects model predicting betting in all trials. Using penalized log-likelihood to correct for imbalanced groups.

```{r log_mod_2, echo=FALSE, results=FALSE, message=FALSE, warning=FALSE}
data_2 <- data %>%
  mutate(reward_value = factor(reward_value, levels = c("Low", "High"),
                               labels = c("Low", "High")),
         uncertainty = factor(aaron_mood, levels = c("Low", "High"),
                              labels = c("Low", "High")),
         treatment = factor(treatment, levels = c("control", "test"),
                            labels = c("Control", "Test")),
         color = factor(block_type, levels = c("C", "S"),
                        labels = c("Yellow", "Blue")),
         age = scale(age),
         gender = factor(gender),
         major = factor(major))

log_mod_2 <- bglmer(choice ~ reward_value + uncertainty + treatment * color +
                      age + gender + major + (1 | id),
                    fixef.prior = t, data = data_2,
                    family = binomial(link = "logit"))

s_2 <- glmer_report(log_mod_2)
```

```{r log_mod_2_out, echo=FALSE}
kable(s_2, format = "latex", align = 'c')
```
## Test 3

Mixed-effects model predicting betting in all trials. Same as test 2, but with exposure time added in order to see if betting increases with reward exposure.

```{r log_mod_3, echo=FALSE, results=FALSE, message=FALSE, warning=FALSE}
data_2 <- data_2 %>%
  mutate(exposure_time = scale(exposure_time))

log_mod_3 <- bglmer(choice ~ reward_value + uncertainty + treatment * color +
                      age + gender + major + exposure_time + (1 | id),
                    data = data_2, fixef.prior = t,
                    family = binomial(link = "logit"))

s_3 <- glmer_report(log_mod_3)

aov_3 <- anova(log_mod_2, log_mod_3)
aov_3 <- aov_chi_report(aov_3)
aic_3 <- round(AIC(log_mod_2, log_mod_3), 0)
bic_3 <- round(BIC(log_mod_2, log_mod_3), 0)
```

```{r log_mod_3_out, echo=FALSE}
kable(s_3, format = "latex", align = 'c')
```

In addition to the regression table, the exposure variable can be tested by comparing the model from test 2 with this one to see if the addition of reward exposure statistically significantly improved fit.

Comparing the models, the difference between them is not statistically significant (`r aov_3`). The models had similar AIC (test2 = `r aic_3$AIC[1]`, test3 = `r aic_3$AIC[2]`) and the model from test 2 had lower BIC than the model from test 3 (`r bic_3$BIC[1]` compared to `r bic_3$BIC[2]`). This means the model in test 2 is preferred due to having fewer variables while explaining the data equally well.

## Test 4

## Test 5

Logistic mixed-effects model predicting betting among cravers in the yellow background sessions.

```{r log_mod_5, echo=FALSE, results=FALSE, message=FALSE, warning=FALSE}
data_5 <- data %>%
  filter(block_type == "C" & craver_2 == 1) %>%
  mutate(reward_value = factor(reward_value, levels = c("Low", "High"),
                               labels = c("Low", "High")),
         uncertainty = factor(aaron_mood, levels = c("Low", "High"),
                              labels = c("Low", "High")),
         treatment = factor(treatment, levels = c("control", "test"),
                            labels = c("Control", "Test")),
         age = scale(age),
         gender = factor(gender),
         major = factor(major))

log_mod_5 <- bglmer(choice ~ reward_value + uncertainty + treatment +
                      previous_choice + scale(age) + factor(gender) +
                      factor(major) + (1 | id),
                    data = data_5, fixef.prior = t,
                    family = binomial(link = "logit"))

s_5 <- glmer_report(log_mod_5)
```

```{r log_mod_5_out, echo=FALSE}
kable(s_5, format = "latex", align = 'c')
```

```{r bayes_6, echo=FALSE, results=FALSE, message=FALSE, warning=FALSE}
#### Test 6 ####

# Bayesian t-test, participant level
# H1: Betting rate in yellow, test is > 0
# H0: Betting rate in yellow, test is 0
data_6 <- data %>%
  filter(block_type == "C" & treatment == "test") %>%
  group_by(id) %>%
  summarize(betting_rate = mean(choice)) %>%
  ungroup

n_6 <- nrow(data_6)

# Check skew and normality assumption
skew_6_bf <- round(skewness(sqrt(data_6$betting_rate)), 3)
shap_6_bf <- shapiro.test(data_6$betting_rate)
shap_6_bf <- shapiro_to_text(shap_6_bf$p.value)


# Box-Cox transform
out <- boxcox(data_6$betting_rate + 1, lambda = seq(-25, 25, by = 0.25))
bc_6_lambda <- out$lambda[which.max(out$objective)]

data_6$betting_rate_bc <- boxcoxTransform(data_6$betting_rate + 1,
                                          lambda = bc_6_lambda)

skew_6_af <- round(skewness(sqrt(data_6$betting_rate_bc)), 3)
shap_6_af <- shapiro.test(data_6$betting_rate_bc)
shap_6_af <- shapiro_to_text(shap_6_af$p.value)

# Run test
bayes_t6 <- bayes.t.test(x = data_6$betting_rate_bc, mu = 0)
prob_6 <- round(bayes_t6$stats[1,7]*100, 1)
bf_6 <- round(bayes_t6$stats[1,7]/(1-bayes_t6$stats[1,7]), 3)
```

## Test 6

Bayesian t-test checking if betting rate in yellow session in the test treatment is different from 0. Participant-level test (N = `r n_6`).

Data was positively skewed at `r skew_6_bf` (ideal values within [-1, 1]) and a Shapiro-Wilks test showed `r shap_6_bf`. Data were Box-Cox transformed with lambda = `r bc_6_lambda`. This reduced skew to `r skew_6_af` (acceptable value), but SW test still showed `r shap_6_af`.

Bayesian t-test on Box-Cox transformed betting rate showed a Bayes Factor of `r bf_6`, with a probability of `r prob_6`% that the mean was more than 0.

```{r t-test 7, echo=FALSE, results=FALSE, message=FALSE, warning=FALSE}
#### Test 7 ####

# Paired one-tailed t-test, participant level
# Betting rate in low/high reward
data_7 <- data %>%
  mutate(uncertainty = factor(aaron_mood, levels = c("Low", "High"),
                               labels = c("Low", "High"))) %>%
  filter(block_type == "C") %>%
  group_by(id, uncertainty) %>%
  summarize(betting_rate = mean(choice)) %>%
  ungroup


# Check skew and normality assumption
skew_7_bf <- round(skewness(sqrt(data_7$betting_rate)), 3)
shap_7_bf <- shapiro.test(data_7$betting_rate)
shap_7_bf <- shapiro_to_text(shap_7_bf$p.value)


# Box-Cox transform
out <- boxcox(data_7$betting_rate + 1, lambda = seq(-25, 25, by = 0.25))
bc_7_lambda <- out$lambda[which.max(out$objective)]

data_7$betting_rate_bc <- boxcoxTransform(data_7$betting_rate + 1,
                                          lambda = bc_7_lambda)

skew_7_af <- round(skewness(sqrt(data_7$betting_rate_bc)), 3)
shap_7_af <- shapiro.test(data_7$betting_rate_bc)
shap_7_af <- shapiro_to_text(shap_7_af$p.value)


# Run test
t_test_7 <- t.test(betting_rate_bc ~ uncertainty, data = data_7,
                   alternative = 'less', paired = TRUE)
t_test_7 <- t_test_report(t_test_7)

# Non-parametric
wilcox_7 <- wilcox.test(betting_rate ~ uncertainty, data = data_7,
                        alternative = 'less', paired = TRUE)
wilcox_7 <- wilcox_report(wilcox_7)
```

## Test 7

Paired one-tailed t-test checking if betting rate is equal or lower in high uncertainty trials. Participant-level test.

Data was positively skewed at `r skew_7_af` (ideal values within [-1, 1]) and a Shapiro-Wilks test showed `r shap_7_bf`. Data were Box-Cox transformed with lambda = `r bc_7_lambda`. This reduced skew to `r skew_7_af` (acceptable value), but SW test still showed `r shap_7_af`.

Paired t-test using Box-Cox transformed data showed higher betting rate in high uncertainty sessions (`r t_test_7`). Non-parametric paired Wilcoxon test on non-transformed data showed qualitatively same results (`r wilcox_7`).

\newpage

# Plots

```{r rew_unc_data, echo=FALSE, results=FALSE, message=FALSE, warning=FALSE}
data_plot_r <- data %>%
  filter(craver_2 == 1) %>%
  group_by(block_type, reward_value, id) %>%
  summarize(betting_rate = mean(choice)) %>%
  ungroup %>%
  group_by(block_type, reward_value) %>%
  summarize(se = se(betting_rate),
            betting_rate = mean(betting_rate)) %>%
  ungroup %>%
  mutate(x_ax = reward_value) %>%
  select(-reward_value)

data_plot_u <- data %>%
  filter(craver_2 == 1) %>%
  group_by(block_type, aaron_mood, id) %>%
  summarize(betting_rate = mean(choice)) %>%
  ungroup %>%
  group_by(block_type, aaron_mood) %>%
  summarize(se = se(betting_rate),
            betting_rate = mean(betting_rate)) %>%
  ungroup %>%
  mutate(x_ax = aaron_mood) %>%
  select(-aaron_mood)

data_plot <- data_plot_r %>%
  rbind(data_plot_u) %>%
  mutate(type = rep(c('Reward', 'Uncertainty'),
                    times = c(nrow(data_plot_r),
                              nrow(data_plot_u))),
         type = factor(type,
                       levels = c('Reward', 'Uncertainty'),
                       labels = c("(A) Reward", "(B) Uncertainty")),
         x_ax = factor(x_ax, levels = c("Low", "High"), labels = c("Low", "High")))
```

```{r rew_unc_plot, echo=FALSE, results=FALSE, message=FALSE, warning=FALSE, fig.height=5, fig.width=8, fig.align='center', include=TRUE, fig.cap='(A) Average betting rate in low and high reward sessions. (B) Average betting rate in low and high uncertainty sessions.'}
ggplot(data_plot, aes(x = x_ax, y = betting_rate, fill = block_type)) +
  geom_bar(stat='identity', position = position_dodge(.9)) +
  geom_errorbar(aes(ymin = betting_rate - se, ymax = betting_rate + se),
                position = position_dodge(.9), width = .2) +
  scale_x_discrete(name = '',
                   breaks = c('Low', 'High'),
                   labels = c('Low', 'High')) +
  scale_y_continuous(name = 'Betting rate') +
  scale_fill_manual(name = 'Session color',
                    breaks = c('C', 'S'),
                    labels = c('Yellow', 'Blue'),
                    values = c('#ffd700', '#0057b7')) +
  theme_minimal() +
  theme(axis.title = element_text(size = 14),
        axis.text = element_text(size = 12),
        legend.title = element_text(size = 14),
        legend.text = element_text(size = 12),
        strip.text = element_text(size = 14)) +
  facet_wrap("type", nrow = 1)
```

```{r treat_col_data, echo=FALSE, results=FALSE, message=FALSE, warning=FALSE}
data_plot1 <- data %>%
  filter(craver_2 == 1) %>%
  group_by(treatment, block_type, id) %>%
  summarize(betting_rate = mean(choice)) %>%
  ungroup %>%
  group_by(treatment, block_type) %>%
  summarize(se = se(betting_rate),
            betting_rate = mean(betting_rate)) %>%
  ungroup

data_plot2 <- data %>%
  group_by(treatment, block_type, id) %>%
  summarize(betting_rate = mean(choice)) %>%
  ungroup %>%
  group_by(treatment, block_type) %>%
  summarize(se = se(betting_rate),
            betting_rate = mean(betting_rate)) %>%
  ungroup

data_plot <- data_plot1 %>%
  rbind(data_plot2) %>%
  mutate(participant_group = rep(c('Cravers', 'Pooled'), each = 4),
         participant_group = factor(participant_group,
                                    levels = c("Pooled", "Cravers"),
                                    labels = c("(A) Pooled", "(B) Cravers")))
```

```{r treat_col_plot, echo=FALSE, results=FALSE, message=FALSE, warning=FALSE, fig.height=5, fig.width=8, fig.align='center', include=TRUE, fig.cap='Average betting rate by session color and treatment, for all participants pooled and cravers individually.'}
ggplot(data_plot, aes(x = treatment,
                      y = betting_rate,
                      fill = block_type)) +
  geom_bar(stat='identity', position = position_dodge(.9)) +
  geom_errorbar(aes(ymin = betting_rate - se, ymax = betting_rate + se),
                position = position_dodge(.9), width = .2) +
  scale_x_discrete(name = 'Treatment',
                   breaks = c('control', 'test'),
                   labels = c('Control', 'Test')) +
  scale_y_continuous(name = 'Betting rate') +
  scale_fill_manual(name = 'Session color',
                    breaks = c('C', 'S'),
                    labels = c('Yellow', 'Blue'),
                    values = c('#ffd700', '#0057b7')) +
  theme_minimal() +
  facet_wrap('participant_group', nrow = 1) +
  theme(axis.text = element_text(size = 12),
        axis.title = element_text(size = 14),
        strip.text = element_text(size = 14),
        legend.title = element_text(size = 14),
        legend.text = element_text(size = 12))
```

```{r dist_yellow_data, echo=FALSE, results=FALSE, message=FALSE, warning=FALSE}
data_dists1 <- data %>%
  filter(block_type == 'C') %>%
  group_by(id, treatment) %>%
  summarize(betting_rate = mean(choice, na.rm=TRUE)) %>%
  ungroup

data_dists2 <- data %>%
  filter(block_type == 'C' & craver_2 == 1) %>%
  group_by(id, treatment) %>%
  summarize(betting_rate = mean(choice, na.rm=TRUE)) %>%
  ungroup

data_dists <- data_dists1 %>%
  rbind(data_dists2) %>%
  mutate(participant_group = rep(c('Pooled', 'Cravers'),
                                 times = c(nrow(data_dists1),
                                           nrow(data_dists2))),
         participant_group = factor(participant_group,
                                    levels = c("Pooled", "Cravers"),
                                    labels = c("(A) Pooled", "(B) Cravers")))
```

```{r dist_yellow_plot, echo=FALSE, results=FALSE, message=FALSE, warning=FALSE, fig.height=5, fig.width=8, fig.align='center', include=TRUE, fig.cap='Distribution of betting rates by participant for all participants (A) and for the craver group (B) in yellow background sessions.'}
ggplot(data_dists, aes(x = treatment, y = betting_rate)) +
  geom_boxplot() +
  scale_x_discrete(breaks = c('control', 'test'),
                   labels = c('Control', 'Test'),
                   name = 'Treatment') +
  scale_y_continuous(breaks = seq(0, 1, 0.05),
                     name = 'Betting rate') +
  theme_minimal() +
  facet_wrap('participant_group', nrow = 1) +
  theme(axis.text = element_text(size = 12),
        axis.title = element_text(size = 14),
        strip.text = element_text(size = 14))
```

```{r dist_blue_data, echo=FALSE, results=FALSE, message=FALSE, warning=FALSE}
data_dists1 <- data %>%
  filter(block_type == 'S') %>%
  group_by(id, treatment) %>%
  summarize(betting_rate = mean(choice, na.rm=TRUE)) %>%
  ungroup

data_dists2 <- data %>%
  filter(block_type == 'S' & craver_2 == 1) %>%
  group_by(id, treatment) %>%
  summarize(betting_rate = mean(choice, na.rm=TRUE)) %>%
  ungroup

data_dists <- data_dists1 %>%
  rbind(data_dists2) %>%
  mutate(participant_group = rep(c('Pooled', 'Cravers'),
                                 times = c(nrow(data_dists1),
                                           nrow(data_dists2))),
         participant_group = factor(participant_group,
                                    levels = c("Pooled", "Cravers"),
                                    labels = c("(A) Pooled", "(B) Cravers")))
```

```{r dist_blue_plot, echo=FALSE, results=FALSE, message=FALSE, warning=FALSE, fig.height=5, fig.width=8, fig.align='center', include=TRUE, fig.cap='Distribution of betting rates by participant for all participants (A) and for the craver group (B) in blue background sessions.'}
ggplot(data_dists, aes(x = treatment, y = betting_rate)) +
  geom_boxplot() +
  scale_x_discrete(breaks = c('control', 'test'),
                   labels = c('Control', 'Test'),
                   name = 'Treatment') +
  scale_y_continuous(breaks = seq(0, 1, 0.05),
                     name = 'Betting rate') +
  theme_minimal() +
  facet_wrap('participant_group', nrow = 1) +
  theme(axis.text = element_text(size = 12),
        axis.title = element_text(size = 14),
        strip.text = element_text(size = 14))
```

```{r exp_data, echo=FALSE, results=FALSE, message=FALSE, warning=FALSE}
data_plot_y <- data %>%
  filter(block_type == 'C') %>%
  mutate(exp_bins = as.numeric(cut_interval(exposure_time, 3)),
         exp_num = cut_interval(exposure_time, 3)) %>%
  group_by(exp_bins, craver_2, id) %>%
  summarize(betting_rate = mean(choice)) %>%
  ungroup %>%
  group_by(exp_bins) %>%
  summarize(se = se(betting_rate),
            betting_rate = mean(betting_rate, na.rm = TRUE)) %>%
  ungroup

data_plot_b <- data %>%
  filter(block_type == 'S') %>%
  mutate(exp_bins = as.numeric(cut_interval(exposure_time, 3)),
         exp_num = cut_interval(exposure_time, 3)) %>%
  group_by(exp_bins, craver_2, id) %>%
  summarize(betting_rate = mean(choice)) %>%
  ungroup %>%
  filter(betting_rate > .6) %>%
  group_by(exp_bins) %>%
  summarize(se = se(betting_rate),
            betting_rate = mean(betting_rate, na.rm = TRUE)) %>%
  ungroup

data_plot <- data_plot_b %>%
  rbind(data_plot_y) %>%
  mutate(session_color = rep(c('Blue', 'Yellow'),
                             times = c(nrow(data_plot_b),
                                       nrow(data_plot_y))),
         session_color = factor(session_color,
                                levels = c('Blue', 'Yellow'),
                                labels = c("(A) Blue", "(B) Yellow")))
```

```{r exp_plot, echo=FALSE, results=FALSE, message=FALSE, warning=FALSE, fig.height=5, fig.width=8, fig.align='center', include=TRUE, fig.cap='Betting rate in the blue background sessions (A) and yellow background sessions (B) as a function of prior reward exposure (as defined in computational model) for all participants and sessions, with reward exposure split into 3 equally sized bins.'}
ggplot(data_plot, aes(x = exp_bins,
                      y = betting_rate,
                      col = session_color)) +
  geom_line() +
  geom_errorbar(aes(ymin = betting_rate - se,
                    ymax = betting_rate + se),
                width = 0.2) +
  labs(x = 'Previous reward exposure', y = 'Betting rate') +
  scale_x_continuous(breaks = 1:3) +
  scale_color_manual(name = 'Session color',
                     breaks = c('(A) Blue', '(B) Yellow'),
                     values = c('#0057b7', '#ffd700')) +
  theme_minimal() +
  theme(axis.title = element_text(size = 14),
        axis.text = element_text(size = 12),
        strip.text = element_text(size = 14),
        legend.position = 'none') +
  facet_wrap('session_color', scales = 'free_y')
```

\newpage

# Extra treatment/uncertainty checks

```{r ex_unc_data, echo=FALSE, results=FALSE, message=FALSE, warning=FALSE}
d1_plot <- data %>%
  filter(block_type == "C") %>%
  mutate(treatment = factor(treatment, levels = c("control", "test"),
                            labels = c("Control", "Test"))) %>%
  group_by(id, treatment) %>%
  summarize(betting_rate = mean(choice)) %>%
  ungroup %>%
  group_by(treatment) %>%
  summarize(mean = mean(betting_rate),
            se = se(betting_rate)) %>%
  ungroup
```

```{r ex_unc_plot, echo=FALSE, results=FALSE, message=FALSE, warning=FALSE, fig.height=5, fig.width=8, fig.align='center', include=TRUE, fig.cap='Average betting rate in yellow sessions for the control and test treatment.'}
ggplot(d1_plot, aes(x = treatment, y = mean)) +
  geom_bar(stat = "identity", fill = '#ffd700', width = 0.6) +
  geom_errorbar(aes(ymin = mean - se, ymax = mean + se),
                width = 0.1) +
  labs(x = 'Treatment', y = 'Mean betting rate') +
  theme_minimal() +
  theme(axis.title = element_text(size = 14),
        axis.text = element_text(size = 12),
        legend.position = 'none')
```

```{r ex_treat_data, echo=FALSE, results=FALSE, message=FALSE, warning=FALSE}
d2_plot <- data %>%
  filter(block_type == "C") %>%
  mutate(treatment = factor(treatment, levels = c("control", "test"),
                            labels = c("Control", "Test")),
         uncertainty = factor(aaron_mood, levels = c("Low", "High"),
                              labels = c("Low", "High"))) %>%
  group_by(id, treatment, uncertainty) %>%
  summarize(betting_rate = mean(choice)) %>%
  ungroup %>%
  group_by(treatment, uncertainty) %>%
  summarize(mean = mean(betting_rate),
            se = se(betting_rate)) %>%
  ungroup
```

```{r ex_treat_plot, echo=FALSE, results=FALSE, message=FALSE, warning=FALSE, fig.height=5, fig.width=8, fig.align='center', include=TRUE, fig.cap='Average betting rates in control/test treatment for low/high uncertainty. There seems to be an effect of uncertainty in the control treatment but not in test.'}
ggplot(d2_plot, aes(x = treatment, y = mean, fill = uncertainty)) +
  geom_bar(stat = "identity", width = 0.6,
           position = position_dodge(preserve = "single")) +
  geom_errorbar(aes(ymin = mean - se, ymax = mean + se),
                width = 0.1,
                position = position_dodge(width = 0.6, preserve = "single")) +
  labs(x = 'Treatment', y = 'Mean betting rate') +
  theme_minimal() +
  theme(axis.title = element_text(size = 14),
        axis.text = element_text(size = 12))
```

\newpage

# Reaction time stuff

The effect of reaction time was checked using 3 tests. First, the logistic models from test 2 and test 5 were built but with the added value for reaction time. Then a plot was made showing reaction time by treatment and session color.

```{r rt_log_2, echo=FALSE, results=FALSE, message=FALSE, warning=FALSE}
data_rt_2 <- data %>%
  mutate(reward_value = factor(reward_value, levels = c("Low", "High"),
                               labels = c("Low", "High")),
         uncertainty = factor(aaron_mood, levels = c("Low", "High"),
                              labels = c("Low", "High")),
         treatment = factor(treatment, levels = c("control", "test"),
                            labels = c("Control", "Test")),
         color = factor(block_type, levels = c("C", "S"),
                        labels = c("Yellow", "Blue")),
         age = scale(age),
         gender = factor(gender),
         major = factor(major),
         reaction_time = scale(reaction_time))

log_mod_rt_2 <- bglmer(choice ~ reward_value + uncertainty +
                       treatment * color + age + gender +
                       major + reaction_time + (1 | id),
                     fixef.prior = t, data = data_rt_2,
                    family = binomial(link = "logit"))

s_rt_2 <- glmer_report(log_mod_rt_2)
```

## Test 2 copy

Logistic mixed-effects model predicting betting in all trials. Using penalized log-likelihood to correct for imbalanced groups.

```{r rt_log_2_out, echo=FALSE}
kable(s_rt_2, format = "latex", align = 'c')
```

```{r rt_log_5, echo=FALSE, results=FALSE, message=FALSE, warning=FALSE}
data_rt_5 <- data %>%
  filter(block_type == "C" & craver_2 == 1) %>%
  mutate(reward_value = factor(reward_value, levels = c("Low", "High"),
                               labels = c("Low", "High")),
         uncertainty = factor(aaron_mood, levels = c("Low", "High"),
                              labels = c("Low", "High")),
         treatment = factor(treatment, levels = c("control", "test"),
                            labels = c("Control", "Test")),
         age = scale(age),
         gender = factor(gender),
         major = factor(major),
         reaction_time = scale(reaction_time))

log_mod_rt_5 <- bglmer(choice ~ reward_value + uncertainty + treatment +
                      previous_choice + age + gender +
                        major + reaction_time + (1 | id),
                    data = data_rt_5, fixef.prior = t,
                    family = binomial(link = "logit"))

s_rt_5 <- glmer_report(log_mod_rt_5)
```

## Test 5 copy

Logistic mixed-effects model predicting betting among cravers in the yellow background sessions.

```{r rt_log_5_out, echo=FALSE}
kable(s_rt_5, format = "latex", align = 'c')
```

```{r rt_treat_col_data, echo=FALSE, results=FALSE, message=FALSE, warning=FALSE}
rt_plot <- data %>%
  mutate(treatment = factor(treatment, levels = c("control", "test"),
                            labels = c("Control", "Test")),
         color = factor(block_type, levels = c('C', 'S'),
                        labels = c('Yellow', 'Blue'))) %>%
  group_by(id, treatment, color) %>%
  summarize(RT = mean(reaction_time)) %>%
  ungroup %>%
  group_by(treatment, color) %>%
  summarize(mean = mean(RT),
            se = se(RT)) %>%
  ungroup
```

```{r rt_treat_col_plot, echo=FALSE, results=FALSE, message=FALSE, warning=FALSE, fig.height=5, fig.width=8, fig.align='center', include=TRUE, fig.cap='Average reaction time by session color and treatment.'}
ggplot(rt_plot, aes(x = treatment, y = mean, fill = color)) +
  geom_bar(stat = "identity", width = 0.6,
           position = position_dodge()) +
  geom_errorbar(aes(ymin = mean - se, ymax = mean + se),
                width = 0.1,  position = position_dodge(width = 0.6)) +
  labs(x = 'Treatment', y = 'Mean RT') +
  scale_fill_manual(name = 'Session color',
                    breaks = c('Yellow', 'Blue'),
                    values = c('#ffd700', '#0057b7')) +
  theme_minimal() +
  theme(axis.text = element_text(size = 14),
        axis.title = element_text(size = 16))
```

```{r rt_dec_col_data, echo=FALSE, results=FALSE, message=FALSE, warning=FALSE}
rt_plot_2 <- data %>%
  filter(craver_2 == 1) %>%
  mutate(decision = factor(choice, levels = 0:1,
                           labels = c("Skip", "Bet")),
         color = factor(block_type, levels = c('C', 'S'),
                        labels = c('Yellow', 'Blue'))) %>%
  group_by(id, decision, color) %>%
  summarize(RT = mean(reaction_time)) %>%
  ungroup %>%
  group_by(decision, color) %>%
  summarize(mean = mean(RT),
            se = se(RT)) %>%
  ungroup
```

```{r rt_dec_col_plot, echo=FALSE, results=FALSE, message=FALSE, warning=FALSE, fig.height=5, fig.width=8, fig.align='center', include=TRUE, fig.cap='Average RT by decision (skip/bet) and session color (blue/yellow).'}
ggplot(rt_plot_2, aes(x = decision, y = mean, fill = color)) +
  geom_bar(stat = "identity", width = 0.6,
           position = position_dodge()) +
  geom_errorbar(aes(ymin = mean - se, ymax = mean + se),
                width = 0.1,  position = position_dodge(width = 0.6)) +
  labs(x = 'Decision', y = 'Mean RT') +
  scale_fill_manual(name = 'Session color',
                    breaks = c('Yellow', 'Blue'),
                    values = c('#ffd700', '#0057b7')) +
  theme_minimal() +
  theme(axis.text = element_text(size = 14),
        axis.title = element_text(size = 16))
```

\newpage

```{r fe_new, echo=FALSE, results=FALSE, message=FALSE, warning=FALSE}
filepath <- '../data/november_subset/data_full.csv'
data <- read.csv(filepath)

source("./feature_engineering.R", local = knit_global())

# Save engineered data
write.csv(data, file = '../data/november_subset/data_reduced.csv', row.names = FALSE)
```

```{r load_new, echo=FALSE, results=FALSE, message=FALSE, warning=FALSE}
filepath <- '../data/november_subset/data_reduced.csv'
data <- read.csv(filepath)

n_new <- length(unique(data$id))
```

# Treatment effect in new sample only

We also test the treatment effect in yellow in the new sample when we exclude all pilot participants. This subsample has `r n_new` participants.

The treatment effect is examined by running test 5 and producing figure 2 for the new sample alone.

```{r new_log_5, echo=FALSE, results=FALSE, message=FALSE, warning=FALSE}
data_5 <- data %>%
  filter(block_type == "C" & craver_2 == 1) %>%
  mutate(reward_value = factor(reward_value, levels = c("Low", "High"),
                               labels = c("Low", "High")),
         uncertainty = factor(aaron_mood, levels = c("Low", "High"),
                              labels = c("Low", "High")),
         treatment = factor(treatment, levels = c("control", "test"),
                            labels = c("Control", "Test")),
         age = scale(age),
         gender = factor(gender),
         major = factor(major),
         reaction_time = scale(reaction_time))

log_mod_new_5 <- bglmer(choice ~ reward_value + uncertainty + treatment +
                      previous_choice + age + gender +
                      major + (1 | id),
                    data = data_5, fixef.prior = t,
                    family = binomial(link = "logit"))

s_new_5 <- glmer_report(log_mod_new_5)
```

## Test 5 copy

```{r new_log_5_out, echo=FALSE}
kable(s_new_5, format = "latex", align = 'c')
```

```{r new_treat_col_data, echo=FALSE, results=FALSE, message=FALSE, warning=FALSE}
data_plot1 <- data %>%
  filter(craver_2 == 1) %>%
  group_by(treatment, block_type, id) %>%
  summarize(betting_rate = mean(choice)) %>%
  ungroup %>%
  group_by(treatment, block_type) %>%
  summarize(se = se(betting_rate),
            betting_rate = mean(betting_rate)) %>%
  ungroup

data_plot2 <- data %>%
  group_by(treatment, block_type, id) %>%
  summarize(betting_rate = mean(choice)) %>%
  ungroup %>%
  group_by(treatment, block_type) %>%
  summarize(se = se(betting_rate),
            betting_rate = mean(betting_rate)) %>%
  ungroup

data_plot <- data_plot1 %>%
  rbind(data_plot2) %>%
  mutate(participant_group = rep(c('Cravers', 'Pooled'), each = 4),
         participant_group = factor(participant_group,
                                    levels = c("Pooled", "Cravers"),
                                    labels = c("(A) Pooled", "(B) Cravers")))
```

```{r new_treat_col_plot, echo=FALSE, results=FALSE, message=FALSE, warning=FALSE, fig.height=5, fig.width=8, fig.align='center', include=TRUE, fig.cap='Bar chart showing betting rate in control and test treatment in yellow and blue background sessions. The panes represent data for all participants (A) and only cravers (B).'}
ggplot(data_plot, aes(x = treatment,
                      y = betting_rate,
                      fill = block_type)) +
  geom_bar(stat='identity', position = position_dodge(.9)) +
  geom_errorbar(aes(ymin = betting_rate - se, ymax = betting_rate + se),
                position = position_dodge(.9), width = .2) +
  scale_x_discrete(name = 'Treatment',
                   breaks = c('control', 'test'),
                   labels = c('Control', 'Test')) +
  scale_y_continuous(name = 'Betting rate') +
  scale_fill_manual(name = 'Session color',
                    breaks = c('C', 'S'),
                    labels = c('Yellow', 'Blue'),
                    values = c('#ffd700', '#0057b7')) +
  theme_minimal() +
  facet_wrap('participant_group', nrow = 1) +
  theme(axis.text = element_text(size = 12),
        axis.title = element_text(size = 14),
        strip.text = element_text(size = 14),
        legend.title = element_text(size = 14),
        legend.text = element_text(size = 12))
```

\newpage

# Reward exposure with reward value

This section checks results for the reward exposure variable when including the reward value in the calculation rather than a binary indicator (0, 1). This is done by reproducing test 3 and figure 5 using the new design of the reward exposure variable.

```{r fe_rew, echo=FALSE, results=FALSE, message=FALSE, warning=FALSE}
filepath <- '../data/data_full.csv'
data <- read.csv(filepath)

source("./feature_engineering_rew.R", local = knit_global())

# Save engineered data
write.csv(data, file = '../data/data_reduced_rew.csv', row.names = FALSE)
```

```{r load_rew, echo=FALSE, results=FALSE, message=FALSE, warning=FALSE}
filepath <- '../data/data_reduced_rew.csv'
data <- read.csv(filepath)
```

```{r rew_log_5, echo=FALSE, results=FALSE, message=FALSE, warning=FALSE}
data_5 <- data %>%
  filter(block_type == "C" & craver_2 == 1) %>%
  mutate(reward_value = factor(reward_value, levels = c("Low", "High"),
                               labels = c("Low", "High")),
         uncertainty = factor(aaron_mood, levels = c("Low", "High"),
                              labels = c("Low", "High")),
         treatment = factor(treatment, levels = c("control", "test"),
                            labels = c("Control", "Test")),
         age = scale(age),
         gender = factor(gender),
         major = factor(major),
         exposure_time = scale(exposure_time))

log_mod_new_5 <- bglmer(choice ~ reward_value + uncertainty + treatment +
                      previous_choice + age + gender +
                      major + exposure_time + (1 | id),
                    data = data_5, fixef.prior = t,
                    family = binomial(link = "logit"))

s_new_5 <- glmer_report(log_mod_new_5)
```

## Test 5 copy

```{r rew_log_5_out, echo=FALSE}
kable(s_new_5, format = "latex", align = 'c')
```

## Test 3

Mixed-effects model predicting betting in all trials. Same as test 2, but with exposure time added in order to see if betting increases with reward exposure.

```{r log_mod_3_rew, echo=FALSE, results=FALSE, message=FALSE, warning=FALSE}
data_2 <- data %>%
  mutate(reward_value = factor(reward_value, levels = c("Low", "High"),
                               labels = c("Low", "High")),
         uncertainty = factor(aaron_mood, levels = c("Low", "High"),
                              labels = c("Low", "High")),
         treatment = factor(treatment, levels = c("control", "test"),
                            labels = c("Control", "Test")),
         color = factor(block_type, levels = c("C", "S"),
                        labels = c("Yellow", "Blue")),
         age = scale(age),
         gender = factor(gender),
         major = factor(major),
         exposure_time = scale(exposure_time))

log_mod_3 <- bglmer(choice ~ reward_value + uncertainty +
                      treatment * color +
                      age + gender + major + exposure_time + (1 | id),
                    data = data_2, fixef.prior = t,
                    family = binomial(link = "logit"))

s_3 <- glmer_report(log_mod_3)
```

```{r log_mod_3_rew_out, echo=FALSE}
kable(s_3, format = "latex", align = 'c')
```

```{r rew_data, echo=FALSE, results=FALSE, message=FALSE, warning=FALSE}
data_plot_y <- data %>%
  filter(block_type == 'C') %>%
  mutate(exp_bins = as.numeric(cut_interval(exposure_time, 3)),
         exp_num = cut_interval(exposure_time, 3)) %>%
  group_by(exp_bins, craver_2, id) %>%
  summarize(betting_rate = mean(choice)) %>%
  ungroup %>%
  group_by(exp_bins) %>%
  summarize(se = se(betting_rate),
            betting_rate = mean(betting_rate, na.rm = TRUE)) %>%
  ungroup

data_plot_b <- data %>%
  filter(block_type == 'S') %>%
  mutate(exp_bins = as.numeric(cut_interval(exposure_time, 3)),
         exp_num = cut_interval(exposure_time, 3)) %>%
  group_by(exp_bins, craver_2, id) %>%
  summarize(betting_rate = mean(choice)) %>%
  ungroup %>%
  filter(betting_rate > .6) %>%
  group_by(exp_bins) %>%
  summarize(se = se(betting_rate),
            betting_rate = mean(betting_rate, na.rm = TRUE)) %>%
  ungroup

data_plot <- data_plot_b %>%
  rbind(data_plot_y) %>%
  mutate(session_color = rep(c('Blue', 'Yellow'),
                             times = c(nrow(data_plot_b),
                                       nrow(data_plot_y))),
         session_color = factor(session_color,
                                levels = c('Blue', 'Yellow'),
                                labels = c("(A) Blue", "(B) Yellow")))
```

```{r rew_plot, echo=FALSE, results=FALSE, message=FALSE, warning=FALSE, fig.height=5, fig.width=8, fig.align='center', include=TRUE, fig.cap='Betting rate in the blue background sessions (A) and yellow background sessions (B) as a function of prior reward exposure (as defined in computational model) for all participants and sessions, with reward exposure split into 3 equally sized bins.'}
ggplot(data_plot, aes(x = exp_bins,
                      y = betting_rate,
                      col = session_color)) +
  geom_line() +
  geom_errorbar(aes(ymin = betting_rate - se,
                    ymax = betting_rate + se),
                width = 0.2) +
  labs(x = 'Previous reward exposure', y = 'Betting rate') +
  scale_x_continuous(breaks = 1:3) +
  scale_color_manual(name = 'Session color',
                     breaks = c('(A) Blue', '(B) Yellow'),
                     values = c('#0057b7', '#ffd700')) +
  theme_minimal() +
  theme(axis.title = element_text(size = 14),
        axis.text = element_text(size = 12),
        strip.text = element_text(size = 14),
        legend.position = 'none') +
  facet_wrap('session_color', scales = 'free_y')
```

```{r load data again, echo=FALSE, results=FALSE, message=FALSE, warning=FALSE}
filepath <- '../data/data_reduced.csv'
data <- read.csv(filepath)
```

\newpage

# Boredom in control in yellow

We wanted to check whether participants might bet in yellow in the control treatment out of boredom (skipping many times in a row could be boring as nothing happens). To do this, we fashioned a few extra variables and checked their importance in explaining differences in betting rates.

First, we produced two additional plots to check whether betting was different over the course of blocks in yellow in control. One variable compared the first block in a sequence of yellow to the second and third, and one variable compared the first and second block to the third in a sequence. The results are shown in the bar charts below.

```{r boredom_data_1, echo=FALSE, results=FALSE, message=FALSE, warning=FALSE}
# Make indicator of where blue interspersed block is
data <- data %>%
  group_by(sequence_number, id) %>%
  mutate(blue_interspersed =
           if_else(block_type == 'S' & block_number == 2, 2,
                   if_else(block_type == 'S' & block_number == 3, 3, 
                           if_else(block_type == 'S' & block_number == 4, 4, 1)))) %>%
  ungroup %>%
  mutate(blue_interspersed = replace(blue_interspersed, blue_interspersed == 1, NA)) %>%
  group_by(sequence_number, id) %>%
  mutate(blue_interspersed = mean(blue_interspersed, na.rm = TRUE)) %>%
  ungroup %>%
  mutate(blue_interspersed = if_else(treatment == 'test', 1, blue_interspersed))

# Set order of yellow blocks (first/second == 1 in sequence)
data$yellow_order_ctrl <- 0
for(id in unique(data$id[data$treatment == 'control'])) {
  for(seq in unique(data$sequence_number[data$id == id])) {
    indicator <- data$blue_interspersed[
      data$sequence_number == seq & data$id == id
        ][1]
    
    if(indicator == 2) {
      data$yellow_order_ctrl[
        data$sequence_number == seq &
          data$id == id &
          data$block_type == 'C' &
          data$block_number %in% c(1, 3, 4)
      ] <- 1
      data$yellow_order_ctrl[
        data$sequence_number == seq &
          data$id == id &
          data$block_type == 'C' &
          data$block_number == 5
      ] <- 2
    } else if(indicator == 3) {
      data$yellow_order_ctrl[
        data$sequence_number == seq &
          data$id == id &
          data$block_type == 'C' &
          data$block_number %in% c(1, 2, 4, 5)
      ] <- 1
    } else if(indicator == 4) {
      data$yellow_order_ctrl[
        data$sequence_number == seq &
          data$id == id &
          data$block_type == 'C' &
          data$block_number %in% c(1, 2, 5)
      ] <- 1
      data$yellow_order_ctrl[
        data$sequence_number == seq &
          data$id == id &
          data$block_type == 'C' &
          data$block_number == 3
      ] <- 2
    }

  }
}

data_plot <- data %>%
  filter(block_type == 'C' & craver_2 == 1) %>%
  group_by(id, treatment, yellow_order_ctrl) %>%
  summarize(betting_rate = mean(choice)) %>%
  group_by(treatment, yellow_order_ctrl) %>%
  summarize(mean = mean(betting_rate),
            se = se(betting_rate)) %>%
  ungroup %>%
  mutate(group = c("Control\n(first/second)", "Control\n(third)", "Test"))
```

```{r boredom_plot_1, echo=FALSE, results=FALSE, message=FALSE, warning=FALSE, fig.height=5, fig.width=8, fig.align='center', include=TRUE, fig.cap='Betting rate in the first/second or third block in a sequence of yellow blocks in the control treatment. Betting rate for the test treatment is shown individually.'}
ggplot(data_plot, aes(x = group, y = mean)) +
  geom_bar(stat = 'identity', fill = '#ffd700') +
  geom_errorbar(aes(ymin = mean - se, ymax = mean + se), width = 0.2) +
  theme_minimal() +
  labs(x = 'Group', y = 'Mean betting rate') +
  theme(axis.title = element_text(size = 16),
        axis.text = element_text(size = 14))
```

```{r boredom_data_2, echo=FALSE, results=FALSE, message=FALSE, warning=FALSE}
data$yellow_order_ctrl <- 0
for(id in unique(data$id[data$treatment == 'control'])) {
  for(seq in unique(data$sequence_number[data$id == id])) {
    indicator <- data$blue_interspersed[
      data$sequence_number == seq & data$id == id
    ][1]
    
    if(indicator == 2) {
      data$yellow_order_ctrl[
        data$sequence_number == seq &
          data$id == id &
          data$block_type == 'C' &
          data$block_number %in% c(1, 3)
      ] <- 1
      data$yellow_order_ctrl[
        data$sequence_number == seq &
          data$id == id &
          data$block_type == 'C' &
          data$block_number %in% c(4, 5)
      ] <- 2
    } else if(indicator == 3) {
      data$yellow_order_ctrl[
        data$sequence_number == seq &
          data$id == id &
          data$block_type == 'C' &
          data$block_number %in% c(1, 4)
      ] <- 1
      data$yellow_order_ctrl[
        data$sequence_number == seq &
          data$id == id &
          data$block_type == 'C' &
          data$block_number %in% c(2, 5)
      ] <- 2
    } else if(indicator == 4) {
      data$yellow_order_ctrl[
        data$sequence_number == seq &
          data$id == id &
          data$block_type == 'C' &
          data$block_number %in% c(1, 5)
      ] <- 1
      data$yellow_order_ctrl[
        data$sequence_number == seq &
          data$id == id &
          data$block_type == 'C' &
          data$block_number %in% c(2, 3)
      ] <- 2
    }
    
  }
}

data_plot <- data %>%
  filter(block_type == 'C' & craver_2 == 1) %>%
  group_by(id, treatment, yellow_order_ctrl) %>%
  summarize(betting_rate = mean(choice)) %>%
  group_by(treatment, yellow_order_ctrl) %>%
  summarize(mean = mean(betting_rate),
            se = se(betting_rate)) %>%
  ungroup %>%
  mutate(group = c("Control\n(first)", "Control\n(second/third)", "Test"))
```

```{r boredom_plot_2, echo=FALSE, results=FALSE, message=FALSE, warning=FALSE, fig.height=5, fig.width=8, fig.align='center', include=TRUE, fig.cap='Betting rate in the first or second/third block in a sequence of yellow blocks in the control treatment. Betting rate for the test treatment is shown individually.'}
ggplot(data_plot, aes(x = group, y = mean)) +
  geom_bar(stat = 'identity', fill = '#ffd700') +
  geom_errorbar(aes(ymin = mean - se, ymax = mean + se), width = 0.2) +
  theme_minimal() +
  labs(x = 'Group', y = 'Mean betting rate') +
  theme(axis.title = element_text(size = 16),
        axis.text = element_text(size = 14))
```

Next, a special version of test 5 in the main analysis above was run. We created two version of the same model. One restricting blocks in the control treatment to the first block in a sequence and one restricting blocks in control to the first/second blocks. This was done to avoid overcomplicating model architecture with additional variables and interactions. It also creates models with the assumption that all data is “free from boredom” rather than controlling for it. Regression tables are presented below.

```{r log_1_5, echo=FALSE, results=FALSE, message=FALSE, warning=FALSE}
# Set order of yellow blocks (first included)
data$yellow_order_ctrl <- 0
for(id in unique(data$id[data$treatment == 'control'])) {
  for(seq in unique(data$sequence_number[data$id == id])) {
    indicator <- data$blue_interspersed[
      data$sequence_number == seq & data$id == id
    ][1]
    
    if(indicator == 2) {
      data$yellow_order_ctrl[
        data$sequence_number == seq &
          data$id == id &
          data$block_type == 'C' &
          data$block_number %in% c(4, 5)
      ] <- 1
    } else if(indicator == 3) {
      data$yellow_order_ctrl[
        data$sequence_number == seq &
          data$id == id &
          data$block_type == 'C' &
          data$block_number %in% c(2, 5)
      ] <- 1
    } else if(indicator == 4) {
      data$yellow_order_ctrl[
        data$sequence_number == seq &
          data$id == id &
          data$block_type == 'C' &
          data$block_number %in% c(2, 3)
      ] <- 1
    }
    
  }
}

data_5 <- data %>%
  filter(block_type == "C" & craver_2 == 1 & yellow_order_ctrl == 0) %>%
  mutate(reward_value = factor(reward_value, levels = c("Low", "High"),
                               labels = c("Low", "High")),
         uncertainty = factor(aaron_mood, levels = c("Low", "High"),
                              labels = c("Low", "High")),
         treatment = factor(treatment, levels = c("control", "test"),
                            labels = c("Control", "Test")),
         age = scale(age),
         gender = factor(gender),
         major = factor(major))

log_mod_1_5 <- bglmer(choice ~ reward_value + uncertainty + treatment +
                      previous_choice + age + gender +
                      major + (1 | id),
                    data = data_5, fixef.prior = t,
                    family = binomial(link = "logit"))

s_1_5 <- glmer_report(log_mod_1_5)
```

## Test 5 - first in sequence only

```{r log_1_5_out, echo=FALSE}
kable(s_1_5, format = "latex", align = 'c')
```

```{r log_12_5, echo=FALSE, results=FALSE, message=FALSE, warning=FALSE}
# Set order of yellow blocks (first/second included)
data$yellow_order_ctrl <- 0
for(id in unique(data$id[data$treatment == 'control'])) {
  for(seq in unique(data$sequence_number[data$id == id])) {
    indicator <- data$blue_interspersed[
      data$sequence_number == seq & data$id == id
    ][1]

    if(indicator == 2) {
      data$yellow_order_ctrl[
        data$sequence_number == seq &
          data$id == id &
          data$block_type == 'C' &
          data$block_number == 5
      ] <- 1
    } else if(indicator == 4) {
      data$yellow_order_ctrl[
        data$sequence_number == seq &
          data$id == id &
          data$block_type == 'C' &
          data$block_number == 3
      ] <- 1
    }
    
  }
}

data_5 <- data %>%
  filter(block_type == "C" & craver_2 == 1 & yellow_order_ctrl == 0) %>%
  mutate(reward_value = factor(reward_value, levels = c("Low", "High"),
                               labels = c("Low", "High")),
         uncertainty = factor(aaron_mood, levels = c("Low", "High"),
                              labels = c("Low", "High")),
         treatment = factor(treatment, levels = c("control", "test"),
                            labels = c("Control", "Test")),
         age = scale(age),
         gender = factor(gender),
         major = factor(major))

log_mod_12_5 <- bglmer(choice ~ reward_value + uncertainty + treatment +
                      previous_choice + age + gender +
                      major + (1 | id),
                    data = data_5, fixef.prior = t,
                    family = binomial(link = "logit"))

s_12_5 <- glmer_report(log_mod_12_5)
```

## Test 5 - first and second in sequence only

```{r log_12_5_out, echo=FALSE}
kable(s_12_5, format = "latex", align = 'c')
```

\newpage

# Controlling for losses

We wanted to see if there was a correlation between the losses people accrued and the betting rate in yellow background sessions. This was meant to represent whether people learned from their mistakes. This was done in a few steps.

First, we checked overall betting rates in yellow over the 6 sequences for control and test. This was simply to see betting over the course of the experiment in general, as a baseline.

Next, we checked two different variables, both related to losses. First, we checked betting rate as a function of cumulative losses (in yellow only). Then, we checked betting rate as a function of cumulative losses in yellow but dividing by the cumulative bets in yellow. In this way, a participant who bets a lot in yellow but luckily does not lose a lot, will have a lower “loss score”.

Finally, we plot betting rates in yellow each sequence for participants who with low, medium and high losses in the first sequence. This is meant to show whether high losses in the beginning of the experiment result in different betting patterns throughout.

These four checks are presented in the figures below. We importantly only used cravers for this analysis as others did not bet in yellow more than once.

```{r loss_data_1, echo=FALSE, results=FALSE, message=FALSE, warning=FALSE}
data_plot <- data %>%
  filter(craver_2 == 1 & block_type == 'C') %>%
  group_by(id, treatment, sequence_number) %>%
  summarize(betting_rate = mean(choice)) %>%
  group_by(treatment, sequence_number) %>%
  summarize(mean = mean(betting_rate),
            se = se(betting_rate)) %>%
  ungroup
```

```{r loss_plot_1, echo=FALSE, results=FALSE, message=FALSE, warning=FALSE, fig.height=5, fig.width=8, fig.align='center', include=TRUE, fig.cap='Betting rate in yellow as a function of sequence number in test and control. Error bars are SEM.'}
ggplot(data_plot, aes(x = sequence_number, y = mean, color = treatment)) +
  geom_line() +
  geom_errorbar(aes(ymin = mean - se, ymax = mean + se),
                width = 0.2) +
  labs(x = 'Sequence number', y = 'Mean betting rate (yellow)') +
  theme_minimal() +
  theme(axis.text = element_text(size = 14),
        axis.title = element_text(size = 16))
```

```{r loss_data_2, echo=FALSE, results=FALSE, message=FALSE, warning=FALSE}
data_plot <- data %>%
  mutate(losses = if_else(outcome < 0 & block_type == 'C', outcome, 0)) %>%
  group_by(id) %>%
  mutate(losses = cumsum(-losses)) %>%
  ungroup %>%
  mutate(loss_bins = as.numeric(cut_interval(losses, 5))) %>%
  filter(craver_2 == 1 & block_type == 'C') %>%
  group_by(id, treatment, loss_bins) %>%
  summarize(betting_rate = mean(choice)) %>%
  group_by(treatment, loss_bins) %>%
  summarize(mean = mean(betting_rate),
            se = se(betting_rate)) %>%
  ungroup %>%
  drop_na
```

```{r loss_plot_2, echo=FALSE, results=FALSE, message=FALSE, warning=FALSE, fig.height=5, fig.width=8, fig.align='center', include=TRUE, fig.cap='Betting rate in yellow by cumulative losses (in 5 bins) for test and control. Error bars are SEM.'}
ggplot(data_plot, aes(x = loss_bins, y = mean, color = treatment)) +
  geom_line() +
  geom_errorbar(aes(ymin = mean - se, ymax = mean + se),
                width = 0.2) +
  labs(x = 'Cumulative losses (5 bins) in yellow',
       y = 'Mean betting rate (yellow)') +
  theme_minimal() +
  theme(axis.text = element_text(size = 14),
        axis.title = element_text(size = 16))
```

```{r loss_data_3, echo=FALSE, results=FALSE, message=FALSE, warning=FALSE}
data_plot <- data %>%
  mutate(losses = if_else(outcome < 0 & block_type == 'C', outcome, 0),
         bets_in_y = if_else(choice == 1 & block_type == 'C', 1, 0)) %>%
  group_by(id) %>%
  mutate(losses = cumsum(-losses),
         bets_in_y = cumsum(bets_in_y),
         losses_by_bets = losses/bets_in_y) %>%
  ungroup %>%
  mutate(loss_bins = as.numeric(cut_interval(losses_by_bets, 5))) %>%
  filter(craver_2 == 1 & block_type == 'C') %>%
  group_by(id, treatment, loss_bins) %>%
  summarize(betting_rate = mean(choice)) %>%
  group_by(treatment, loss_bins) %>%
  summarize(mean = mean(betting_rate),
            se = se(betting_rate)) %>%
  ungroup %>%
  drop_na
```

```{r loss_plot_3, echo=FALSE, results=FALSE, message=FALSE, warning=FALSE, fig.height=5, fig.width=8, fig.align='center', include=TRUE, fig.cap='Betting rate by 5 bins representing cumulative losses over cumulative bets. Error bars are SEM.'}
ggplot(data_plot, aes(x = loss_bins, y = mean, color = treatment)) +
  geom_line() +
  geom_errorbar(aes(ymin = mean - se, ymax = mean + se),
                width = 0.2) +
  labs(x = 'Cumulative losses by bets (5 bins)',
       y = 'Mean betting rate (yellow)') +
  theme_minimal() +
  theme(axis.text = element_text(size = 14),
        axis.title = element_text(size = 16))
```

```{r loss_data_4, echo=FALSE, results=FALSE, message=FALSE, warning=FALSE}
data_plot <- data %>%
  mutate(losses = if_else(outcome < 0 &
                            block_type == 'C' &
                            sequence_number %in% c(1),
                          outcome, 0)) %>%
  filter(craver_2 == 1 & block_type == 'C') %>%
  group_by(id, treatment) %>%
  mutate(losses = sum(-losses)) %>%
  ungroup %>%
  mutate(loss_bins = as.numeric(cut_interval(losses, 3))) %>%
  group_by(id, sequence_number, treatment, loss_bins) %>%
  summarize(betting_rate = mean(choice)) %>%
  group_by(sequence_number, treatment, loss_bins) %>%
  summarize(mean = mean(betting_rate),
            se = se(betting_rate)) %>%
  ungroup %>%
  drop_na
```

```{r loss_plot_4, echo=FALSE, results=FALSE, message=FALSE, warning=FALSE, fig.height=5, fig.width=8, fig.align='center', include=TRUE, fig.cap='Betting rate in yellow by sequence number. The plot is separated in 3 increasing panes with low (1), medium (2), and high (3) losses in the first sequence.'}
ggplot(data_plot, aes(x = sequence_number, y = mean, color = treatment)) +
  geom_line() +
  geom_errorbar(aes(ymin = mean - se, ymax = mean + se),
                width = 0.2) +
  labs(x = 'Sequence number',
       y = 'Mean betting rate (yellow)') +
  theme_minimal() +
  theme(axis.text = element_text(size = 14),
        axis.title = element_text(size = 16)) +
  facet_wrap('loss_bins')
```

Next, we include the variable from figure 16 in test 5 (without separating into bins), meaning we control for the losses participants accrue given how much they bet. A negative coefficient on the variable would mean that people who face unusually high losses given how much they bet, have lower betting rates in yellow throughout the experiment.

To see if the effect differs by treatment, we also include the interaction between treatment and the loss variable.

The lack of significance for these two variables seem to indicate that the losses accrued given betting rates do not impact betting in yellow.


```{r log_loss_5, echo=FALSE, results=FALSE, message=FALSE, warning=FALSE}
data_5 <- data %>%
  mutate(losses = if_else(outcome < 0 & block_type == 'C', outcome, 0),
         bets_in_y = if_else(choice == 1 & block_type == 'C', 1, 0)) %>%
  group_by(id) %>%
  mutate(losses = cumsum(-losses),
         bets_in_y = cumsum(bets_in_y),
         losses_by_bets = losses/bets_in_y) %>%
  ungroup %>%
  filter(block_type == "C" & craver_2 == 1) %>%
  mutate(reward_value = factor(reward_value, levels = c("Low", "High"),
                               labels = c("Low", "High")),
         uncertainty = factor(aaron_mood, levels = c("Low", "High"),
                              labels = c("Low", "High")),
         treatment = factor(treatment, levels = c("control", "test"),
                            labels = c("Control", "Test")),
         age = scale(age),
         gender = factor(gender),
         major = factor(major),
         losses_by_bets = scale(losses_by_bets))

log_mod_loss_5 <- bglmer(choice ~ reward_value + uncertainty + treatment +
                      previous_choice + age + gender +
                      major + losses_by_bets * treatment +
                      (1 | id),
                    data = data_5, fixef.prior = t,
                    family = binomial(link = "logit"))

s_loss_5 <- glmer_report(log_mod_loss_5)
```

## Test 5 - first and second in sequence only

```{r log_loss_5_out, echo=FALSE}
kable(s_loss_5, format = "latex", align = 'c')
```

\newpage

# First 4 blocks of blue in test/control

We checked the difference in betting rates in the first 4 blue blocks in the test and control treatment separately. This is shown in a bar chart below as well as a t-test checking the difference in betting rates between test and control. Only the first “actual” blue blocks are used. Interspersed blocks and clocks before the experiment (to avoid boredom) were not used.

```{r blue_data, echo=FALSE, results=FALSE, message=FALSE, warning=FALSE}
# Betting in first 4 blue blocks test/ctrl
data_plot <- data %>%
  mutate(first_blue = if_else(treatment == 'control' &
                                block_type == 'S' &
                                block_number %in% 6:9, 1,
                              if_else(treatment == 'test' &
                                        block_type == 'S' &
                                        block_number %in% 1:4, 1, 0))) %>%
  filter(first_blue == 1) %>%
  group_by(id, treatment) %>%
  summarize(betting_rate = mean(choice)) %>%
  group_by(treatment) %>%
  summarize(mean = mean(betting_rate),
            se = se(betting_rate)) %>%
  ungroup
```

```{r blue_plot, echo=FALSE, results=FALSE, message=FALSE, warning=FALSE, fig.height=5, fig.width=8, fig.align='center', include=TRUE, fig.cap='Average betting rates in the first 4 blue blocks for the control and test treatment. Error bars show SEM.'}
ggplot(data_plot, aes(x = treatment, y = mean)) +
  geom_bar(stat = 'identity', fill = '#0057b7', width = 0.7) +
  geom_errorbar(aes(ymin = mean - se, ymax = mean + se),
                width = 0.2) +
  labs(x = 'Treatment', y = 'Mean betting rate') +
  theme_minimal() +
  theme(axis.text = element_text(size = 14),
        axis.title = element_text(size = 16))
```

```{r blue t-test, echo=FALSE, results=FALSE, message=FALSE, warning=FALSE}
data_ttest <- data %>%
  mutate(first_blue = if_else(treatment == 'control' &
                                block_type == 'S' &
                                block_number %in% 6:9, 1,
                              if_else(treatment == 'test' &
                                        block_type == 'S' &
                                        block_number %in% 1:4, 1, 0))) %>%
  filter(first_blue == 1) %>%
  group_by(id, treatment) %>%
  summarize(betting_rate = mean(choice)) %>%
  ungroup


blue_t_test <- t.test(betting_rate ~ treatment, data = data_ttest,
                      var.equal=TRUE)

blue_t_test <- t_test_report(blue_t_test)
```

A two-sample t-test comparing the difference in betting rates in the first 4 blue blocks found no difference in mean between the two treatments (Welch two-sample t-test, `r blue_t_test`).
